(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[661],{2569:function(e,t){var n,a;void 0!==(n="function"==typeof(a=function(){"use strict";var e=Object.prototype.hasOwnProperty,t=Object.prototype.toString,n="boolean"==typeof RegExp().sticky;function a(e){return e&&"[object RegExp]"===t.call(e)}function r(e){return e&&"object"==typeof e&&!a(e)&&!Array.isArray(e)}function i(e){return e.length?"(?:"+e.map(function(e){return"(?:"+e+")"}).join("|")+")":"(?!)"}function o(e){if("string"==typeof e)return"(?:"+e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")";if(a(e)){if(e.ignoreCase)throw Error("RegExp /i flag not allowed");if(e.global)throw Error("RegExp /g flag is implied");if(e.sticky)throw Error("RegExp /y flag is implied");if(e.multiline)throw Error("RegExp /m flag is implied");return e.source}throw Error("Not a pattern: "+e)}function s(e,t){return e.length>t?e:Array(t-e.length+1).join(" ")+e}function l(t,n){if(r(n)||(n={match:n}),n.include)throw Error("Matching rules cannot also include states");var i={defaultType:t,lineBreaks:!!n.error||!!n.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var o in n)e.call(n,o)&&(i[o]=n[o]);if("string"==typeof i.type&&t!==i.type)throw Error("Type transform cannot be a string (type '"+i.type+"' for token '"+t+"')");var s=i.match;return i.match=Array.isArray(s)?s:s?[s]:[],i.match.sort(function(e,t){return a(e)&&a(t)?0:a(t)?-1:a(e)?1:t.length-e.length}),i}function u(e){return Array.isArray(e)?function(e){for(var t=[],n=0;n<e.length;n++){var a=e[n];if(a.include){for(var r=[].concat(a.include),i=0;i<r.length;i++)t.push({include:r[i]});continue}if(!a.type)throw Error("Rule has no type: "+JSON.stringify(a));t.push(l(a.type,a))}return t}(e):function(e){for(var t=Object.getOwnPropertyNames(e),n=[],a=0;a<t.length;a++){var i=t[a],o=[].concat(e[i]);if("include"===i){for(var s=0;s<o.length;s++)n.push({include:o[s]});continue}var u=[];o.forEach(function(e){r(e)?(u.length&&n.push(l(i,u)),n.push(l(i,e)),u=[]):u.push(e)}),u.length&&n.push(l(i,u))}return n}(e)}var c=l("error",{lineBreaks:!0,shouldThrow:!0});function d(e,t){for(var r=null,s=Object.create(null),l=!0,u=null,d=[],p=[],m=0;m<e.length;m++)e[m].fallback&&(l=!1);for(var m=0;m<e.length;m++){var h=e[m];if(h.include)throw Error("Inheritance is not allowed in stateless lexers");if(h.error||h.fallback){if(r){if(!h.fallback==!r.fallback)throw Error("Multiple "+(h.fallback?"fallback":"error")+" rules not allowed (for token '"+h.defaultType+"')");throw Error("fallback and error are mutually exclusive (for token '"+h.defaultType+"')")}r=h}var f=h.match.slice();if(l)for(;f.length&&"string"==typeof f[0]&&1===f[0].length;)s[f.shift().charCodeAt(0)]=h;if(h.pop||h.push||h.next){if(!t)throw Error("State-switching options are not allowed in stateless lexers (for token '"+h.defaultType+"')");if(h.fallback)throw Error("State-switching options are not allowed on fallback tokens (for token '"+h.defaultType+"')")}if(0!==f.length){l=!1,d.push(h);for(var b=0;b<f.length;b++){var v=f[b];if(a(v)){if(null===u)u=v.unicode;else if(u!==v.unicode&&!1===h.fallback)throw Error("If one rule is /u then all must be")}}var x=i(f.map(o)),g=RegExp(x);if(g.test(""))throw Error("RegExp matches empty string: "+g);if(RegExp("|"+x).exec("").length-1>0)throw Error("RegExp has capture groups: "+g+"\nUse (?: … ) instead");if(!h.lineBreaks&&g.test("\n"))throw Error("Rule should declare lineBreaks: "+g);p.push("("+x+")")}}var y=r&&r.fallback,N=n&&!y?"ym":"gm";return!0===u&&(N+="u"),{regexp:RegExp(i(p)+(n||y?"":"|"),N),groups:d,fast:s,error:r||c}}function p(e,t,n){var a=e&&(e.push||e.next);if(a&&!n[a])throw Error("Missing state '"+a+"' (in token '"+e.defaultType+"' of state '"+t+"')");if(e&&e.pop&&1!=+e.pop)throw Error("pop must be 1 (in token '"+e.defaultType+"' of state '"+t+"')")}var m=function(e,t){this.startState=t,this.states=e,this.buffer="",this.stack=[],this.reset()};m.prototype.reset=function(e,t){return this.buffer=e||"",this.index=0,this.line=t?t.line:1,this.col=t?t.col:1,this.queuedToken=t?t.queuedToken:null,this.queuedText=t?t.queuedText:"",this.queuedThrow=t?t.queuedThrow:null,this.setState(t?t.state:this.startState),this.stack=t&&t.stack?t.stack.slice():[],this},m.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},m.prototype.setState=function(e){if(e&&this.state!==e){this.state=e;var t=this.states[e];this.groups=t.groups,this.error=t.error,this.re=t.regexp,this.fast=t.fast}},m.prototype.popState=function(){this.setState(this.stack.pop())},m.prototype.pushState=function(e){this.stack.push(this.state),this.setState(e)};var h=n?function(e,t){return e.exec(t)}:function(e,t){var n=e.exec(t);return 0===n[0].length?null:n};function f(){return this.value}if(m.prototype._getGroup=function(e){for(var t=this.groups.length,n=0;n<t;n++)if(void 0!==e[n+1])return this.groups[n];throw Error("Cannot find token type for matched text")},m.prototype.next=function(){var e=this.index;if(this.queuedGroup){var t=this._token(this.queuedGroup,this.queuedText,e);return this.queuedGroup=null,this.queuedText="",t}var n=this.buffer;if(e!==n.length){var a=this.fast[n.charCodeAt(e)];if(a)return this._token(a,n.charAt(e),e);var r=this.re;r.lastIndex=e;var i=h(r,n),o=this.error;if(null==i)return this._token(o,n.slice(e,n.length),e);var a=this._getGroup(i),s=i[0];return o.fallback&&i.index!==e?(this.queuedGroup=a,this.queuedText=s,this._token(o,n.slice(e,i.index),e)):this._token(a,s,e)}},m.prototype._token=function(e,t,n){var a=0;if(e.lineBreaks){var r=/\n/g,i=1;if("\n"===t)a=1;else for(;r.exec(t);)a++,i=r.lastIndex}var o={type:"function"==typeof e.type&&e.type(t)||e.defaultType,value:"function"==typeof e.value?e.value(t):t,text:t,toString:f,offset:n,lineBreaks:a,line:this.line,col:this.col},s=t.length;if(this.index+=s,this.line+=a,0!==a?this.col=s-i+1:this.col+=s,e.shouldThrow)throw Error(this.formatError(o,"invalid syntax"));return e.pop?this.popState():e.push?this.pushState(e.push):e.next&&this.setState(e.next),o},"undefined"!=typeof Symbol&&Symbol.iterator){var b=function(e){this.lexer=e};b.prototype.next=function(){var e=this.lexer.next();return{value:e,done:!e}},b.prototype[Symbol.iterator]=function(){return this},m.prototype[Symbol.iterator]=function(){return new b(this)}}return m.prototype.formatError=function(e,t){if(null==e)var n=this.buffer.slice(this.index),e={text:n,offset:this.index,lineBreaks:-1===n.indexOf("\n")?0:1,line:this.line,col:this.col};var a=Math.max(e.line-2,1),r=String(e.line+2).length,i=(function(e,t){for(var n=e.length,a=0;;){var r=e.lastIndexOf("\n",n-1);if(-1===r||(a++,n=r,a===t||0===n))break}var i=a<t?0:n+1;return e.substring(i).split("\n")})(this.buffer,this.line-e.line+2+1).slice(0,5),o=[];o.push(t+" at line "+e.line+" col "+e.col+":"),o.push("");for(var l=0;l<i.length;l++){var u=i[l],c=a+l;o.push(s(String(c),r)+"  "+u),c===e.line&&o.push(s("",r+e.col+1)+"^")}return o.join("\n")},m.prototype.clone=function(){return new m(this.states,this.state)},m.prototype.has=function(e){return!0},{compile:function(e){var t=d(u(e));return new m({start:t},"start")},states:function(e,t){var n=e.$all?u(e.$all):[];delete e.$all;var a=Object.getOwnPropertyNames(e);t||(t=a[0]);for(var r=Object.create(null),i=0;i<a.length;i++){var o=a[i];r[o]=u(e[o]).concat(n)}for(var i=0;i<a.length;i++)for(var o=a[i],s=r[o],l=Object.create(null),c=0;c<s.length;c++){var h=s[c];if(h.include){var f=[c,1];if(h.include!==o&&!l[h.include]){l[h.include]=!0;var b=r[h.include];if(!b)throw Error("Cannot include nonexistent state '"+h.include+"' (in state '"+o+"')");for(var v=0;v<b.length;v++){var x=b[v];-1===s.indexOf(x)&&f.push(x)}}s.splice.apply(s,f),c--}}for(var g=Object.create(null),i=0;i<a.length;i++){var o=a[i];g[o]=d(r[o],!0)}for(var i=0;i<a.length;i++){for(var y=a[i],N=g[y],V=N.groups,c=0;c<V.length;c++)p(V[c],y,g);for(var w=Object.getOwnPropertyNames(N.fast),c=0;c<w.length;c++)p(N.fast[w[c]],y,g)}return new m(g,t)},error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:function(e){for(var t="undefined"!=typeof Map,n=t?new Map:Object.create(null),a=Object.getOwnPropertyNames(e),r=0;r<a.length;r++){var i=a[r],o=e[i];(Array.isArray(o)?o:[o]).forEach(function(e){if("string"!=typeof e)throw Error("keyword must be string (in keyword '"+i+"')");t?n.set(e,i):n[e]=i})}return function(e){return t?n.get(e):n[e]}}}})?a.apply(t,[]):a)&&(e.exports=n)},3614:function(e){var t,n;t=this,n=function(){function e(t,n,a){return this.id=++e.highestId,this.name=t,this.symbols=n,this.postprocess=a,this}function t(e,t,n,a){this.rule=e,this.dot=t,this.reference=n,this.data=[],this.wantedBy=a,this.isComplete=this.dot===e.symbols.length}function n(e,t){this.grammar=e,this.index=t,this.states=[],this.wants={},this.scannable=[],this.completed={}}function a(e,t){this.rules=e,this.start=t||this.rules[0].name;var n=this.byName={};this.rules.forEach(function(e){n.hasOwnProperty(e.name)||(n[e.name]=[]),n[e.name].push(e)})}function r(){this.reset("")}function i(e,t,i){if(e instanceof a)var o=e,i=t;else var o=a.fromCompiled(e,t);for(var s in this.grammar=o,this.options={keepHistory:!1,lexer:o.lexer||new r},i||{})this.options[s]=i[s];this.lexer=this.options.lexer,this.lexerState=void 0;var l=new n(o,0);this.table=[l],l.wants[o.start]=[],l.predict(o.start),l.process(),this.current=0}function o(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return e.toString();if(e.type)return"%"+e.type;if(e.test)return"<"+String(e.test)+">";else throw Error("Unknown symbol type: "+e)}}return e.highestId=0,e.prototype.toString=function(e){var t=void 0===e?this.symbols.map(o).join(" "):this.symbols.slice(0,e).map(o).join(" ")+" ● "+this.symbols.slice(e).map(o).join(" ");return this.name+" → "+t},t.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},t.prototype.nextState=function(e){var n=new t(this.rule,this.dot+1,this.reference,this.wantedBy);return n.left=this,n.right=e,n.isComplete&&(n.data=n.build(),n.right=void 0),n},t.prototype.build=function(){var e=[],t=this;do e.push(t.right.data),t=t.left;while(t.left);return e.reverse(),e},t.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,i.fail))},n.prototype.process=function(e){for(var t=this.states,n=this.wants,a=this.completed,r=0;r<t.length;r++){var o=t[r];if(o.isComplete){if(o.finish(),o.data!==i.fail){for(var s=o.wantedBy,l=s.length;l--;){var u=s[l];this.complete(u,o)}if(o.reference===this.index){var c=o.rule.name;(this.completed[c]=this.completed[c]||[]).push(o)}}}else{var c=o.rule.symbols[o.dot];if("string"!=typeof c){this.scannable.push(o);continue}if(n[c]){if(n[c].push(o),a.hasOwnProperty(c))for(var d=a[c],l=0;l<d.length;l++){var p=d[l];this.complete(o,p)}}else n[c]=[o],this.predict(c)}}},n.prototype.predict=function(e){for(var n=this.grammar.byName[e]||[],a=0;a<n.length;a++){var r=n[a],i=this.wants[e],o=new t(r,0,this.index,i);this.states.push(o)}},n.prototype.complete=function(e,t){var n=e.nextState(t);this.states.push(n)},a.fromCompiled=function(t,n){var r=t.Lexer;t.ParserStart&&(n=t.ParserStart,t=t.ParserRules);var t=t.map(function(t){return new e(t.name,t.symbols,t.postprocess)}),i=new a(t,n);return i.lexer=r,i},r.prototype.reset=function(e,t){this.buffer=e,this.index=0,this.line=t?t.line:1,this.lastLineBreak=t?-t.col:0},r.prototype.next=function(){if(this.index<this.buffer.length){var e=this.buffer[this.index++];return"\n"===e&&(this.line+=1,this.lastLineBreak=this.index),{value:e}}},r.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},r.prototype.formatError=function(e,t){var n=this.buffer;if("string"!=typeof n)return t+" at index "+(this.index-1);var a=n.split("\n").slice(Math.max(0,this.line-5),this.line),r=n.indexOf("\n",this.index);-1===r&&(r=n.length);var i=this.index-this.lastLineBreak,o=String(this.line).length;return t+(" at line "+this.line+" col "+i+":\n\n"+a.map(function(e,t){return s(this.line-a.length+t+1,o)+" "+e},this).join("\n")+"\n"+s("",o+i))+"^\n";function s(e,t){var n=String(e);return Array(t-n.length+1).join(" ")+n}},i.fail={},i.prototype.feed=function(e){var t,a=this.lexer;for(a.reset(e,this.lexerState);;){try{if(!(t=a.next()))break}catch(s){var i=new n(this.grammar,this.current+1);this.table.push(i);var o=Error(this.reportLexerError(s));throw o.offset=this.current,o.token=s.token,o}var l=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var u=this.current+1,i=new n(this.grammar,u);this.table.push(i);for(var c=void 0!==t.text?t.text:t.value,d=a.constructor===r?t.value:t,p=l.scannable,m=p.length;m--;){var h=p[m],f=h.rule.symbols[h.dot];if(f.test?f.test(d):f.type?f.type===t.type:f.literal===c){var b=h.nextState({data:d,token:t,isToken:!0,reference:u-1});i.states.push(b)}}if(i.process(),0===i.states.length){var o=Error(this.reportError(t));throw o.offset=this.current,o.token=t,o}this.options.keepHistory&&(l.lexerState=a.save()),this.current++}return l&&(this.lexerState=a.save()),this.results=this.finish(),this},i.prototype.reportLexerError=function(e){var t,n,a=e.token;return a?(t="input "+JSON.stringify(a.text[0])+" (lexer error)",n=this.lexer.formatError(a,"Syntax error")):(t="input (lexer error)",n=e.message),this.reportErrorCommon(n,t)},i.prototype.reportError=function(e){var t=(e.type?e.type+" token: ":"")+JSON.stringify(void 0!==e.value?e.value:e),n=this.lexer.formatError(e,"Syntax error");return this.reportErrorCommon(n,t)},i.prototype.reportErrorCommon=function(e,t){var n=[];n.push(e);var a=this.table.length-2,r=this.table[a],i=r.states.filter(function(e){var t=e.rule.symbols[e.dot];return t&&"string"!=typeof t});return 0===i.length?(n.push("Unexpected "+t+". I did not expect any more input. Here is the state of my parse table:\n"),this.displayStateStack(r.states,n)):(n.push("Unexpected "+t+". Instead, I was expecting to see one of the following:\n"),i.map(function(e){return this.buildFirstStateStack(e,[])||[e]},this).forEach(function(e){var t=e[0],a=t.rule.symbols[t.dot],r=this.getSymbolDisplay(a);n.push("A "+r+" based on:"),this.displayStateStack(e,n)},this)),n.push(""),n.join("\n")},i.prototype.displayStateStack=function(e,t){for(var n,a=0,r=0;r<e.length;r++){var i=e[r],o=i.rule.toString(i.dot);o===n?a++:(a>0&&t.push("    ^ "+a+" more lines identical to this"),a=0,t.push("    "+o)),n=o}},i.prototype.getSymbolDisplay=function(e){return function(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return"character matching "+e;if(e.type)return e.type+" token";if(e.test)return"token matching "+String(e.test);else throw Error("Unknown symbol type: "+e)}}(e)},i.prototype.buildFirstStateStack=function(e,t){if(-1!==t.indexOf(e))return null;if(0===e.wantedBy.length)return[e];var n=e.wantedBy[0],a=[e].concat(t),r=this.buildFirstStateStack(n,a);return null===r?null:[e].concat(r)},i.prototype.save=function(){var e=this.table[this.current];return e.lexerState=this.lexerState,e},i.prototype.restore=function(e){var t=e.index;this.current=t,this.table[t]=e,this.table.splice(t+1),this.lexerState=e.lexerState,this.results=this.finish()},i.prototype.rewind=function(e){if(!this.options.keepHistory)throw Error("set option `keepHistory` to enable rewinding");this.restore(this.table[e])},i.prototype.finish=function(){var e=[],t=this.grammar.start;return this.table[this.table.length-1].states.forEach(function(n){n.rule.name===t&&n.dot===n.rule.symbols.length&&0===n.reference&&n.data!==i.fail&&e.push(n)}),e.map(function(e){return e.data})},{Parser:i,Grammar:a,Rule:e}},e.exports?e.exports=n():t.nearley=n()},6906:function(e,t,n){"use strict";n.d(t,{Z:function(){return h}});let a=/[\p{Lu}]/u,r=/[\p{Ll}]/u,i=/^[\p{Lu}](?![\p{Lu}])/gu,o=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,l=RegExp("^"+s.source),u=RegExp(s.source+o.source,"gu"),c=RegExp("\\d+"+o.source,"gu"),d=(e,t,n)=>{let i=!1,o=!1,s=!1;for(let l=0;l<e.length;l++){let u=e[l];i&&a.test(u)?(e=e.slice(0,l)+"-"+e.slice(l),i=!1,s=o,o=!0,l++):o&&s&&r.test(u)?(e=e.slice(0,l-1)+"-"+e.slice(l-1),s=o,o=!1,i=!0):(i=t(u)===u&&n(u)!==u,s=o,o=n(u)===u&&t(u)!==u)}return e},p=(e,t)=>(i.lastIndex=0,e.replace(i,e=>t(e))),m=(e,t)=>(u.lastIndex=0,c.lastIndex=0,e.replace(u,(e,n)=>t(n)).replace(c,e=>t(e)));function h(e,t){if(!("string"==typeof e||Array.isArray(e)))throw TypeError("Expected the input to be `string | string[]`");if(t={pascalCase:!1,preserveConsecutiveUppercase:!1,...t},0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length)return"";let n=!1===t.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(t.locale),a=!1===t.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(t.locale);if(1===e.length)return s.test(e)?"":t.pascalCase?a(e):n(e);let r=e!==n(e);return r&&(e=d(e,n,a)),e=e.replace(l,""),e=t.preserveConsecutiveUppercase?p(e,n):n(e),t.pascalCase&&(e=a(e.charAt(0))+e.slice(1)),m(e,a)}},6254:function(e,t,n){"use strict";n.d(t,{ZP:function(){return nn}});var a,r=n(3614),i=n(2569),o=Object.defineProperty,s=Object.defineProperties,l=Object.getOwnPropertyDescriptors,u=Object.getOwnPropertySymbols,c=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,p=(e,t,n)=>t in e?o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,m=(e,t)=>{for(var n in t||(t={}))c.call(t,n)&&p(e,n,t[n]);if(u)for(var n of u(t))d.call(t,n)&&p(e,n,t[n]);return e},h=(e,t)=>s(e,l(t)),f=e=>"symbol"==typeof e?e:e+"",b=(e,t)=>{var n={};for(var a in e)c.call(e,a)&&0>t.indexOf(a)&&(n[a]=e[a]);if(null!=e&&u)for(var a of u(e))0>t.indexOf(a)&&d.call(e,a)&&(n[a]=e[a]);return n},v=class extends Error{name;info;constructor(e,t,n,a){super(x(e,t,n,a)),this.name=e,this.info=n}},x=(e,t,n,a)=>{var r;let i=/error/i.test(e);return`
[ ${({SyntaxError:"Erreur syntaxique",EvaluationError:"Erreur d'\xe9valuation",UnknownRule:"R\xe8gle inconnue",PrivateRule:"R\xe8gle priv\xe9e"})[e]??e} ]`+(n&&"dottedName"in n&&(null==(r=n.dottedName)?void 0:r.length)?`
\u27A1\uFE0F  Dans la r\xe8gle "${n.dottedName}"`:"")+`
${i?"✖️":"⚠️"}  ${t}`+(a?"\n"+(i?"    ":"ℹ️  ")+a.message:"")},g=class extends v{constructor(e){super("InternalError",`
Erreur interne du moteur.

Cette erreur est le signe d'un bug dans publicodes. Pour nous aider \xe0 le r\xe9soudre, vous pouvez copier ce texte dans un nouveau ticket : https://github.com/betagouv/mon-entreprise/issues/new.

payload:
${JSON.stringify(e,null,2)}
`,e)}},y=class extends g{constructor(e){super(e)}};function N(e,t,n,a){e.warn(x("Avertissement",t,n,a))}function V(e,t){e.warn(x("Avertissement","Cette r\xe8gle est taggu\xe9e comme experimentale. \n\nCela veut dire qu'elle peut \xeatre modifi\xe9e, renomm\xe9e, ou supprim\xe9e sans qu'il n'y ait de changement de version majeure dans l'API.\n",{dottedName:t}))}function w(e,t=!0){return function n(a){let r=e(a,n);return!1===r?a:void 0===r?E(n,a):t?r:E(n,r)}}function $(e){function t(a){switch(e(a,t)){case"continue":E(n,a);return;case"stop":return}}let n=e=>(t(e),e);return t}var E=(e,t)=>{switch((t=k(e,t)).nodeKind){case"rule":return S(e,t);case"reference":case"constant":return R(e,t);case"arrondi":return C(e,t);case"simplifier unit\xe9":case"variable manquante":case"est non applicable":case"est non d\xe9fini":return j(e,t);case"bar\xe8me":case"taux progressif":case"grille":return _(e,t);case"une possibilit\xe9":return A(e,t);case"dur\xe9e":return T(e,t);case"r\xe9soudre r\xe9f\xe9rence circulaire":return L(e,t);case"inversion":return K(e,t);case"operation":return I(e,t);case"recalcul":return D(e,t);case"unit\xe9":return P(e,t);case"variations":return U(e,t);case"replacementRule":return O(e,t);case"texte":return M(e,t);case"condition":return q(e,t);default:throw new y(t)}},k=(e,t)=>{if(!("sourceMap"in t)||!t.sourceMap||!t.sourceMap.args)return t;let n=t.sourceMap;return h(m({},t),{sourceMap:h(m({},n),{args:Object.fromEntries(Object.entries(n.args).map(([t,n])=>[t,Array.isArray(n)?n.map(t=>e(t)):e(n)]))})})},S=(e,t)=>h(m({},t),{replacements:t.replacements.map(e),suggestions:Object.fromEntries(Object.entries(t.suggestions).map(([t,n])=>[t,e(n)])),explanation:{ruleDisabledByItsParent:t.explanation.ruleDisabledByItsParent,nullableParent:t.explanation.nullableParent?e(t.explanation.nullableParent):void 0,parents:t.explanation.parents.map(e),valeur:e(t.explanation.valeur)}}),O=(e,t)=>h(m({},t),{definitionRule:e(t.definitionRule),replacedReference:e(t.replacedReference),replacementNode:e(t.replacementNode),whiteListedNames:t.whiteListedNames.map(e),blackListedNames:t.blackListedNames.map(e)}),R=(e,t)=>t,j=(e,t)=>h(m({},t),{explanation:e(t.explanation)}),_=(e,t)=>h(m({},t),{explanation:{assiette:e(t.explanation.assiette),multiplicateur:e(t.explanation.multiplicateur),tranches:t.explanation.tranches.map(t=>m(m(m(m({},t),t.plafond&&{plafond:e(t.plafond)}),"montant"in t&&{montant:e(t.montant)}),"taux"in t&&{taux:e(t.taux)}))}}),A=(e,t)=>h(m({},t),{explanation:t.explanation.map(e)}),I=(e,t)=>h(m({},t),{explanation:[e(t.explanation[0]),e(t.explanation[1])]}),T=(e,t)=>h(m({},t),{explanation:{depuis:e(t.explanation.depuis),"jusqu'\xe0":e(t.explanation["jusqu'\xe0"])}}),K=(e,t)=>h(m({},t),{explanation:h(m({},t.explanation),{inversionCandidates:t.explanation.inversionCandidates.map(e)})}),C=(e,t)=>h(m({},t),{explanation:{valeur:e(t.explanation.valeur),arrondi:e(t.explanation.arrondi)}}),L=(e,t)=>h(m({},t),{explanation:h(m({},t.explanation),{valeur:e(t.explanation.valeur)})}),M=(e,t)=>h(m({},t),{explanation:t.explanation.map(t=>"string"==typeof t?t:e(t))}),D=(e,t)=>h(m({},t),{explanation:h(m({},t.explanation),{amendedSituation:t.explanation.amendedSituation.map(([t,n])=>[e(t),e(n)]),recalcul:t.explanation.recalculNode&&e(t.explanation.recalculNode)})}),P=(e,t)=>h(m({},t),{explanation:e(t.explanation)}),U=(e,t)=>h(m({},t),{explanation:t.explanation.map(({condition:t,consequence:n})=>({condition:e(t),consequence:n&&e(n)}))}),q=(e,t)=>h(m({},t),{explanation:{si:e(t.explanation.si),alors:e(t.explanation.alors),sinon:e(t.explanation.sinon)}}),W={constant:e=>e};function B(e,t){if(W??(W={}),W[e])throw new v("EvaluationError",`Multiple evaluation functions registered for the nodeKind \x1b[4m${e}`,{dottedName:""});W[e]=t}var F={isNullable:void 0,type:void 0};function z(e){let[t,n,a]=e.split("/");return a||([t,n,a]=["01",t,n]),G(+a,+n,+t)}var J=e=>10>+e?`0${e}`:""+e;function G(e,t,n){let a=new Date(+e,+t-1,+n);if(!+a||a.getDate()!==+n)throw new v("SyntaxError",`La date ${n}/${t}/${e} n'est pas valide`,{dottedName:""});return`${J(n)}/${J(t)}/${J(e)}`}function H(e){let[t,n,a]=z(e).split("/"),r=new Date(+a,+n-1,+t);return r.setMinutes(r.getMinutes()-r.getTimezoneOffset()),r}var Z=([e,,t,,n])=>({[t.value.toLowerCase()]:[e,n]}),Y=([e,,t])=>({[e]:[ee([{value:"0"}]),t]}),Q=({value:e})=>({variable:e}),X=([{value:e}])=>{console.log(e)},ee=([{value:e}])=>({constant:{type:"number",nodeValue:parseFloat(e)}}),et=e=>h(m({},ee(e)),{unité:e[2].value}),en=([{value:e}])=>({constant:{type:"date",nodeValue:z(e)}}),ea=([{value:e}])=>({constant:{type:"boolean",nodeValue:"oui"===e}}),er=([{value:e}])=>({constant:{type:"string",nodeValue:e.slice(1,-1)}});function ei(e){return e[0]}var eo=`[a-zA-Z\xc0-ſ€$%](?:[-']?[a-zA-Z\xc0-ſ0-9',\xb0]+)*`,es=i.compile({"(":"(",")":")","[":"[","]":"]",comparison:[">","<",">=","<=","=","!="],date:RegExp("(?:(?:0?[1-9]|[12][0-9]|3[01])\\/)?(?:0?[1-9]|1[012])\\/\\d{4}"),boolean:["oui","non"],number:RegExp("-?(?:[1-9][0-9]+|[0-9])(?:\\.[0-9]+)?"),word:RegExp(eo),string:[/'.*'/,/".*"/],JSONObject:/{.*}/,additionSubstraction:/[\+-]/,multiplicationDivision:["*","/"],dot:" . ",".":".",space:{match:/[\s]+/,lineBreaks:!0}}),el=e=>({value:e.map(e=>e&&e.value).join("")}),eu=([e,t])=>Array.isArray(t)?el([e,...t]):e,ec=[{name:"main",symbols:["Comparison"],postprocess:ei},{name:"main",symbols:["NumericValue"],postprocess:ei},{name:"main",symbols:["Date"],postprocess:ei},{name:"main",symbols:["NonNumericTerminal"],postprocess:ei},{name:"main",symbols:["JSONObject"],postprocess:ei},{name:"NumericValue",symbols:["AdditionSubstraction"],postprocess:ei},{name:"NumericValue",symbols:["Negation"],postprocess:ei},{name:"NumericTerminal",symbols:["Variable"],postprocess:ei},{name:"NumericTerminal",symbols:["number"],postprocess:ei},{name:"Negation",symbols:[{literal:"-"},es.has("space")?{type:"space"}:space,"Parentheses"],postprocess:Y},{name:"Parentheses",symbols:[{literal:"("},es.has("space")?{type:"space"}:space,"NumericValue",es.has("space")?{type:"space"}:space,{literal:")"}],postprocess:([,,e])=>e},{name:"Parentheses",symbols:[{literal:"("},"NumericValue",{literal:")"}],postprocess:([,e])=>e},{name:"Parentheses",symbols:["NumericTerminal"],postprocess:ei},{name:"Date",symbols:["Variable"],postprocess:ei},{name:"Date",symbols:[es.has("date")?{type:"date"}:en],postprocess:en},{name:"Comparison",symbols:["Comparable",es.has("space")?{type:"space"}:space,es.has("comparison")?{type:"comparison"}:comparison,es.has("space")?{type:"space"}:space,"Comparable"],postprocess:Z},{name:"Comparison",symbols:["Date",es.has("space")?{type:"space"}:space,es.has("comparison")?{type:"comparison"}:comparison,es.has("space")?{type:"space"}:space,"Date"],postprocess:Z},{name:"Comparable$subexpression$1",symbols:["AdditionSubstraction"]},{name:"Comparable$subexpression$1",symbols:["NonNumericTerminal"]},{name:"Comparable",symbols:["Comparable$subexpression$1"],postprocess:([[e]])=>e},{name:"NonNumericTerminal",symbols:[es.has("boolean")?{type:"boolean"}:ea],postprocess:ea},{name:"NonNumericTerminal",symbols:[es.has("string")?{type:"string"}:er],postprocess:er},{name:"Variable$ebnf$1",symbols:[]},{name:"Variable$ebnf$1$subexpression$1",symbols:[es.has("dot")?{type:"dot"}:dot,"Words"],postprocess:el},{name:"Variable$ebnf$1",symbols:["Variable$ebnf$1","Variable$ebnf$1$subexpression$1"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Variable",symbols:["Words","Variable$ebnf$1"],postprocess:e=>Q(eu(e))},{name:"Words$ebnf$1$subexpression$1$ebnf$1",symbols:[es.has("space")?{type:"space"}:space],postprocess:ei},{name:"Words$ebnf$1$subexpression$1$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Words$ebnf$1$subexpression$1",symbols:["Words$ebnf$1$subexpression$1$ebnf$1","WordOrNumber"],postprocess:el},{name:"Words$ebnf$1",symbols:["Words$ebnf$1$subexpression$1"]},{name:"Words$ebnf$1$subexpression$2$ebnf$1",symbols:[es.has("space")?{type:"space"}:space],postprocess:ei},{name:"Words$ebnf$1$subexpression$2$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Words$ebnf$1$subexpression$2",symbols:["Words$ebnf$1$subexpression$2$ebnf$1","WordOrNumber"],postprocess:el},{name:"Words$ebnf$1",symbols:["Words$ebnf$1","Words$ebnf$1$subexpression$2"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Words",symbols:["WordOrKeyword","Words$ebnf$1"],postprocess:eu},{name:"Words",symbols:[es.has("word")?{type:"word"}:eo],postprocess:ei},{name:"WordOrKeyword",symbols:[es.has("word")?{type:"word"}:eo],postprocess:ei},{name:"WordOrKeyword",symbols:[es.has("boolean")?{type:"boolean"}:ea],postprocess:ei},{name:"WordOrNumber",symbols:["WordOrKeyword"],postprocess:ei},{name:"WordOrNumber",symbols:[es.has("number")?{type:"number"}:ee],postprocess:ei},{name:"UnitDenominator$ebnf$1$subexpression$1",symbols:[es.has("space")?{type:"space"}:space]},{name:"UnitDenominator$ebnf$1",symbols:["UnitDenominator$ebnf$1$subexpression$1"],postprocess:ei},{name:"UnitDenominator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitDenominator",symbols:["UnitDenominator$ebnf$1",{literal:"/"},"Words"],postprocess:el},{name:"UnitNumerator$ebnf$1$subexpression$1",symbols:[{literal:"."},"Words"]},{name:"UnitNumerator$ebnf$1",symbols:["UnitNumerator$ebnf$1$subexpression$1"],postprocess:ei},{name:"UnitNumerator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitNumerator",symbols:["Words","UnitNumerator$ebnf$1"],postprocess:eu},{name:"Unit$ebnf$1",symbols:["UnitNumerator"],postprocess:ei},{name:"Unit$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Unit$ebnf$2",symbols:[]},{name:"Unit$ebnf$2",symbols:["Unit$ebnf$2","UnitDenominator"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Unit",symbols:["Unit$ebnf$1","Unit$ebnf$2"],postprocess:eu},{name:"AdditionSubstraction",symbols:["AdditionSubstraction",es.has("space")?{type:"space"}:space,es.has("additionSubstraction")?{type:"additionSubstraction"}:additionSubstraction,es.has("space")?{type:"space"}:space,"MultiplicationDivision"],postprocess:Z},{name:"AdditionSubstraction",symbols:["MultiplicationDivision"],postprocess:ei},{name:"MultiplicationDivision",symbols:["MultiplicationDivision",es.has("space")?{type:"space"}:space,es.has("multiplicationDivision")?{type:"multiplicationDivision"}:multiplicationDivision,es.has("space")?{type:"space"}:space,"Parentheses"],postprocess:Z},{name:"MultiplicationDivision",symbols:["Parentheses"],postprocess:ei},{name:"number",symbols:[es.has("number")?{type:"number"}:ee],postprocess:ee},{name:"number$ebnf$1$subexpression$1",symbols:[es.has("space")?{type:"space"}:space]},{name:"number$ebnf$1",symbols:["number$ebnf$1$subexpression$1"],postprocess:ei},{name:"number$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"number",symbols:[es.has("number")?{type:"number"}:ee,"number$ebnf$1","Unit"],postprocess:et},{name:"JSONObject",symbols:[es.has("JSONObject")?{type:"JSONObject"}:X],postprocess:X}];function ed(e,t,n){let a,r;function i(i,o){a??(a=t9(n,t4({dottedName:"INLINE_MECANISM"}))),r??(r=Object.fromEntries(Object.entries(t).filter(([,e])=>"par d\xe9faut"in e).map(([e,t])=>[e,t9(t["par d\xe9faut"],t4({}))]))),1===Object.keys(t).length&&"valeur"in t&&(i={valeur:i});let s=Object.fromEntries(Object.entries(i).map(([e,t])=>[e,t9(t,o)])),l=w(n=>{if("reference"!==n.nodeKind||!(n.name in t))return;let a=n.name;if(a in s)return s[a];if(a in r)return r[a];throw new v("SyntaxError",`Il manque la cl\xe9 '${a} dans le m\xe9canisme ${e}`,{dottedName:a})})(a);return l.sourceMap={mecanismName:e,args:s},l}return i.nom=e,Object.assign(i,"name",{value:`parse${em(e)}Inline`})}function ep(e,t,n){function a(a,r){1===Object.keys(t).length&&"valeur"in t&&(a={valeur:a});let i=Object.fromEntries(Object.entries(a).map(([e,t])=>[e,Array.isArray(t)?t.map(e=>t9(e,r)):t9(t,r)])),o=t9(n(i),r);return o.sourceMap={mecanismName:e,args:i},o}return a.nom=e,Object.assign(a,"name",{value:`parse${em(e)}Inline`})}function em(e){return e.replace(/(?:^\w|[A-Z]|\b\w)/g,e=>e.toUpperCase()).replace(/\s+/g,"")}var eh={nodeKind:"constant",nodeValue:null,missingVariables:{},type:void 0,isNullable:!0},ef={nodeKind:"constant",nodeValue:void 0,missingVariables:{},type:void 0,isNullable:!1},eb=h(m({},ef),{type:"number"}),ev=ed("abattement",{abattement:{},valeur:{}},{"-":["valeur","abattement"],plancher:0}),ex=ed("applicable si",{"applicable si":{},valeur:{}},{condition:{si:"applicable si != non",alors:"valeur",sinon:eh}}),eg=e=>"missingVariables"in e?e.missingVariables:{},ey=(e={})=>Object.fromEntries(Object.entries(e).map(([e,t])=>[e,t+1])),eN=(e={},t={})=>Object.fromEntries([...Object.keys(e),...Object.keys(t)].map(n=>[n,(e[n]??0)+(t[n]??0)])),eV=e=>e.map(eg).reduce(eN,{}),ew=e=>({nodeValue:e,type:typeof e,isDefault:!0,nodeKind:"constant"}),e$=(e,t,n)=>Object.fromEntries(Object.entries(e).map(([e,a])=>{if(void 0==t[e]&&!a)throw new v("EngineError",`Il manque une cl\xe9 '${e}' dans ${JSON.stringify(t)} `,{});let r=void 0!=t[e]?t9(t[e],n):a;return[e,r]})),eE=(e,t=e=>e)=>{let[n,...a]=e.split("/").map(e=>e.trim()),r={numerators:n.split(".").filter(Boolean).map(e=>t(e)),denominators:a.map(e=>t(e))};return r},ek=(e,t,n=e=>e)=>e.sort().map(e=>n(e,t)).join("."),eS=(e,t=2,n=e=>e)=>{if(null===e||"object"!=typeof e)return"string"==typeof e?n(e,t):e;let a=eA(e),{numerators:r=[],denominators:i=[]}=a,o=r.length>0,s=i.length>0,l=o||s?o&&!s?ek(r,t,n):!o&&s?`/${ek(i,1,n)}`:`${ek(r,2,n)} / ${ek(i,1,n)}`:"";return l},eO={numerators:[],denominators:[]},eR=(e,t)=>{if("/"===e){if(2!==t.length)throw new v("InternalError","Infer units of a division with units.length !== 2)",{});return eR("*",[t[0]||eO,{numerators:(t[1]||eO).denominators,denominators:(t[1]||eO).numerators}])}let n=t.filter(Boolean);return n.length<=1?n[0]:"*"===e?eA({numerators:n.flatMap(e=>(null==e?void 0:e.numerators)??[]),denominators:n.flatMap(e=>(null==e?void 0:e.denominators)??[])}):"-"===e||"+"===e?t.find(e=>e):void 0},ej=(e,t)=>Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every((n,a)=>e[a]===t[a]):e===t,e_=(e,t=ej)=>n=>{let a=n.findIndex(n=>t(n,e));return n.filter((e,t)=>t!==a)},eA=(e,t=ej)=>[...e.numerators,...e.denominators].reduce(({numerators:e,denominators:n},a)=>e.find(e=>t(a,e))&&n.find(e=>t(a,e))?{numerators:e_(a,t)(e),denominators:e_(a,t)(n)}:{numerators:e,denominators:n},e),eI={"mois/an":12,"jour/an":365,"jour/mois":365/12,"trimestre/an":4,"mois/trimestre":3,"jour/trimestre":365/12*3,"€/k€":1e3,"g/kg":1e3,"mg/g":1e3,"mg/kg":1e6,"m/km":1e3,"cm/m":100,"mm/cm":10,"mm/m":1e3,"cm/km":1e5,"mm/km":1e6};function eT(e,t){return eI[`${t}/${e}`]||eI[`${e}/${t}`]&&1/eI[`${e}/${t}`]}function eK(e,t){let n=100**(t.filter(e=>"%"===e).length-e.filter(e=>"%"===e).length);return[n]=e.reduce(([e,t],n)=>{let a=t.findIndex(e=>!!eT(n,e)),r=eT(n,t[a])||1;return[e*r,[...t.slice(0,a+1),...t.slice(a+1)]]},[n,t]),n}function eC(e,t,n){if(!function(e,t){if(null==e||null==t)return!0;let n=e=>e.reduce((e,t)=>{let n=eL.findIndex(e=>e.has(t)),a=-1===n?t:""+n;return h(m({},e),{[a]:1+(e[a]??0)})},{}),[a,r,i,o]=[e.numerators,e.denominators,t.numerators,t.denominators].map(n),s=[a,r,i,o].map(Object.keys).flat();return[...new Set(s)].every(e=>(a[e]||0)-(r[e]||0)==(i[e]||0)-(o[e]||0)||"%"===e)}(e,t))throw new v("EngineError",`Impossible de convertir l'unit\xe9 '${eS(e)}' en '${eS(t)}'`,{});if(!n||void 0===e)return n;let[a,r]=eU(e||eO),[i,o]=eU(t||eO);return eD(n*r/o*eK(a.numerators,i.numerators)*eK(i.denominators,a.denominators))}var eL=Object.keys(eI).reduce((e,t)=>{let[n,a]=t.split("/"),r=e.findIndex(e=>e.has(n)),i=e.findIndex(e=>e.has(a));if(r>-1&&i>-1&&r!==i)throw new v("EngineError",`Invalid ratio ${t}`,{});return -1===r&&-1===i?e.push(new Set([n,a])):r>-1?e[r].add(a):i>-1&&e[i].add(n),e},[]);function eM(e,t){return e===t||eL.some(n=>n.has(e)&&n.has(t))}function eD(e){return+e.toFixed(16)}function eP(e){let{numerators:t,denominators:n}=eA(e,eM);return t.length&&t.every(e=>"%"===e)?{numerators:["%"],denominators:n}:eq({numerators:t,denominators:n})}function eU(e,t=1){let n=eK(e.numerators,e.denominators);return[eA(eq(e),eM),t?eD(t*n):t]}var eq=e=>({numerators:e.numerators.filter(e=>"%"!==e),denominators:e.denominators.filter(e=>"%"!==e)});function eW(e,t){let n={valeur:t9(e.valeur,t),arrondi:t9(e.arrondi,t)};return{explanation:n,nodeKind:eW.nom}}function eB(e,t){Object.entries(e.avec).forEach(([e,n])=>{t9(m({nom:e},void 0==n?{}:"object"!=typeof n||"nodeKind"in n?{valeur:n}:n),t)});let n=t9(e.valeur,t);return n}eW.nom="arrondi",B(eW.nom,function(e){var t,n,a;let r=e1(this.evaluateNode(e.explanation.valeur)),i=r.nodeValue,o=e.explanation.arrondi;if(!1!==i&&"number"==typeof(o=this.evaluateNode(o)).nodeValue&&!(null==(t=eS(o.unit))?void 0:t.match(/décimales?/)))throw new v("EvaluationError",`L'unit\xe9 ${eS(o.unit)} de l'arrondi est inconnu. Vous devez utiliser l'unit\xe9 \u201Cd\xe9cimales\u201D`,{dottedName:this.cache._meta.evaluationRuleStack[0]});return h(m({},e),{nodeValue:"number"==typeof r.nodeValue&&"nodeValue"in o?"number"==typeof o.nodeValue?(n=r.nodeValue,a=o.nodeValue,+n.toFixed(a)):!0===o.nodeValue?+r.nodeValue.toFixed(0):void 0===o.nodeValue?void 0:r.nodeValue:r.nodeValue,explanation:{valeur:r,arrondi:o},missingVariables:eV([r,o]),unit:r.unit})}),eB.nom="avec";var eF=(e,t)=>e.map((n,a)=>{if(!n.plafond&&a>e.length)throw new v("SyntaxError",`La tranche n\xb0${a} du bar\xe8me n'a pas de plafond pr\xe9cis\xe9. Seule la derni\xe8re tranche peut ne pas \xeatre plafonn\xe9e`,{dottedName:""});return h(m(m(m({},n),void 0!==n.taux?{taux:t9(n.taux,t)}:{}),void 0!==n.montant?{montant:t9(n.montant,t)}:{}),{plafond:"plafond"in n?t9(n.plafond,t):{nodeValue:1/0,nodeKind:"constant",type:"number",isNullable:!1}})});function ez({multiplicateur:e,assiette:t,parsedTranches:n}){return n.reduce(([n,a],r,i)=>{if(a)return[[...n,h(m({},r),{isAfterActive:!0})],a];let o=this.evaluateNode(r.plafond),s=n[i-1]?n[i-1].plafond:{nodeValue:0},l=void 0===o.nodeValue||void 0===e.nodeValue?void 0:o.nodeValue*e.nodeValue;try{l=l===1/0||0===l?l:eC(eR("*",[o.unit,e.unit]),t.unit,l)}catch(u){N(this.context.logger,`L'unit\xe9 du plafond de la tranche n\xb0${i+1}  n'est pas compatible avec celle l'assiette`,{dottedName:this.cache._meta.evaluationRuleStack[0]},u)}let c=n[i-1]?n[i-1].plafondValue:0,d=void 0===c||void 0===t.nodeValue?void 0:c>t.nodeValue,p=[o,t,e,s];if(p.some(e=>void 0===e.nodeValue))return[[...n,h(m({},r),{plafond:o,plafondValue:l,plancherValue:c,nodeValue:void 0,isActive:void 0,isAfterActive:d,missingVariables:eV(p)})],!1];if(n[i-1]&&c&&l<=c)throw new v("EvaluationError",`Le plafond de la tranche n\xb0${i+1} a une valeur inf\xe9rieure \xe0 celui de la tranche pr\xe9c\xe9dente`,{dottedName:this.cache._meta.evaluationRuleStack[0]});let f=h(m({},r),{plafond:o,plancherValue:c,plafondValue:l,isAfterActive:d,isActive:t.nodeValue>=c&&t.nodeValue<l});return[[...n,f],f.isActive]},[[],!1])[0]}B("bar\xe8me",function(e){let t=this.evaluateNode.bind(this),n=this.evaluateNode(e.explanation.assiette),a=this.evaluateNode(e.explanation.multiplicateur),r=ez.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:a}).map(e=>{if(e.isAfterActive)return h(m({},e),{nodeValue:0});let a=t(e.taux),r=eV([a,e]);return[n.nodeValue,a.nodeValue,e.plafondValue,e.plancherValue].some(e=>void 0===e)?h(m({},e),{taux:a,nodeValue:void 0,missingVariables:r}):h(m(h(m({},e),{taux:a}),"unit"in n&&{unit:n.unit}),{nodeValue:(Math.min(n.nodeValue,e.plafondValue)-e.plancherValue)*eC(a.unit,eE(""),a.nodeValue),missingVariables:r})}),i=r.reduce((e,{nodeValue:t})=>void 0==t?void 0:e+t,0);return h(m({},e),{nodeValue:i,missingVariables:eV([n,a,...r]),explanation:{assiette:n,multiplicateur:a,tranches:r},unit:n.unit})});var eJ=(e,t,n)=>{let{composantes:a}=t,r=b(t,["composantes"]),i=t9({somme:a.map(t=>{let{attributs:n}=t,a=b(t,["attributs"]);return h(m({},n),{valeur:{[e]:m(m({},r),a)}})})},n);return h(m({},i),{sourceMap:h(m({args:{}},i.sourceMap),{mecanismName:"composantes"})})};function eG(e,t){let n={si:t9(e.si,t),alors:t9(e.alors,t),sinon:t9(e.sinon,t)};return{explanation:n,nodeKind:"condition"}}eG.nom="condition",B("condition",function(e){let t;let n=this.evaluateNode(e.explanation.si),a=e.explanation.alors,r=e.explanation.sinon;if("unit"in n)throw new v("EvaluationError","La condition doit \xeatre de type bool\xe9en",{dottedName:this.cache._meta.evaluationRuleStack[0]});if(!0===n.nodeValue)(a=this.evaluateNode(e.explanation.alors)).isActive=!0,t=a;else if(!1===n.nodeValue)t=r=this.evaluateNode(e.explanation.sinon);else if(null===n.nodeValue)t=n;else if(void 0===n.nodeValue)r=this.evaluateNode(e.explanation.sinon),a=this.evaluateNode(e.explanation.alors),t=h(m({},n),{missingVariables:eV([r,a])});else throw new v("EvaluationError","La condition doit \xeatre de type bool\xe9en",{dottedName:this.cache._meta.evaluationRuleStack[0]});let i=t.unit??a.unit;return h(m(m(h(m({},t),{missingVariables:eN(ey(n.missingVariables),t.missingVariables)}),void 0!=i?{unit:i}:{}),e),{explanation:{si:n,alors:a,sinon:r}})});var eH=G((a=new Date).getFullYear(),a.getMonth()+1,a.getDate()),eZ={depuis:ew(eH),"jusqu'\xe0":ew(eH)},eY=(e,t)=>{let n=e$(eZ,e,t);return{explanation:n,unit:eE("jour"),nodeKind:"dur\xe9e"}};function eQ(e,t){let n=t9(e,t);return{explanation:n,nodeKind:"est non d\xe9fini"}}B("dur\xe9e",function(e){let t;let n=this.evaluateNode(e.explanation.depuis),a=this.evaluateNode(e.explanation["jusqu'\xe0"]);if([n,a].some(({nodeValue:e})=>void 0===e))t=void 0;else{let[r,i]=[n.nodeValue,a.nodeValue].map(H);t=Math.max(0,Math.round((i.getTime()-r.getTime())/864e5))}return h(m({},e),{missingVariables:eV([n,a]),nodeValue:t,explanation:{depuis:n,"jusqu'\xe0":a}})}),eQ.nom="est non d\xe9fini";var eX=ed("est d\xe9fini",{valeur:{}},{"=":[{"est non d\xe9fini":"valeur"},"non"]}),e0=ed("est applicable",{valeur:{}},{"=":[{"est non applicable":"valeur"},"non"]});function e1(e){if(!e.unit)return e;let t=eP(e.unit);return e9(t,e)}function e9(e,t){return h(m({},t),{nodeValue:t.unit&&"number"==typeof t.nodeValue?eC(t.unit,e,t.nodeValue):t.nodeValue,unit:e})}B("est non d\xe9fini",function(e){let t=this.evaluateNode(e.explanation),n=!1;return void 0===t.nodeValue&&(n=!0),h(m({},e),{nodeValue:n,missingVariables:t.missingVariables,explanation:t})});var e2=({style:e,maximumFractionDigits:t=2,minimumFractionDigits:n=0,language:a})=>r=>{let i="currency"===e&&t>=2&&0===n&&!Number.isInteger(r)?2:n;return Intl.NumberFormat(a,{style:e,currency:"EUR",maximumFractionDigits:t,minimumFractionDigits:i}).format(r)},e8={fr:{true:"oui",false:"non"},en:{true:"yes",false:"no"}};function e6(e,t,n){if(e.has(t)){e.get(t).add(n);return}e.set(t,new Set([n]))}function e3(e,t){return null!=e&&Object.prototype.hasOwnProperty.call(e,t)}function e5(e){return function(...t){return e}}((e,t)=>{for(var n in t)o(e,n,{get:t[n],enumerable:!0})})({},{contextNameToDottedName:()=>td,cyclicDependencies:()=>tr,decodeRuleName:()=>tc,disambiguateReference:()=>tx,disambiguateReferenceNode:()=>tN,encodeRuleName:()=>tu,findCommonAncestor:()=>tf,getChildrenRules:()=>th,isAccessible:()=>tb,isExperimental:()=>tv,nameLeaf:()=>tl,ruleParent:()=>tp,ruleParents:()=>tm,ruleWithDedicatedDocumentationPage:()=>tg,updateReferencesMapsFromReferenceNode:()=>ty});var e4=(e,t)=>{e[t]?e[t]++:e[t]=1},e7=(e,t)=>{--e[t]||delete e[t]},te=(e,t,n,a)=>{let r=""+t,i=""+n;if(!e&&r>i){let o=r;r=i,i=o}return r+"\x01"+i+"\x01"+(void 0===a?"\0":a)},tt=(e,t,n,a)=>{let r=""+t,i=""+n;if(!e&&r>i){let o=r;r=i,i=o}let s={v:r,w:i};return a&&(s.name=a),s},tn=(e,t)=>te(e,t.v,t.w,t.name),ta=class{_nodeCount=0;_edgeCount=0;_isDirected;_label;_defaultNodeLabelFn;_defaultEdgeLabelFn;_nodes;_in;_preds;_out;_sucs;_edgeObjs;_edgeLabels;constructor(e={}){this._isDirected=!e3(e,"directed")||e.directed,this._label=void 0,this._defaultNodeLabelFn=e5(void 0),this._defaultEdgeLabelFn=e5(void 0),this._nodes={},this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}isDirected(){return this._isDirected}setGraph(e){return this._label=e,this}graph(){return this._label}nodeCount(){return this._nodeCount}nodes(){return Object.keys(this._nodes)}setNode(e,t){return e3(this._nodes,e)?(arguments.length>1&&(this._nodes[e]=t),this):(this._nodes[e]=arguments.length>1?t:this._defaultNodeLabelFn(e),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount,this)}setNodes(e,t){return e.forEach(e=>{void 0!==t?this.setNode(e,t):this.setNode(e)}),this}node(e){return this._nodes[e]}hasNode(e){return e3(this._nodes,e)}successors(e){let t=this._sucs[e];if(t)return Object.keys(t)}edgeCount(){return this._edgeCount}edges(){return Object.values(this._edgeObjs)}setEdge(e,t,n,a){e=""+e,t=""+t;let r=te(this._isDirected,e,t,a);if(e3(this._edgeLabels,r))return void 0!==n&&(this._edgeLabels[r]=n),this;this.setNode(e),this.setNode(t),this._edgeLabels[r]=void 0!==n?n:this._defaultEdgeLabelFn(e,t,a);let i=tt(this._isDirected,e,t,a);return e=i.v,t=i.w,Object.freeze(i),this._edgeObjs[r]=i,e4(this._preds[t],e),e4(this._sucs[e],t),this._in[t][r]=i,this._out[e][r]=i,this._edgeCount++,this}edge(e,t,n){let a=1==arguments.length?tn(this._isDirected,arguments[0]):te(this._isDirected,e,t,n);return this._edgeLabels[a]}hasEdge(e,t,n){let a=1==arguments.length?tn(this._isDirected,arguments[0]):te(this._isDirected,e,t,n);return e3(this._edgeLabels,a)}removeEdge(e,t,n){let a=1==arguments.length?tn(this._isDirected,arguments[0]):te(this._isDirected,e,t,n),r=this._edgeObjs[a];return r&&(e=r.v,t=r.w,delete this._edgeLabels[a],delete this._edgeObjs[a],e7(this._preds[t],e),e7(this._sucs[e],t),delete this._in[t][a],delete this._out[e][a],this._edgeCount--),this}outEdges(e,t){let n=this._out[e];if(n){let a=Object.values(n);return void 0===t?a:a.filter(function(e){return e.w===t})}}};function tr(e){let{referencesMaps:t}=ne(e),n=function(e){let t=new ta;return[...e.entries()].forEach(([e,n])=>{n.forEach(n=>{t.setEdge(e,n)})}),t}(t.referencesIn),a=(function(e){let t=0,n=[],a={},r=[];return e.nodes().forEach(function(i){Object.prototype.hasOwnProperty.call(a,i)||function i(o){let s=a[o]={onStack:!0,lowlink:t,index:t++};if(n.push(o),e.successors(o).forEach(function(e){Object.prototype.hasOwnProperty.call(a,e)?a[e].onStack&&(s.lowlink=Math.min(s.lowlink,a[e].index)):(i(e),s.lowlink=Math.min(s.lowlink,a[e].lowlink))}),s.lowlink===s.index){let l;let u=[];do a[l=n.pop()].onStack=!1,u.push(l);while(o!==l);r.push(u)}}(i)}),r})(n).filter(function(e){return e.length>1||1===e.length&&n.hasEdge(e[0],e[0])}),r=a.map(e=>e.reverse()),i=r.map(e=>(function(e,t){var n;let a=[];for(let r=0;r<t.length;r++){let i;let o=[];for(let s of function*(e){let n=e;for(;;)yield t[n++%t.length]}(r))if(void 0===i)o.push(s),i=s;else if(null==(n=e.get(i))?void 0:n.has(s)){if(o.includes(s)){o.splice(0,o.lastIndexOf(s));break}o.push(s),i=s}a.push(o)}let l=a.reduce((e,t)=>t.length>e.length?e:t);return l})(t.referencesIn,e)),o=r.map((e,t)=>(function(e,t,n){let a=new Set;return t.forEach(r=>{e.outEdges(r).filter(({w:e})=>t.includes(e)).forEach(({v:e,w:t})=>{a.add(`"${e}" -> "${t}"`+(ti(n,e,t)?" [color=red]":""))})}),`digraph Cycle {
	${[...a].join(";\n	")};
}`})(n,e,i[t]));return[i,o]}var ti=(e,t,n)=>{for(let a=0;a<e.length+1;a++)if(t===e[a]&&n===e[(a+1)%e.length])return!0;return!1},to=e=>e.split(" . "),ts=e=>e.join(" . "),tl=e=>{var t;return null==(t=to(e).slice(-1))?void 0:t[0]},tu=e=>null==e?void 0:e.replace(/\s\.\s/g,"/").replace(/-/g,"‑").replace(/\s/g,"-"),tc=e=>e.replace(/\//g," . ").replace(/-/g," ").replace(/\u2011/g,"-"),td=e=>e.endsWith("$SITUATION")?tp(e):e,tp=e=>ts(to(e).slice(0,-1));function tm(e){return to(e).slice(0,-1).map((e,t,n)=>ts(n.slice(0,t+1))).reverse()}var th=(e,t)=>{let n=Object.keys(e).filter(e=>e.startsWith(t)&&to(e).length===to(t).length+1);return n};function tf(e,t){let n=to(e),a=to(t),r=n.findIndex((e,t)=>a[t]!==e);return -1===r?e:ts(n.slice(0,r))}function tb(e,t,n){if(!(n in e))throw new v("InternalError",`La r\xe8gle "${n}" n'existe pas`,{dottedName:n});let a=tf(t,n),r=[n,...tm(n),""],i=r.slice(0,Math.max(r.indexOf(a)-1,0));return i.every(t=>!(t in e)||!1===e[t].private)}function tv(e,t){if(!(t in e))throw new v("InternalError",`La r\xe8gle "${t}" n'existe pas`,{dottedName:t});let n=[t,...tm(t)];return n.some(t=>{var n;return t in e&&(null==(n=e[t].rawNode)?void 0:n.experimental)==="oui"})}function tx(e,t="",n){let a=[t,...tm(t),""].map(e=>e?e+" . "+n:n).sort((e,n)=>e===t?1:n===t?-1:0),r=a.filter(t=>t in e),i=r.find(n=>tb(e,t,n));if(!r.length)throw new v("SyntaxError",`La r\xe9f\xe9rence "${n}" est introuvable.
V\xe9rifiez que l'orthographe et l'espace de nom sont corrects`,{dottedName:td(t)});if(!i)throw new v("SyntaxError",`La r\xe8gle "${r[0]}" n'est pas accessible depuis "${t}".
Cela vient du fait qu'elle est priv\xe9e ou qu'un de ses parent est priv\xe9`,{dottedName:td(t)});return i}function tg(e){return!0!==e.virtualRule&&"groupe"!==e.type&&"texte"!==e.type&&"paragraphe"!==e.type&&"notification"!==e.type}function ty(e,t,n){"reference"===e.nodeKind&&(e6(t.referencesIn,n??e.contextDottedName,e.dottedName),e6(t.rulesThatUse,e.dottedName,n??e.contextDottedName))}function tN(e,t){return"reference"!==e.nodeKind?void 0:(e.dottedName||(e.dottedName=tx(t,e.contextDottedName,e.name),e.title=t[e.dottedName].title,e.acronym=t[e.dottedName].rawNode.acronyme),e)}var tV=0,tw={};function t$(e,t){return e?(Array.isArray(e)?e:[e]).map(e=>{"string"==typeof e&&(e={règle:e});let n=t9(e.règle,t),a=t9(e.par??t.dottedName,t),[r,i]=[e.dans??[],e["sauf dans"]??[]].map(e=>Array.isArray(e)?e:[e]).map(e=>e.map(e=>t9(e,t)));return{nodeKind:"replacementRule",rawNode:e,definitionRule:t9(t.dottedName,t),replacedReference:n,replacementNode:a,whiteListedNames:r,blackListedNames:i,remplacementRuleId:tV++}}):[]}function tE(e,t,n){return w((n,a)=>{if("replacementRule"===n.nodeKind||"inversion"===n.nodeKind||"une possibilit\xe9"===n.nodeKind)return!1;if("recalcul"===n.nodeKind)return h(m({},n),{explanation:h(m({},n.explanation),{recalculNode:a(n.explanation.recalculNode),amendedSituation:n.explanation.amendedSituation.map(([e,t])=>[e,a(t)])})});if("reference"===n.nodeKind){if(!n.dottedName)throw new g(n);let r=function(e,t,n){let a=t.filter(({definitionRule:t})=>t.dottedName!==e.contextDottedName).filter(({whiteListedNames:t})=>!t.length||t.some(t=>e.contextDottedName.startsWith(t.dottedName))).filter(({blackListedNames:t})=>!t.length||t.every(t=>!e.contextDottedName.startsWith(t.dottedName))).sort((e,t)=>{let n=+!!t.whiteListedNames.length-+!!e.whiteListedNames.length,a=+!!t.blackListedNames.length-+!!e.blackListedNames.length;return n||a});if(!a.length)return e;a.length;let r=a.map(e=>e.remplacementRuleId).join("-");return tw[r]??(tw[r]={nodeKind:"variations",sourceMap:{mecanismName:"replacement"},rawNode:e.rawNode,explanation:[...a.map(e=>({condition:e.definitionRule,consequence:e.replacementNode})),{condition:ew(!0),consequence:e}]}),tw[r]}(n,e[n.dottedName]??[],0);return $(e=>(ty(e,t,n.contextDottedName),"continue"))(r),r}})}function tk(e,t){var n,a,r;if(t.private)return{ruleDisabledByItsParent:!1,parentMissingVariables:{}};let i=e.context.nodesTypes,o=t.explanation.parents.find(e=>{var t,n;return(null==(t=i.get(e))?void 0:t.isNullable)||(null==(n=i.get(e))?void 0:n.type)==="boolean"});if(!o)return{ruleDisabledByItsParent:!1,parentMissingVariables:{}};if(!e.cache._meta.parentRuleStack.includes(t.dottedName)){e.cache._meta.parentRuleStack.unshift(t.dottedName);let s=ew(!1);if((null==(n=i.get(o))?void 0:n.isNullable)&&(s=e.evaluateNode({nodeKind:"est non applicable",explanation:o})),!0!==s.nodeValue&&(null==(a=i.get(o))?void 0:a.type)==="boolean"&&(s=e.evaluateNode({nodeKind:"operation",operator:"=",operationKind:"=",explanation:[o,ew(!1)]})),e.cache._meta.parentRuleStack.shift(),!0===s.nodeValue)return{ruleDisabledByItsParent:!0,parentMissingVariables:s.missingVariables??{},nullableParent:o}}let l={};if((null==(r=i.get(o))?void 0:r.type)==="boolean"){let u=e.evaluateNode(o);return l=u.missingVariables??{},{ruleDisabledByItsParent:!1===u.nodeValue,parentMissingVariables:l,nullableParent:o}}return{ruleDisabledByItsParent:!1,parentMissingVariables:l,nullableParent:o}}function tS(e,t){let n=t9(e,t);return{explanation:n,nodeKind:"est non applicable"}}B("rule",function(e){var t,n;let{ruleDisabledByItsParent:a,nullableParent:r,parentMissingVariables:i}=tk(this,e),o=h(m({},e.explanation.valeur),{nodeValue:null,missingVariables:{}});a||(this.cache._meta.evaluationRuleStack.filter(t=>t===e.dottedName).length>1?o={nodeValue:void 0}:(this.cache._meta.evaluationRuleStack.unshift(e.dottedName),o=this.evaluateNode(e.explanation.valeur),this.cache._meta.evaluationRuleStack.shift())),o.missingVariables??(o.missingVariables={}),t=e,n=o,!0!==t.private&&tb(this.context.parsedRules,"",t.dottedName)&&(void 0!==n.nodeValue||Object.keys(n.missingVariables).length||(n.missingVariables[t.dottedName]=1));let s=h(m(h(m({},o),{missingVariables:eN(o.missingVariables,i)}),e),{explanation:{parents:e.explanation.parents,valeur:o,nullableParent:r,ruleDisabledByItsParent:a}});return s}),tS.nom="est non applicable";var tO=e=>({nodeKind:"est non applicable",explanation:e});function tR(e,t,n,a=0,r=100,i=0){let o=t,s=n,l=o,u=e(o),c=e(s),d=u,p,m,h,f,b,v;for(;r-- >0;){if(h=s-o,Math.abs(d)<Math.abs(c)&&(o=s,s=l,l=o,u=c,c=d,d=u),p=1e-15*Math.abs(s)+a/2,Math.abs(m=(l-s)/2)<=p||0===c)return s;if(Math.abs(h)>=p&&Math.abs(u)>Math.abs(c)){let x,g;let y=l-s;o===l?(f=y*(x=c/u),b=1-x):(b=u/d,x=c/d,f=(g=c/u)*(y*b*(b-x)-(s-o)*(x-1)),b=(b-1)*(x-1)*(g-1)),f>0?b=-b:f=-f,f<.75*y*b-Math.abs(p*b)/2&&f<Math.abs(h*b/2)&&(m=f/b)}if(Math.abs(m)<p&&(m=m>0?p:-p),o=s,u=c,s+=m,((c=e(s))>0&&d>0||c<0&&d<0)&&(l=o,d=u),Math.abs(c)<a)return s;Math.abs(c)<i&&(v=s)}return v}B("est non applicable",function(e){var t,n,a,r;let i=e.explanation;if((null==(t=this.context.nodesTypes.get(i))?void 0:t.isNullable)===!1&&"rule"!==i.nodeKind)return h(m({},e),{nodeValue:!1,missingVariables:{}});if(this.cache.nodes.has(i)&&void 0!==this.cache.nodes.get(i))return h(m({},e),{nodeValue:(null==(n=this.cache.nodes.get(i))?void 0:n.nodeValue)===null,missingVariables:(null==(a=this.cache.nodes.get(i))?void 0:a.missingVariables)??{}});switch(i.nodeKind){case"rule":let{ruleDisabledByItsParent:o,parentMissingVariables:s}=tk(this,i);if(o)return h(m({},e),{nodeValue:!0,missingVariables:s});let l=this.evaluateNode(tO(i.explanation.valeur)),u=eN(s,l.missingVariables);return!1===l.nodeValue&&(null==(r=this.context.nodesTypes.get(this.context.parsedRules[`${i.dottedName} . $SITUATION`]))?void 0:r.isNullable)&&!Object.keys(l.missingVariables).length&&(u[i.dottedName]=1),h(m({},e),{nodeValue:l.nodeValue,missingVariables:u});case"reference":if(!i.dottedName)throw new v("InternalError","Missing dottedName",{});return m(m({},this.evaluateNode(tO(this.context.parsedRules[i.dottedName]))),e);case"condition":return m(m({},this.evaluateNode(h(m({},i),{explanation:{si:i.explanation.si,alors:tO(i.explanation.alors),sinon:tO(i.explanation.sinon)}}))),e)}let c=this.evaluateNode(i);return h(m({},e),{nodeValue:void 0===c.nodeValue?void 0:null===c.nodeValue,missingVariables:c.missingVariables})}),B("grille",function(e){var t;let n;let a=this.evaluateNode.bind(this),r=this.evaluateNode(e.explanation.assiette),i=this.evaluateNode(e.explanation.multiplicateur),o=ez.call(this,{parsedTranches:e.explanation.tranches,assiette:r,multiplicateur:i}).map(e=>{if(!1===e.isActive)return e;let t=a(e.montant);return h(m({},e),{montant:t,nodeValue:t.nodeValue,unit:t.unit,missingVariables:eV([t,e])})}),s=o.find(e=>e.isActive);n=s?[s]:!1===o[o.length-1].isAfterActive?[{nodeValue:!1}]:o.filter(e=>void 0===e.isActive);let l=!!n[0]&&(void 0===n[0].isActive?void 0:n[0].nodeValue);return h(m({},e),{nodeValue:l,missingVariables:eV([r,i,...n]),explanation:h(m({},e.explanation),{assiette:r,multiplicateur:i,tranches:o}),unit:(null==(t=n[0])?void 0:t.unit)??void 0})});var tj=(e,t)=>{if(!e.avec)throw new v("SyntaxError","Une formule d'inversion doit pr\xe9ciser _avec_ quoi on peut inverser la variable",{dottedName:t.dottedName});return{explanation:{ruleToInverse:t.dottedName,inversionCandidates:e.avec.map(e=>m({},t9(e,t)))},nodeKind:"inversion"}};B("inversion",function(e){let t,n;let a=this.shallowCopy();if(this.cache._meta.evaluationRuleStack.slice(1).includes(e.explanation.ruleToInverse))return m(m({},eb),e);a.cache._meta.parentRuleStack=[...this.cache._meta.parentRuleStack],a.cache._meta.evaluationRuleStack=[...this.cache._meta.evaluationRuleStack];let r=e.explanation.inversionCandidates.find(e=>{if(this.cache._meta.evaluationRuleStack.includes(e.dottedName))return!1;let t=a.evaluateNode(a.context.parsedRules[`${e.dottedName} . $SITUATION`]);return"number"==typeof t.nodeValue&&!(e.dottedName in t.missingVariables)});if(void 0===r)return h(m({},e),{nodeValue:void 0,missingVariables:h(m({},Object.fromEntries(e.explanation.inversionCandidates.map(e=>[e.dottedName,1]))),{[e.explanation.ruleToInverse]:1})});let i=a.evaluateNode(r),o=0;a.setSituation({[r.dottedName]:eb},{keepPreviousSituation:!0});let s=n=>(o++,a.setSituation({[e.explanation.ruleToInverse]:{nodeValue:n,nodeKind:"constant",type:"number",unit:i.unit}},{keepPreviousSituation:!0}),t=a.evaluateNode(r)),l=i.nodeValue,u=s(l),c=u.nodeValue,d=void 0!==c?l*l*(c>l?.9:1.2)/c:2e3,p=s(d),f=p.nodeValue,b=this.context.inversionMaxIterations??10;if(void 0!==c||void 0!==f){let v=e=>{let t=e===l?c:e===d?f:s(e).nodeValue;return t-l};n=tR(v,void 0!==f&&f<l&&(f>c||c>l)?d:void 0!==c&&c<l&&(c>f||f>l)?l:-1e6,void 0!==f&&f>l&&(f<c||c<l)?d:void 0!==c&&c>l&&(c<f||f<l)?l:1e8,.1,b,1)}return void 0===n&&(this.cache._meta.inversionFail=!0),(t.traversedVariables??[]).forEach(e=>this.cache._meta.traversedVariablesStack[0].add(e)),h(m({},e),{nodeValue:n,unit:i.unit,explanation:h(m({},e.explanation),{inversionGoal:r,numberOfIteration:o}),missingVariables:t.missingVariables})});var t_=ep("le maximum de",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,t)=>({condition:{si:{"est non applicable":"$INTERNAL valeur"},alors:"$INTERNAL acc",sinon:{condition:{si:{ou:[{"est non applicable":"$INTERNAL acc"},{">":["$INTERNAL valeur","$INTERNAL acc"]}]},alors:"$INTERNAL valeur",sinon:"$INTERNAL acc"}}},avec:{"[priv\xe9] $INTERNAL valeur":t,"[priv\xe9] $INTERNAL acc":e}}),eh)),tA=ep("le minimum de",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,t)=>({condition:{si:{"est non applicable":"$INTERNAL valeur"},alors:"$INTERNAL acc",sinon:{condition:{si:{ou:[{"est non applicable":"$INTERNAL acc"},{"<":["$INTERNAL valeur","$INTERNAL acc"]}]},alors:"$INTERNAL valeur",sinon:"$INTERNAL acc"}}},avec:{"[priv\xe9] $INTERNAL valeur":t,"[priv\xe9] $INTERNAL acc":e}}),eh)),tI=ed("non applicable si",{"non applicable si":{},valeur:{}},{condition:{si:"non applicable si = non",alors:"valeur",sinon:eh}}),tT=(e,t)=>(Array.isArray(e)&&(e={possibilités:e}),h(m({},e),{explanation:e.possibilités.map(e=>t9(e,t)),context:t.dottedName,nodeKind:"une possibilit\xe9"}));B("une possibilit\xe9",e=>h(m({},e),{missingVariables:{[e.context]:1},nodeValue:void 0}));var tK={"*":[(e,t)=>e*t,"\xd7"],"/":[(e,t)=>0===t?null:e/t,"∕"],"+":[(e,t)=>e+t],"-":[(e,t)=>e-t,"−"],"<":[(e,t)=>e<t],"<=":[(e,t)=>e<=t,"≤"],">":[(e,t)=>e>t],">=":[(e,t)=>e>=t,"≥"],"=":[(e,t)=>(e??!1)===(t??!1)],"!=":[(e,t)=>(e??!1)!==(t??!1),"≠"],et:[(e,t)=>(e??!1)&&(t??!1)],ou:[(e,t)=>(e??!1)||(t??!1)]},tC=(e,t)=>(n,a)=>{let r=n.map(e=>t9(e,a));return h(m({},n),{nodeKind:"operation",operationKind:e,operator:t||e,explanation:r})};B("operation",function(e){var t;let n=this.evaluateNode(e.explanation[0]),a=h(m({},e),{missingVariables:{}});if(null===n.nodeValue&&["<",">","<=",">=","/","*","-","et"].includes(e.operationKind)||0===n.nodeValue&&["/","*"].includes(e.operationKind)||!1===n.nodeValue&&"et"===e.operationKind||!0===n.nodeValue&&"ou"===e.operationKind)return h(m({},a),{nodeValue:"et"!==e.operationKind&&n.nodeValue,missingVariables:n.missingVariables});let r=this.evaluateNode(e.explanation[1]);if(a.explanation=[n,r],null===r.nodeValue&&["<",">","<=",">=","/","*","et"].includes(e.operationKind)||0===r.nodeValue&&["*"].includes(e.operationKind)||!1===r.nodeValue&&"et"===e.operationKind||!0===r.nodeValue&&"ou"===e.operationKind)return h(m({},a),{nodeValue:"et"!==e.operationKind&&r.nodeValue,missingVariables:r.missingVariables});a.missingVariables=eV([n,r]),(void 0===n.nodeValue||void 0===r.nodeValue)&&(a=h(m({},a),{nodeValue:void 0}));let i=["+","-"].includes(e.operationKind)&&"%"===eS(r.unit)&&"%"!==eS(n.unit);if(!("nodeValue"in a)&&!["/","*"].includes(e.operationKind)&&!i)try{n.unit&&"unit"in r?r=e9(n.unit,r):r.unit&&(n=e9(r.unit,n))}catch(o){N(this.context.logger,`Dans l'expression '${e.operationKind}', la partie gauche (unit\xe9: ${eS(n.unit)}) n'est pas compatible avec la partie droite (unit\xe9: ${eS(r.unit)})`,o)}let s=tK[e.operationKind][0],l=n.nodeValue,u=r.nodeValue;if(a.nodeValue="nodeValue"in a?a.nodeValue:["<",">","<=",">=","*","/"].includes(e.operationKind)&&null===r.nodeValue?null:[l,u].every(e=>{var t;return"string"==typeof e&&(null==(t=e.match)?void 0:t.call(e,/^[\d]{2}\/[\d]{2}\/[\d]{4}$/))})?s(H(l),H(u)):s(l,u),"*"===e.operationKind&&(null==(t=eR("*",[n.unit,r.unit]))?void 0:t.numerators.includes("%"))){let c=eR("*",[n.unit,r.unit]),d=a.nodeValue;return h(m({},a),{nodeValue:"number"==typeof d?d/100:d,unit:eR("*",[c,{numerators:[],denominators:["%"]}])})}if(i){let p=eR("*",[n.unit,r.unit]);return h(m({},a),{nodeValue:"number"==typeof n.nodeValue&&"number"==typeof r.nodeValue?n.nodeValue*(1+r.nodeValue/100*("-"===e.operationKind?-1:1)):a.nodeValue,unit:eR("*",[p,{numerators:[],denominators:["%"]}])})}return"*"===e.operationKind||"/"===e.operationKind||"-"===e.operationKind||"+"===e.operationKind?h(m({},a),{unit:eR(e.operationKind,[n.unit,r.unit])}):a});var tL=Object.fromEntries(Object.entries(tK).map(([e,[t,n]])=>[e,tC(e,n)])),tM=ed("par d\xe9faut",{"par d\xe9faut":{},valeur:{}},{condition:{si:{"est non d\xe9fini":"valeur"},alors:"par d\xe9faut",sinon:"valeur"}}),tD=ed("plafond",{plafond:{},valeur:{}},{condition:{si:{et:["plafond != non","valeur > plafond"]},alors:"plafond",sinon:"valeur"}}),tP=ed("plancher",{plancher:{},valeur:{}},{condition:{si:{et:["plancher != non","valeur < plancher"]},alors:"plancher",sinon:"valeur"}}),tU=ed("produit",{assiette:{},taux:{"par d\xe9faut":"100%"},facteur:{"par d\xe9faut":1},plafond:{"par d\xe9faut":eh}},{"*":[{"*":["taux","facteur"]},{valeur:"assiette",plafond:"plafond"}],"simplifier l'unit\xe9":"oui"}),tq=(e,t)=>{let n=Object.keys(e.avec).map(n=>[t9(n,t),t9(e.avec[n],t)]),a=t9(e.règle??t.dottedName,t);return{explanation:{recalculNode:a,amendedSituation:n},nodeKind:"recalcul"}};function tW(e,t){return{explanation:{ruleToSolve:t.dottedName,valeur:t9(e.valeur,t)},nodeKind:"r\xe9soudre r\xe9f\xe9rence circulaire"}}function tB(e,t){let n=t9(e.valeur,t);return{explanation:n,nodeKind:"simplifier unit\xe9"}}B("recalcul",function(e){if(this.cache._meta.currentRecalcul===e.explanation.recalculNode)return m(m({},eh),e);let t=Object.fromEntries(e.explanation.amendedSituation.filter(([e,t])=>{let n=this.evaluateNode(e),a=this.evaluateNode(t);return n.nodeValue!==a.nodeValue||eS(n.unit)!==eS(a.unit)}).map(([e,t])=>[e.dottedName,t])),n=this;Object.keys(t).length&&((n=this.shallowCopy().setSituation(t,{keepPreviousSituation:!0})).subEngineId=this.subEngines.length,this.subEngines.push(n)),n.cache._meta.currentRecalcul=e.explanation.recalculNode;let a=n.evaluateNode(e.explanation.recalculNode);return delete n.cache._meta.currentRecalcul,m(h(m({},e),{nodeValue:a.nodeValue,explanation:h(m({},e.explanation),{recalcul:a,subEngineId:n.subEngineId}),missingVariables:a.missingVariables}),"unit"in a&&{unit:a.unit})}),tW.nom="r\xe9soudre la r\xe9f\xe9rence circulaire",B("r\xe9soudre r\xe9f\xe9rence circulaire",function(e){if(this.cache._meta.evaluationRuleStack.slice(1).includes(e.explanation.ruleToSolve))return m(m({},eb),e);let t=0,n=this.shallowCopy();n.cache._meta.parentRuleStack=[...this.cache._meta.parentRuleStack],n.cache._meta.evaluationRuleStack=[...this.cache._meta.evaluationRuleStack];let a=this.context.inversionMaxIterations??25,r=a=>(t++,n.setSituation({[e.explanation.ruleToSolve]:h(m({},eb),{nodeValue:a})},{keepPreviousSituation:!0}),n.evaluateNode(e.explanation.valeur)),i=Symbol("inversion failed"),o=i,s=r(1),l=s.nodeValue,u=s.unit,c=0;if(void 0!==l){let d=e=>{if(1===e)return l-1;s=r(e);let t=s.nodeValue;return c++,t-e};o=tR(d,-1e6,1e8,.5,a,2)}return o===i&&(o=void 0,this.cache._meta.inversionFail=!0),void 0!==o&&(s=r(o)),h(m({},e),{unit:u,nodeValue:o,explanation:h(m({},e.explanation),{valeur:s,numberOfIterations:t}),missingVariables:s.missingVariables})}),tB.nom="simplifier l'unit\xe9",B("simplifier unit\xe9",function(e){let t=this.evaluateNode(e.explanation),n=t.nodeValue,a=h(m(m({},t),e),{explanation:t});if(null==n)return a;if(!t.unit)return h(m({},a),{unit:t.unit});let r=eP(t.unit);return h(m({},a),{nodeValue:"number"==typeof n?eC(t.unit,r,n):n,unit:r})});var tF=ed("dans la situation",{valeur:{},"dans la situation":{}},{condition:{si:{"est non d\xe9fini":"dans la situation"},alors:"valeur",sinon:"dans la situation"}}),tz=ep("somme",{valeur:{type:"liste"}},({valeur:e})=>[...e].reverse().reduce((e,t)=>({"+":[t,e]}),eh));B("taux progressif",function(e){let t=this.evaluateNode.bind(this),n=this.evaluateNode(e.explanation.assiette),a=this.evaluateNode(e.explanation.multiplicateur),r=ez.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:a}),i=h(m({},e),{explanation:{tranches:r,assiette:n,multiplicateur:a},unit:eE("%")}),o=r[r.length-1];if(r.every(({isActive:e})=>!1===e)||o.isActive&&o.plafond.nodeValue===1/0){let s=e9(eE("%"),t(o.taux)),{nodeValue:l,missingVariables:u}=s;return o.taux=s,o.nodeValue=l,o.missingVariables=u,h(m({},i),{nodeValue:l,missingVariables:u})}if(r.every(({isActive:e})=>!0!==e)||"number"!=typeof n.nodeValue)return h(m({},i),{nodeValue:void 0,missingVariables:eV(r)});let c=r.findIndex(({isActive:e})=>!0===e),d=r[c];d.taux=e9(eE("%"),t(d.taux));let p=r[c-1];p&&(p.taux=e9(eE("%"),t(p.taux)),p.isActive=!0);let f=p?p.taux:d.taux,b=[f,d.taux];if(b.some(e=>void 0===e.nodeValue))return d.nodeValue=void 0,h(m({},i),{nodeValue:void 0,missingVariables:eV(b)});let v=f.nodeValue,x=d.taux.nodeValue,g=d.plancherValue,y=d.plafondValue,N=v+(n.nodeValue-g)*((x-v)/(y-g));return d.nodeValue=N,h(m({},i),{nodeValue:N,missingVariables:{}})});var tJ="texte";function tG(e,t){let n=[],a=0;for(let{0:r,index:i}of e.matchAll(/{{(.|\n)*?}}/g)){let o=r.slice(2,-2).trim(),s=t9(o,t);n.push(e.substring(a,i),s),a=(i??0)+r.length}return n.push(e.slice(a)),{nodeKind:tJ,explanation:n}}tG.nom=tJ,B(tJ,function(e){let t=e.explanation.map(e=>"string"==typeof e?e:this.evaluateNode(e));return h(m({},e),{explanation:t,missingVariables:eV(e.explanation.filter(e=>"string"!=typeof e)),nodeValue:t.map(e=>"string"==typeof e?e:function(e,{language:t="fr",displayedUnit:n,formatUnit:a,precision:r=2}={}){let i="number"==typeof e||null==e?e:e.nodeValue;if("number"==typeof i&&Number.isNaN(i))return"Erreur dans le calcul du nombre";if(void 0===i)return"Pas encore d\xe9fini";if(null===i)return"Non applicable";if("string"==typeof i)return i.replace("\\n","\n");if("object"==typeof i)return i.nom;if("boolean"==typeof i)return e8[t][i];if("number"==typeof i){let o="number"!=typeof e&&void 0!==e&&"unit"in e?e.unit:void 0;if(o){let s=e1({unit:o,nodeValue:i});o=s.unit,i=s.nodeValue}return(function({maximumFractionDigits:e,minimumFractionDigits:t,language:n,formatUnit:a,unit:r,nodeValue:i}){if("number"!=typeof i)return i;let o=r?eS(r,i,a):void 0;switch(o){case"€":return e2({style:"currency",maximumFractionDigits:e,minimumFractionDigits:t,language:n})(i);case"%":return e2({style:"percent",maximumFractionDigits:e,language:n})(i/100);default:return e2({style:"decimal",minimumFractionDigits:t,maximumFractionDigits:e,language:n})(i)+("string"==typeof o?`\xa0${o}`:"")}})({minimumFractionDigits:0,maximumFractionDigits:r,language:t,formatUnit:a,nodeValue:i,unit:n??o}).trim()}}(e)).join("")})});var tH=ep("toutes ces conditions",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,t)=>({et:[e,t]}),"oui")),tZ=ep("une de ces conditions",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,t)=>({ou:[e,t]}),"non"));function tY(e,t){let n=t9(e.valeur,t),a=eE(e.unité,t.getUnitKey);return{explanation:n,unit:a,nodeKind:tY.nom}}function tQ(e,t){return{missingVariable:e["variable manquante"],nodeKind:tQ.nom,explanation:t9(e.valeur,t)}}tY.nom="unit\xe9",B(tY.nom,function(e){let t=this.evaluateNode(e.explanation),n=t.nodeValue;if(null!==n&&"unit"in e)try{n=eC(t.unit,e.unit,t.nodeValue)}catch(a){N(this.context.logger,"Erreur lors de la conversion d'unit\xe9 explicite",{dottedName:this.cache._meta.evaluationRuleStack[0]},a)}return h(m({},e),{nodeValue:n,explanation:t,missingVariables:t.missingVariables})}),tQ.nom="variable manquante",B(tQ.nom,function(e){let t=this.evaluateNode(e.explanation),n=Object.values(t.missingVariables).reduce((e,t)=>e>t?e:t,0);return h(m(m({},t),e),{explanation:t,missingVariables:eN(t.missingVariables,{[e.missingVariable]:n+1})})});var tX=(e,t,n)=>{if("valeur"===e)return t9(t,n);let{variations:a}=t,r=b(t,["variations"]),i=t9({variations:a.map(({alors:t,sinon:n,si:a})=>{let i=t??n,{attributs:o}=i,s=b(i,["attributs"]);return m({[void 0!==t?"alors":"sinon"]:h(m({},o),{[e]:m(m({},r),s)})},void 0!==a&&{si:a})})},n);return i};B("variations",function(e){let[t,n,a]=e.explanation.reduce(([e,t,n,a],{condition:r,consequence:i},o)=>{let s;if(!0===a)return[e,[...t,{condition:r,consequence:i}],n,a];let l=this.evaluateNode(r),u=void 0===a?a:!a&&(void 0===l.nodeValue?void 0:!1!==l.nodeValue&&null!==l.nodeValue);if(!1===u||null===u)return[e,[...t,{condition:l,consequence:i}],n,a];if(!1!==l.nodeValue&&null!==l.nodeValue&&(s=this.evaluateNode(i),n))try{s=e9(n,s)}catch(c){N(this.context.logger,`L'unit\xe9 de la branche n\xb0 ${o+1} du m\xe9canisme 'variations' n'est pas compatible avec celle d'une branche pr\xe9c\xe9dente`,{dottedName:this.cache._meta.evaluationRuleStack[0]},c)}return[u&&(null==s?void 0:s.nodeValue),[...t,{condition:l,consequence:s??i}],n||(null==s?void 0:s.unit),a||u]},[null,[],void 0,!1]);return h(m(h(m({},e),{nodeValue:t}),void 0!==a&&{unit:a}),{explanation:n,missingVariables:n.reduce((e,{condition:t,consequence:n})=>eN(e,eN(ey(t.missingVariables),"nodeValue"in t&&!1!==t.nodeValue&&null!==t.nodeValue?n.missingVariables:{})),{})})}),B("reference",function(e){if(!e.dottedName)throw new g(e);let t=this.evaluateNode(this.context.parsedRules[e.dottedName]);return delete t.sourceMap,m(m({},t),e)});var{Grammar:t0,Parser:t1}=r;function t9(e,t){if(void 0==e)throw new v("SyntaxError",`
	Une des valeurs de la formule est vide.
	V\xe9rifiez que tous les champs \xe0 droite des deux points sont remplis`,{dottedName:t.dottedName});if("boolean"==typeof e)throw new v("SyntaxError",`
Les valeurs bool\xe9ennes true / false ne sont accept\xe9es.
Utilisez leur contrepartie fran\xe7aise : 'oui' / 'non'`,{dottedName:t.dottedName});let n="object"==typeof e?e:function(e,t){let n=(e+"").replace(/\s*\n\s*/g," ").trim();try{let[a]=new t1(t2).feed(n).results;if(null==a)throw new g({expression:n,parseResult:`${JSON.stringify(a)}`,notice:"L'erreur se situe tr\xe8s probablement dans le fichier `nearley.ne`"});return a}catch(r){if(r instanceof g)throw r;throw new v("SyntaxError",`\`${n}\` n'est pas une expression valide`,{dottedName:t.dottedName},r)}}(e,t);return"nodeKind"in n?n:"nom"in n?function(e,t){var n;let a=!!("oui"===e.privé||e.nom.startsWith("[priv\xe9] ")),r=e.nom.replace(/^\[privé\] /,""),i=[t.dottedName,r].filter(Boolean).join(" . "),o=tl(i),s=(n=e.titre??o)&&n[0].toUpperCase()+n.slice(1);if(t.parsedRules[i])throw new v("EvaluationError",`La r\xe9f\xe9rence '${i}' a d\xe9j\xe0 \xe9t\xe9 d\xe9finie`,{dottedName:i});let l=m(m({},Object.fromEntries(Object.entries(e).filter(([e])=>t5.includes(e)))),"formule"in e&&{valeur:e.formule});a||i.endsWith("$SITUATION")||(l["dans la situation"]=`${i} . $SITUATION`,l.avec=h(m({},l.avec??{}),{"[priv\xe9] $SITUATION":h(m({},ef),{isNullable:"oui"===e["possiblement non applicable"]})}),null!=l["par d\xe9faut"]&&(l["par d\xe9faut"]={valeur:l["par d\xe9faut"],"variable manquante":i}));let u=h(m({},t),{dottedName:i});t.parsedRules[i]=void 0;let c={valeur:t9(l,u),parents:tm(i).map(e=>t9(e,u)).map(e=>h(m({},e),{dottedName:e.name}))};return t.parsedRules[i]={dottedName:i,replacements:[...t$(e["rend non applicable"],u).map(e=>h(m({},e),{replacementNode:eh})),...t$(e.remplace,u)],title:s,private:a,suggestions:Object.fromEntries(Object.entries(e.suggestions??{}).map(([e,t])=>[e,t9(t,u)])),nodeKind:"rule",explanation:c,rawNode:e,virtualRule:!!t.dottedName},t.dottedName?t9(r,t):t.parsedRules[i]}(n,t):h(m({},function(e,t){var n;let a=t6.find(t=>t.nom in e);if(!a)return t8(e,t);let{[n=a.nom]:r}=e,i=b(e,[f(n)]);return t8({[a.nom]:{valeur:i,[a.nom]:r}},t)}(n,t)),{rawNode:e})}var t2=t0.fromCompiled({Lexer:es,ParserRules:ec,ParserStart:"main"});function t8(e,t){if(Array.isArray(e))throw new v("SyntaxError",`
Il manque le nom du m\xe9canisme pour le tableau : [${e.map(e=>`'${e}'`).join(", ")}]
Les m\xe9canisme possibles sont : 'somme', 'le maximum de', 'le minimum de', 'toutes ces conditions', 'une de ces conditions'.
		`,{dottedName:t.dottedName});let n=Object.keys(e);if(n.length>1)throw new v("SyntaxError",`
Les m\xe9canismes suivants se situent au m\xeame niveau : ${n.map(e=>`'${e}'`).join(", ")}
Cela vient probablement d'une erreur dans l'indentation
	`,{dottedName:t.dottedName});if(0===n.length)return{nodeKind:"constant",nodeValue:void 0};let a=Object.keys(e)[0],r=e[a],i=t3[a];if(!i)throw new v("SyntaxError",`Le m\xe9canisme "${a}" est inconnu.

V\xe9rifiez qu'il n'y ait pas d'erreur dans l'orthographe du nom.`,{dottedName:t.dottedName});try{if(null==r?void 0:r.composantes)return eJ(a,r,t);if((null==r?void 0:r.variations)&&Object.values(r).length>1)return tX(a,r,t);return i(r,t)}catch(o){if(o instanceof v)throw o;throw new v("SyntaxError",a?`\u27A1\uFE0F Dans le m\xe9canisme ${a}
${o.message}`:o.message,{dottedName:t.dottedName})}}var t6=[tQ,eB,ex,tI,eW,tY,tB,tP,tD,tM,tF,tW,ev],t3=h(m(m({},tL),t6.reduce((e,t)=>m({[t.nom]:t},e),{})),{"inversion num\xe9rique":tj,"le maximum de":t_,"le minimum de":tA,"taux progressif":function(e,t){let n={assiette:t9(e.assiette,t),multiplicateur:e.multiplicateur?t9(e.multiplicateur,t):ew(1),tranches:eF(e.tranches,t)};return{explanation:n,nodeKind:"taux progressif"}},"toutes ces conditions":tH,"est non d\xe9fini":eQ,"est non applicable":tS,"est applicable":e0,"est d\xe9fini":eX,"une de ces conditions":tZ,"une possibilit\xe9":tT,condition:eG,barème:function(e,t){let n={assiette:t9(e.assiette,t),multiplicateur:e.multiplicateur?t9(e.multiplicateur,t):ew(1),tranches:eF(e.tranches,t)};return{explanation:n,nodeKind:"bar\xe8me"}},durée:eY,grille:function(e,t){let n={assiette:t9(e.assiette,t),multiplicateur:e.multiplicateur?t9(e.multiplicateur,t):ew(1),tranches:eF(e.tranches,t)};return{explanation:n,nodeKind:"grille"}},multiplication:tU,produit:tU,recalcul:tq,somme:tz,[tG.nom]:tG,valeur:t9,variable:function(e,t){if(!t.dottedName)throw new g({message:"Une r\xe9f\xe9rence ne peut pas exister en dehors d'une r\xe8gle (`context.dottedName` est vide)",context:t});return{nodeKind:"reference",name:e,contextDottedName:t.dottedName}},variations:function(e,t){let n=e.map(({si:e,alors:n,sinon:a})=>void 0!==a?{consequence:t9(a,t),condition:ew(!0)}:{consequence:t9(n,t),condition:t9(e,t)});return{explanation:n,nodeKind:"variations"}},constant:e=>({type:e.type,fullPrecision:!0,isNullable:null==e.nodeValue,missingVariables:{},nodeValue:e.nodeValue,nodeKind:"constant"})}),t5=Object.keys(t3);function t4(e){return m({dottedName:"",logger:console,getUnitKey:e=>e,parsedRules:{},referencesMaps:{referencesIn:new Map,rulesThatUse:new Map},nodesTypes:new WeakMap,rulesReplacements:{}},e)}function t7(e){return h(m({},e),{parsedRules:m({},e.parsedRules),referencesMaps:{referencesIn:new Map(e.referencesMaps.referencesIn),rulesThatUse:new Map(e.referencesMaps.rulesThatUse)}})}function ne(e,t=t4({})){let n;if("string"==typeof e)throw new v("EngineError","Publicodes does not parse yaml rule sets itself anymore. Please provide a parsed js object. E.g. the `eemeli/yaml` package.",{});let a=m({},e),r=t4(t),i=r.parsedRules;r.parsedRules={},Object.entries(a).forEach(([e,t])=>{if(("string"==typeof t||"number"==typeof t)&&(t={valeur:`${t}`}),"object"!=typeof t)throw new v("SyntaxError",`Rule ${e} is incorrectly written. Please give it a proper value.`,{dottedName:e});t9(m({nom:e},t),r)});let o=Object.assign(i,r.parsedRules),[s,l]=function(e,t,n){var a;let r=w(t=>tN(t,e)),i=w(t=>{let a=tN(t,e);return a&&ty(a,n),a}),o=(a=e=>"replacementRule"===e.nodeKind?r(e):i(e),Object.fromEntries(Object.entries(t).map(([e,t])=>[e,a(t)])));return[o,n]}(o,r.parsedRules,r.referencesMaps);[o,n]=function({newRules:e,previousReplacements:t,parsedRules:n,referencesMaps:a,logger:r}){let i=Object.values(e).flatMap(e=>e.replacements).reduce((e,t)=>{if(!t.replacedReference.dottedName)throw new g(t);let n=t.replacedReference.dottedName;return h(m({},e),{[n]:[...e[n]??[],t]})},{}),o=Object.keys(i).reduce((e,t)=>((a.rulesThatUse.get(t)??[]).forEach(t=>e.add(t)),e),new Set([])),s=new Set(Object.keys(e).filter(e=>[...a.referencesIn.get(e)??new Set].some(e=>(t[e]??[]).length))),l=Object.entries(i).reduce((e,[t,n])=>h(m({},e),{[t]:[...e[t]??[],...n]}),t);if(!s.size&&!o.size)return[n,l];let u=tE(t,a,r),c=tE(i,a,r);return s.forEach(e=>{n[e]=u(n[e])}),o.forEach(e=>{n[e]=c(n[e])}),[n,l]}({parsedRules:o,newRules:s,referencesMaps:l,previousReplacements:r.rulesReplacements,logger:r.logger});let u=function(e,t,n){function a(e){if(!e||"object"!=typeof e)return F;if(n.has(e))return n.get(e);n.set(e,F);let r=function(e){switch(e.nodeKind){case"bar\xe8me":case"dur\xe9e":case"grille":case"taux progressif":case"inversion":case"recalcul":case"replacementRule":case"r\xe9soudre r\xe9f\xe9rence circulaire":return{isNullable:!1,type:"number"};case"est non d\xe9fini":case"est non applicable":return{isNullable:!1,type:"boolean"};case"constant":return{isNullable:e.isNullable??null===e.nodeValue,type:e.type};case"operation":return{isNullable:["<","<=",">",">=","/","*"].includes(e.operationKind)?a(e.explanation[0]).isNullable||a(e.explanation[1]).isNullable:"-"===e.operationKind&&a(e.explanation[0]).isNullable,type:["<","<=",">",">=","=","!=","et","ou"].includes(e.operationKind)?"boolean":"number"};case"texte":case"une possibilit\xe9":return{isNullable:!1,type:"string"};case"rule":case"arrondi":return a(e.explanation.valeur);case"unit\xe9":case"simplifier unit\xe9":case"variable manquante":return a(e.explanation);case"condition":return{isNullable:[e.explanation.si,e.explanation.alors,e.explanation.sinon].some(e=>a(e).isNullable),type:a(e.explanation.alors).type??a(e.explanation.sinon).type};case"variations":let n=e.explanation.map(({consequence:e})=>a(e));return{isNullable:n.some(e=>e.isNullable),type:n.map(e=>e.type).find(e=>void 0!==e)};case"reference":return a(t[e.dottedName])}}(e);return n.set(e,r),r}return e.forEach(e=>{let n=t[e];a(n),n.explanation.parents.forEach(a)}),n}(Object.keys(s),o,r.nodesTypes);return{parsedRules:o,nodesTypes:u,referencesMaps:l,rulesReplacements:n}}var nt=()=>({_meta:{evaluationRuleStack:[],parentRuleStack:[],traversedVariablesStack:[]},nodes:new Map}),nn=class{baseContext;context;publicParsedRules;cache=nt();subEngines=[];subEngineId;constructor(e={},t={}){let n=m({dottedName:""},t);this.baseContext=t4(m(m({},n),ne(e,n))),this.context=this.baseContext,this.publicParsedRules=Object.fromEntries(Object.entries(this.baseContext.parsedRules).filter(([e,t])=>!t.private&&tb(this.baseContext.parsedRules,"",e)))}resetCache(){this.cache=nt()}setSituation(e={},t={}){this.resetCache();let n=t.keepPreviousSituation??!1;Object.keys(e).forEach(e=>{if(!(e in this.baseContext.parsedRules))throw new v("EvaluationError",`Erreur lors de la mise \xe0 jour de la situation : ${e} n'existe pas dans la base de r\xe8gle.`,{dottedName:e});if(this.baseContext.parsedRules[e].private)throw new v("EvaluationError",`Erreur lors de la mise \xe0 jour de la situation : ${e} est une r\xe8gle priv\xe9e (il n'est pas possible de modifier une r\xe8gle priv\xe9e).`,{dottedName:e})});let a=Object.fromEntries(Object.entries(e).map(([e,t])=>[`[priv\xe9] ${e} . $SITUATION`,t&&"object"==typeof t&&"nodeKind"in t?{valeur:t}:t])),r=t7(this.baseContext);try{this.context=m(m({},this.baseContext),ne(a,n?this.context:this.baseContext))}catch(i){throw this.baseContext=r,i}return this.baseContext=r,Object.keys(e).forEach(e=>{tv(this.context.parsedRules,e)&&V(this.baseContext.logger,e),this.checkExperimentalRule(this.context.parsedRules[`${e} . $SITUATION`])}),this}inversionFail(){return!!this.cache._meta.inversionFail}getRule(e){if(!(e in this.baseContext.parsedRules))throw new v("UnknownRule",`La r\xe8gle '${e}' n'existe pas`,{dottedName:e});if(!(e in this.publicParsedRules))throw new v("PrivateRule",`La r\xe8gle ${e} est une r\xe8gle priv\xe9e.`,{dottedName:e});return this.publicParsedRules[e]}getParsedRules(){return this.publicParsedRules}evaluate(e){let t=this.cache.nodes.get(e);if(t)return t;this.context=m(m({},this.context),ne({"[priv\xe9] $EVALUATION":e&&"object"==typeof e&&"nodeKind"in e?{valeur:e}:e},this.context)),this.checkExperimentalRule(this.context.parsedRules.$EVALUATION),this.cache._meta=nt()._meta;let n=this.evaluateNode(this.context.parsedRules.$EVALUATION.explanation.valeur);return this.cache.nodes.set(e,n),n}evaluateNode(e){var t;let n=this.cache.nodes.get(e);if(void 0!==n)return null==(t=n.traversedVariables)||t.forEach(e=>{var t;return null==(t=this.cache._meta.traversedVariablesStack[0])?void 0:t.add(e)}),n;if(!W[e.nodeKind])throw new v("EvaluationError",`Unknown "nodeKind": ${e.nodeKind}`,{dottedName:""});let a=0===this.cache._meta.traversedVariablesStack.length||"rule"===e.nodeKind;a&&this.cache._meta.traversedVariablesStack.unshift(new Set),"reference"===e.nodeKind&&e.dottedName&&e.dottedName in this.publicParsedRules&&this.cache._meta.traversedVariablesStack[0].add(e.dottedName);let r=W[e.nodeKind].call(this,e);return a&&(r.traversedVariables=Array.from(this.cache._meta.traversedVariablesStack.shift()??[]),this.cache._meta.traversedVariablesStack.length>0&&r.traversedVariables.forEach(e=>{this.cache._meta.traversedVariablesStack[0].add(e)})),this.cache.nodes.set(e,r),r}shallowCopy(){let e=new nn;return e.baseContext=t7(this.baseContext),e.context=t7(this.context),e.publicParsedRules=this.publicParsedRules,e.cache=h(m({},nt()),{nodes:new Map(this.cache.nodes)}),e}checkExperimentalRule=$(e=>("reference"===e.nodeKind&&tv(this.context.parsedRules,e.dottedName)&&V(this.baseContext.logger,e.dottedName),"continue"))}}}]);