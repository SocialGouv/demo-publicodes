(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[661],{42569:function(e,t){var n,a;void 0!==(a="function"==typeof(n=function(){"use strict";var e=Object.prototype.hasOwnProperty,t=Object.prototype.toString,n="boolean"==typeof RegExp().sticky;function isRegExp(e){return e&&"[object RegExp]"===t.call(e)}function isObject(e){return e&&"object"==typeof e&&!isRegExp(e)&&!Array.isArray(e)}function reUnion(e){return e.length?"(?:"+e.map(function(e){return"(?:"+e+")"}).join("|")+")":"(?!)"}function regexpOrLiteral(e){if("string"==typeof e)return"(?:"+e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")";if(isRegExp(e)){if(e.ignoreCase)throw Error("RegExp /i flag not allowed");if(e.global)throw Error("RegExp /g flag is implied");if(e.sticky)throw Error("RegExp /y flag is implied");if(e.multiline)throw Error("RegExp /m flag is implied");return e.source}throw Error("Not a pattern: "+e)}function pad(e,t){return e.length>t?e:Array(t-e.length+1).join(" ")+e}function ruleOptions(t,n){if(isObject(n)||(n={match:n}),n.include)throw Error("Matching rules cannot also include states");var a={defaultType:t,lineBreaks:!!n.error||!!n.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var r in n)e.call(n,r)&&(a[r]=n[r]);if("string"==typeof a.type&&t!==a.type)throw Error("Type transform cannot be a string (type '"+a.type+"' for token '"+t+"')");var s=a.match;return a.match=Array.isArray(s)?s:s?[s]:[],a.match.sort(function(e,t){return isRegExp(e)&&isRegExp(t)?0:isRegExp(t)?-1:isRegExp(e)?1:t.length-e.length}),a}function toRules(e){return Array.isArray(e)?function(e){for(var t=[],n=0;n<e.length;n++){var a=e[n];if(a.include){for(var r=[].concat(a.include),s=0;s<r.length;s++)t.push({include:r[s]});continue}if(!a.type)throw Error("Rule has no type: "+JSON.stringify(a));t.push(ruleOptions(a.type,a))}return t}(e):function(e){for(var t=Object.getOwnPropertyNames(e),n=[],a=0;a<t.length;a++){var r=t[a],s=[].concat(e[r]);if("include"===r){for(var i=0;i<s.length;i++)n.push({include:s[i]});continue}var o=[];s.forEach(function(e){isObject(e)?(o.length&&n.push(ruleOptions(r,o)),n.push(ruleOptions(r,e)),o=[]):o.push(e)}),o.length&&n.push(ruleOptions(r,o))}return n}(e)}var a=ruleOptions("error",{lineBreaks:!0,shouldThrow:!0});function compileRules(e,t){for(var r=null,s=Object.create(null),i=!0,o=null,l=[],u=[],d=0;d<e.length;d++)e[d].fallback&&(i=!1);for(var d=0;d<e.length;d++){var p=e[d];if(p.include)throw Error("Inheritance is not allowed in stateless lexers");if(p.error||p.fallback){if(r){if(!p.fallback==!r.fallback)throw Error("Multiple "+(p.fallback?"fallback":"error")+" rules not allowed (for token '"+p.defaultType+"')");throw Error("fallback and error are mutually exclusive (for token '"+p.defaultType+"')")}r=p}var c=p.match.slice();if(i)for(;c.length&&"string"==typeof c[0]&&1===c[0].length;)s[c.shift().charCodeAt(0)]=p;if(p.pop||p.push||p.next){if(!t)throw Error("State-switching options are not allowed in stateless lexers (for token '"+p.defaultType+"')");if(p.fallback)throw Error("State-switching options are not allowed on fallback tokens (for token '"+p.defaultType+"')")}if(0!==c.length){i=!1,l.push(p);for(var m=0;m<c.length;m++){var f=c[m];if(isRegExp(f)){if(null===o)o=f.unicode;else if(o!==f.unicode&&!1===p.fallback)throw Error("If one rule is /u then all must be")}}var h=reUnion(c.map(regexpOrLiteral)),v=new RegExp(h);if(v.test(""))throw Error("RegExp matches empty string: "+v);if(RegExp("|"+h).exec("").length-1>0)throw Error("RegExp has capture groups: "+v+"\nUse (?: … ) instead");if(!p.lineBreaks&&v.test("\n"))throw Error("Rule should declare lineBreaks: "+v);u.push("("+h+")")}}var b=r&&r.fallback,x=n&&!b?"ym":"gm";return!0===o&&(x+="u"),{regexp:new RegExp(reUnion(u)+(n||b?"":"|"),x),groups:l,fast:s,error:r||a}}function checkStateGroup(e,t,n){var a=e&&(e.push||e.next);if(a&&!n[a])throw Error("Missing state '"+a+"' (in token '"+e.defaultType+"' of state '"+t+"')");if(e&&e.pop&&1!=+e.pop)throw Error("pop must be 1 (in token '"+e.defaultType+"' of state '"+t+"')")}var Lexer=function(e,t){this.startState=t,this.states=e,this.buffer="",this.stack=[],this.reset()};Lexer.prototype.reset=function(e,t){return this.buffer=e||"",this.index=0,this.line=t?t.line:1,this.col=t?t.col:1,this.queuedToken=t?t.queuedToken:null,this.queuedText=t?t.queuedText:"",this.queuedThrow=t?t.queuedThrow:null,this.setState(t?t.state:this.startState),this.stack=t&&t.stack?t.stack.slice():[],this},Lexer.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},Lexer.prototype.setState=function(e){if(e&&this.state!==e){this.state=e;var t=this.states[e];this.groups=t.groups,this.error=t.error,this.re=t.regexp,this.fast=t.fast}},Lexer.prototype.popState=function(){this.setState(this.stack.pop())},Lexer.prototype.pushState=function(e){this.stack.push(this.state),this.setState(e)};var r=n?function(e,t){return e.exec(t)}:function(e,t){var n=e.exec(t);return 0===n[0].length?null:n};function tokenToString(){return this.value}if(Lexer.prototype._getGroup=function(e){for(var t=this.groups.length,n=0;n<t;n++)if(void 0!==e[n+1])return this.groups[n];throw Error("Cannot find token type for matched text")},Lexer.prototype.next=function(){var e=this.index;if(this.queuedGroup){var t=this._token(this.queuedGroup,this.queuedText,e);return this.queuedGroup=null,this.queuedText="",t}var n=this.buffer;if(e!==n.length){var a=this.fast[n.charCodeAt(e)];if(a)return this._token(a,n.charAt(e),e);var s=this.re;s.lastIndex=e;var i=r(s,n),o=this.error;if(null==i)return this._token(o,n.slice(e,n.length),e);var a=this._getGroup(i),l=i[0];return o.fallback&&i.index!==e?(this.queuedGroup=a,this.queuedText=l,this._token(o,n.slice(e,i.index),e)):this._token(a,l,e)}},Lexer.prototype._token=function(e,t,n){var a=0;if(e.lineBreaks){var r=/\n/g,s=1;if("\n"===t)a=1;else for(;r.exec(t);)a++,s=r.lastIndex}var i={type:"function"==typeof e.type&&e.type(t)||e.defaultType,value:"function"==typeof e.value?e.value(t):t,text:t,toString:tokenToString,offset:n,lineBreaks:a,line:this.line,col:this.col},o=t.length;if(this.index+=o,this.line+=a,0!==a?this.col=o-s+1:this.col+=o,e.shouldThrow)throw Error(this.formatError(i,"invalid syntax"));return e.pop?this.popState():e.push?this.pushState(e.push):e.next&&this.setState(e.next),i},"undefined"!=typeof Symbol&&Symbol.iterator){var LexerIterator=function(e){this.lexer=e};LexerIterator.prototype.next=function(){var e=this.lexer.next();return{value:e,done:!e}},LexerIterator.prototype[Symbol.iterator]=function(){return this},Lexer.prototype[Symbol.iterator]=function(){return new LexerIterator(this)}}return Lexer.prototype.formatError=function(e,t){if(null==e)var n=this.buffer.slice(this.index),e={text:n,offset:this.index,lineBreaks:-1===n.indexOf("\n")?0:1,line:this.line,col:this.col};var a=Math.max(e.line-2,1),r=String(e.line+2).length,s=(function(e,t){for(var n=e.length,a=0;;){var r=e.lastIndexOf("\n",n-1);if(-1===r||(a++,n=r,a===t||0===n))break}var s=a<t?0:n+1;return e.substring(s).split("\n")})(this.buffer,this.line-e.line+2+1).slice(0,5),i=[];i.push(t+" at line "+e.line+" col "+e.col+":"),i.push("");for(var o=0;o<s.length;o++){var l=s[o],u=a+o;i.push(pad(String(u),r)+"  "+l),u===e.line&&i.push(pad("",r+e.col+1)+"^")}return i.join("\n")},Lexer.prototype.clone=function(){return new Lexer(this.states,this.state)},Lexer.prototype.has=function(e){return!0},{compile:function(e){var t=compileRules(toRules(e));return new Lexer({start:t},"start")},states:function(e,t){var n=e.$all?toRules(e.$all):[];delete e.$all;var a=Object.getOwnPropertyNames(e);t||(t=a[0]);for(var r=Object.create(null),s=0;s<a.length;s++){var i=a[s];r[i]=toRules(e[i]).concat(n)}for(var s=0;s<a.length;s++)for(var i=a[s],o=r[i],l=Object.create(null),u=0;u<o.length;u++){var d=o[u];if(d.include){var p=[u,1];if(d.include!==i&&!l[d.include]){l[d.include]=!0;var c=r[d.include];if(!c)throw Error("Cannot include nonexistent state '"+d.include+"' (in state '"+i+"')");for(var m=0;m<c.length;m++){var f=c[m];-1===o.indexOf(f)&&p.push(f)}}o.splice.apply(o,p),u--}}for(var h=Object.create(null),s=0;s<a.length;s++){var i=a[s];h[i]=compileRules(r[i],!0)}for(var s=0;s<a.length;s++){for(var v=a[s],b=h[v],x=b.groups,u=0;u<x.length;u++)checkStateGroup(x[u],v,h);for(var _=Object.getOwnPropertyNames(b.fast),u=0;u<_.length;u++)checkStateGroup(b.fast[_[u]],v,h)}return new Lexer(h,t)},error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:function(e){for(var t="undefined"!=typeof Map,n=t?new Map:Object.create(null),a=Object.getOwnPropertyNames(e),r=0;r<a.length;r++){var s=a[r],i=e[s];(Array.isArray(i)?i:[i]).forEach(function(e){if("string"!=typeof e)throw Error("keyword must be string (in keyword '"+s+"')");t?n.set(e,s):n[e]=s})}return function(e){return t?n.get(e):n[e]}}}})?n.apply(t,[]):n)&&(e.exports=a)},43614:function(e){var t;t=function(){function Rule(e,t,n){return this.id=++Rule.highestId,this.name=e,this.symbols=t,this.postprocess=n,this}function State(e,t,n,a){this.rule=e,this.dot=t,this.reference=n,this.data=[],this.wantedBy=a,this.isComplete=this.dot===e.symbols.length}function Column(e,t){this.grammar=e,this.index=t,this.states=[],this.wants={},this.scannable=[],this.completed={}}function Grammar(e,t){this.rules=e,this.start=t||this.rules[0].name;var n=this.byName={};this.rules.forEach(function(e){n.hasOwnProperty(e.name)||(n[e.name]=[]),n[e.name].push(e)})}function StreamLexer(){this.reset("")}function Parser(e,t,n){if(e instanceof Grammar)var a=e,n=t;else var a=Grammar.fromCompiled(e,t);for(var r in this.grammar=a,this.options={keepHistory:!1,lexer:a.lexer||new StreamLexer},n||{})this.options[r]=n[r];this.lexer=this.options.lexer,this.lexerState=void 0;var s=new Column(a,0);this.table=[s],s.wants[a.start]=[],s.predict(a.start),s.process(),this.current=0}function getSymbolShortDisplay(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return e.toString();if(e.type)return"%"+e.type;if(e.test)return"<"+String(e.test)+">";else throw Error("Unknown symbol type: "+e)}}return Rule.highestId=0,Rule.prototype.toString=function(e){var t=void 0===e?this.symbols.map(getSymbolShortDisplay).join(" "):this.symbols.slice(0,e).map(getSymbolShortDisplay).join(" ")+" ● "+this.symbols.slice(e).map(getSymbolShortDisplay).join(" ");return this.name+" → "+t},State.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},State.prototype.nextState=function(e){var t=new State(this.rule,this.dot+1,this.reference,this.wantedBy);return t.left=this,t.right=e,t.isComplete&&(t.data=t.build(),t.right=void 0),t},State.prototype.build=function(){var e=[],t=this;do e.push(t.right.data),t=t.left;while(t.left);return e.reverse(),e},State.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,Parser.fail))},Column.prototype.process=function(e){for(var t=this.states,n=this.wants,a=this.completed,r=0;r<t.length;r++){var s=t[r];if(s.isComplete){if(s.finish(),s.data!==Parser.fail){for(var i=s.wantedBy,o=i.length;o--;){var l=i[o];this.complete(l,s)}if(s.reference===this.index){var u=s.rule.name;(this.completed[u]=this.completed[u]||[]).push(s)}}}else{var u=s.rule.symbols[s.dot];if("string"!=typeof u){this.scannable.push(s);continue}if(n[u]){if(n[u].push(s),a.hasOwnProperty(u))for(var d=a[u],o=0;o<d.length;o++){var p=d[o];this.complete(s,p)}}else n[u]=[s],this.predict(u)}}},Column.prototype.predict=function(e){for(var t=this.grammar.byName[e]||[],n=0;n<t.length;n++){var a=t[n],r=this.wants[e],s=new State(a,0,this.index,r);this.states.push(s)}},Column.prototype.complete=function(e,t){var n=e.nextState(t);this.states.push(n)},Grammar.fromCompiled=function(e,t){var n=e.Lexer;e.ParserStart&&(t=e.ParserStart,e=e.ParserRules);var e=e.map(function(e){return new Rule(e.name,e.symbols,e.postprocess)}),a=new Grammar(e,t);return a.lexer=n,a},StreamLexer.prototype.reset=function(e,t){this.buffer=e,this.index=0,this.line=t?t.line:1,this.lastLineBreak=t?-t.col:0},StreamLexer.prototype.next=function(){if(this.index<this.buffer.length){var e=this.buffer[this.index++];return"\n"===e&&(this.line+=1,this.lastLineBreak=this.index),{value:e}}},StreamLexer.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},StreamLexer.prototype.formatError=function(e,t){var n=this.buffer;if("string"!=typeof n)return t+" at index "+(this.index-1);var a=n.split("\n").slice(Math.max(0,this.line-5),this.line),r=n.indexOf("\n",this.index);-1===r&&(r=n.length);var s=this.index-this.lastLineBreak,i=String(this.line).length;return t+(" at line "+this.line+" col "+s+":\n\n"+a.map(function(e,t){return pad(this.line-a.length+t+1,i)+" "+e},this).join("\n")+"\n"+pad("",i+s))+"^\n";function pad(e,t){var n=String(e);return Array(t-n.length+1).join(" ")+n}},Parser.fail={},Parser.prototype.feed=function(e){var t,n=this.lexer;for(n.reset(e,this.lexerState);;){try{if(!(t=n.next()))break}catch(e){var a=new Column(this.grammar,this.current+1);this.table.push(a);var r=Error(this.reportLexerError(e));throw r.offset=this.current,r.token=e.token,r}var s=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var i=this.current+1,a=new Column(this.grammar,i);this.table.push(a);for(var o=void 0!==t.text?t.text:t.value,l=n.constructor===StreamLexer?t.value:t,u=s.scannable,d=u.length;d--;){var p=u[d],c=p.rule.symbols[p.dot];if(c.test?c.test(l):c.type?c.type===t.type:c.literal===o){var m=p.nextState({data:l,token:t,isToken:!0,reference:i-1});a.states.push(m)}}if(a.process(),0===a.states.length){var r=Error(this.reportError(t));throw r.offset=this.current,r.token=t,r}this.options.keepHistory&&(s.lexerState=n.save()),this.current++}return s&&(this.lexerState=n.save()),this.results=this.finish(),this},Parser.prototype.reportLexerError=function(e){var t,n,a=e.token;return a?(t="input "+JSON.stringify(a.text[0])+" (lexer error)",n=this.lexer.formatError(a,"Syntax error")):(t="input (lexer error)",n=e.message),this.reportErrorCommon(n,t)},Parser.prototype.reportError=function(e){var t=(e.type?e.type+" token: ":"")+JSON.stringify(void 0!==e.value?e.value:e),n=this.lexer.formatError(e,"Syntax error");return this.reportErrorCommon(n,t)},Parser.prototype.reportErrorCommon=function(e,t){var n=[];n.push(e);var a=this.table.length-2,r=this.table[a],s=r.states.filter(function(e){var t=e.rule.symbols[e.dot];return t&&"string"!=typeof t});return 0===s.length?(n.push("Unexpected "+t+". I did not expect any more input. Here is the state of my parse table:\n"),this.displayStateStack(r.states,n)):(n.push("Unexpected "+t+". Instead, I was expecting to see one of the following:\n"),s.map(function(e){return this.buildFirstStateStack(e,[])||[e]},this).forEach(function(e){var t=e[0],a=t.rule.symbols[t.dot],r=this.getSymbolDisplay(a);n.push("A "+r+" based on:"),this.displayStateStack(e,n)},this)),n.push(""),n.join("\n")},Parser.prototype.displayStateStack=function(e,t){for(var n,a=0,r=0;r<e.length;r++){var s=e[r],i=s.rule.toString(s.dot);i===n?a++:(a>0&&t.push("    ^ "+a+" more lines identical to this"),a=0,t.push("    "+i)),n=i}},Parser.prototype.getSymbolDisplay=function(e){return function(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return"character matching "+e;if(e.type)return e.type+" token";if(e.test)return"token matching "+String(e.test);else throw Error("Unknown symbol type: "+e)}}(e)},Parser.prototype.buildFirstStateStack=function(e,t){if(-1!==t.indexOf(e))return null;if(0===e.wantedBy.length)return[e];var n=e.wantedBy[0],a=[e].concat(t),r=this.buildFirstStateStack(n,a);return null===r?null:[e].concat(r)},Parser.prototype.save=function(){var e=this.table[this.current];return e.lexerState=this.lexerState,e},Parser.prototype.restore=function(e){var t=e.index;this.current=t,this.table[t]=e,this.table.splice(t+1),this.lexerState=e.lexerState,this.results=this.finish()},Parser.prototype.rewind=function(e){if(!this.options.keepHistory)throw Error("set option `keepHistory` to enable rewinding");this.restore(this.table[e])},Parser.prototype.finish=function(){var e=[],t=this.grammar.start;return this.table[this.table.length-1].states.forEach(function(n){n.rule.name===t&&n.dot===n.rule.symbols.length&&0===n.reference&&n.data!==Parser.fail&&e.push(n)}),e.map(function(e){return e.data})},{Parser:Parser,Grammar:Grammar,Rule:Rule}},e.exports?e.exports=t():this.nearley=t()},36906:function(e,t,n){"use strict";n.d(t,{Z:function(){return camelCase}});let a=/[\p{Lu}]/u,r=/[\p{Ll}]/u,s=/^[\p{Lu}](?![\p{Lu}])/gu,i=/([\p{Alpha}\p{N}_]|$)/u,o=/[_.\- ]+/,l=RegExp("^"+o.source),u=RegExp(o.source+i.source,"gu"),d=RegExp("\\d+"+i.source,"gu"),preserveCamelCase=(e,t,n)=>{let s=!1,i=!1,o=!1;for(let l=0;l<e.length;l++){let u=e[l];s&&a.test(u)?(e=e.slice(0,l)+"-"+e.slice(l),s=!1,o=i,i=!0,l++):i&&o&&r.test(u)?(e=e.slice(0,l-1)+"-"+e.slice(l-1),o=i,i=!1,s=!0):(s=t(u)===u&&n(u)!==u,o=i,i=n(u)===u&&t(u)!==u)}return e},preserveConsecutiveUppercase=(e,t)=>(s.lastIndex=0,e.replace(s,e=>t(e))),postProcess=(e,t)=>(u.lastIndex=0,d.lastIndex=0,e.replace(u,(e,n)=>t(n)).replace(d,e=>t(e)));function camelCase(e,t){if(!("string"==typeof e||Array.isArray(e)))throw TypeError("Expected the input to be `string | string[]`");if(t={pascalCase:!1,preserveConsecutiveUppercase:!1,...t},0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length)return"";let n=!1===t.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(t.locale),a=!1===t.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(t.locale);if(1===e.length)return o.test(e)?"":t.pascalCase?a(e):n(e);let r=e!==n(e);return r&&(e=preserveCamelCase(e,n,a)),e=e.replace(l,""),e=t.preserveConsecutiveUppercase?preserveConsecutiveUppercase(e,n):n(e),t.pascalCase&&(e=a(e.charAt(0))+e.slice(1)),postProcess(e,a)}},66254:function(e,t,n){"use strict";n.d(t,{ZP:function(){return ea}});var a,r=n(43614),s=n(42569),i=Object.defineProperty,o=Object.defineProperties,l=Object.getOwnPropertyDescriptors,u=Object.getOwnPropertySymbols,d=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,n)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,__spreadValues=(e,t)=>{for(var n in t||(t={}))d.call(t,n)&&__defNormalProp(e,n,t[n]);if(u)for(var n of u(t))p.call(t,n)&&__defNormalProp(e,n,t[n]);return e},__spreadProps=(e,t)=>o(e,l(t)),__restKey=e=>"symbol"==typeof e?e:e+"",__objRest=(e,t)=>{var n={};for(var a in e)d.call(e,a)&&0>t.indexOf(a)&&(n[a]=e[a]);if(null!=e&&u)for(var a of u(e))0>t.indexOf(a)&&p.call(e,a)&&(n[a]=e[a]);return n},c=class extends Error{name;info;constructor(e,t,n,a){super(buildMessage(e,t,n,a)),this.name=e,this.info=n}},buildMessage=(e,t,n,a)=>{var r;let s=/error/i.test(e);return`
[ ${({SyntaxError:"Erreur syntaxique",EvaluationError:"Erreur d'\xe9valuation",UnknownRule:"R\xe8gle inconnue",PrivateRule:"R\xe8gle priv\xe9e"})[e]??e} ]`+(n&&"dottedName"in n&&(null==(r=n.dottedName)?void 0:r.length)?`
\u27A1\uFE0F  Dans la r\xe8gle "${n.dottedName}"`:"")+`
${s?"✖️":"⚠️"}  ${t}`+(a?"\n"+(s?"    ":"ℹ️  ")+a.message:"")},m=class extends c{constructor(e){super("InternalError",`
Erreur interne du moteur.

Cette erreur est le signe d'un bug dans publicodes. Pour nous aider \xe0 le r\xe9soudre, vous pouvez copier ce texte dans un nouveau ticket : https://github.com/betagouv/mon-entreprise/issues/new.

payload:
${JSON.stringify(e,null,2)}
`,e)}},f=class extends m{constructor(e){super(e)}};function warning(e,t,n,a){e.warn(buildMessage("Avertissement",t,n,a))}function experimentalRuleWarning(e,t){e.warn(buildMessage("Avertissement","Cette r\xe8gle est taggu\xe9e comme experimentale. \n\nCela veut dire qu'elle peut \xeatre modifi\xe9e, renomm\xe9e, ou supprim\xe9e sans qu'il n'y ait de changement de version majeure dans l'API.\n",{dottedName:t}))}function makeASTTransformer(e,t=!0){return function transform(n){let a=e(n,transform);return!1===a?n:void 0===a?traverseASTNode(transform,n):t?a:traverseASTNode(transform,a)}}function makeASTVisitor(e){function visit(t){switch(e(t,visit)){case"continue":traverseASTNode(transformizedVisit,t);return;case"stop":return}}let transformizedVisit=e=>(visit(e),e);return visit}var traverseASTNode=(e,t)=>{switch((t=traverseSourceMap(e,t)).nodeKind){case"rule":return traverseRuleNode(e,t);case"reference":case"constant":return traverseLeafNode(e,t);case"arrondi":return traverseArrondiNode(e,t);case"simplifier unit\xe9":case"variable manquante":case"est non applicable":case"est non d\xe9fini":return traverseUnaryOperationNode(e,t);case"bar\xe8me":case"taux progressif":case"grille":return traverseNodeWithTranches(e,t);case"une possibilit\xe9":return traverseArrayNode(e,t);case"dur\xe9e":return traverseDuréeNode(e,t);case"r\xe9soudre r\xe9f\xe9rence circulaire":return traverseRésoudreRéférenceCirculaireNode(e,t);case"inversion":return traverseInversionNode(e,t);case"operation":return traverseOperationNode(e,t);case"recalcul":return traverseRecalculNode(e,t);case"unit\xe9":return traverseUnitéNode(e,t);case"variations":return traverseVariationNode(e,t);case"replacementRule":return traverseReplacementNode(e,t);case"texte":return traverseTextNode(e,t);case"condition":return traverseConditionNode(e,t);default:throw new f(t)}},traverseSourceMap=(e,t)=>{if(!("sourceMap"in t)||!t.sourceMap||!t.sourceMap.args)return t;let n=t.sourceMap;return __spreadProps(__spreadValues({},t),{sourceMap:__spreadProps(__spreadValues({},n),{args:Object.fromEntries(Object.entries(n.args).map(([t,n])=>[t,Array.isArray(n)?n.map(t=>e(t)):e(n)]))})})},traverseRuleNode=(e,t)=>__spreadProps(__spreadValues({},t),{replacements:t.replacements.map(e),suggestions:Object.fromEntries(Object.entries(t.suggestions).map(([t,n])=>[t,e(n)])),explanation:{ruleDisabledByItsParent:t.explanation.ruleDisabledByItsParent,nullableParent:t.explanation.nullableParent?e(t.explanation.nullableParent):void 0,parents:t.explanation.parents.map(e),valeur:e(t.explanation.valeur)}}),traverseReplacementNode=(e,t)=>__spreadProps(__spreadValues({},t),{definitionRule:e(t.definitionRule),replacedReference:e(t.replacedReference),replacementNode:e(t.replacementNode),whiteListedNames:t.whiteListedNames.map(e),blackListedNames:t.blackListedNames.map(e)}),traverseLeafNode=(e,t)=>t,traverseUnaryOperationNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:e(t.explanation)}),traverseNodeWithTranches=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:{assiette:e(t.explanation.assiette),multiplicateur:e(t.explanation.multiplicateur),tranches:t.explanation.tranches.map(t=>__spreadValues(__spreadValues(__spreadValues(__spreadValues({},t),t.plafond&&{plafond:e(t.plafond)}),"montant"in t&&{montant:e(t.montant)}),"taux"in t&&{taux:e(t.taux)}))}}),traverseArrayNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:t.explanation.map(e)}),traverseOperationNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:[e(t.explanation[0]),e(t.explanation[1])]}),traverseDuréeNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:{depuis:e(t.explanation.depuis),"jusqu'\xe0":e(t.explanation["jusqu'\xe0"])}}),traverseInversionNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:__spreadProps(__spreadValues({},t.explanation),{inversionCandidates:t.explanation.inversionCandidates.map(e)})}),traverseArrondiNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:{valeur:e(t.explanation.valeur),arrondi:e(t.explanation.arrondi)}}),traverseRésoudreRéférenceCirculaireNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:__spreadProps(__spreadValues({},t.explanation),{valeur:e(t.explanation.valeur)})}),traverseTextNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:t.explanation.map(t=>"string"==typeof t?t:e(t))}),traverseRecalculNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:__spreadProps(__spreadValues({},t.explanation),{amendedSituation:t.explanation.amendedSituation.map(([t,n])=>[e(t),e(n)]),recalcul:t.explanation.recalculNode&&e(t.explanation.recalculNode)})}),traverseUnitéNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:e(t.explanation)}),traverseVariationNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:t.explanation.map(({condition:t,consequence:n})=>({condition:e(t),consequence:n&&e(n)}))}),traverseConditionNode=(e,t)=>__spreadProps(__spreadValues({},t),{explanation:{si:e(t.explanation.si),alors:e(t.explanation.alors),sinon:e(t.explanation.sinon)}}),h={constant:e=>e};function registerEvaluationFunction(e,t){if(h??(h={}),h[e])throw new c("EvaluationError",`Multiple evaluation functions registered for the nodeKind \x1b[4m${e}`,{dottedName:""});h[e]=t}var v={isNullable:void 0,type:void 0};function normalizeDateString(e){let[t,n,a]=e.split("/");return a||([t,n,a]=["01",t,n]),normalizeDate(+a,+n,+t)}var pad=e=>10>+e?`0${e}`:""+e;function normalizeDate(e,t,n){let a=new Date(+e,+t-1,+n);if(!+a||a.getDate()!==+n)throw new c("SyntaxError",`La date ${n}/${t}/${e} n'est pas valide`,{dottedName:""});return`${pad(n)}/${pad(t)}/${pad(e)}`}function convertToDate(e){let[t,n,a]=normalizeDateString(e).split("/"),r=new Date(+a,+n-1,+t);return r.setMinutes(r.getMinutes()-r.getTimezoneOffset()),r}var binaryOperation=([e,,t,,n])=>({[t.value.toLowerCase()]:[e,n]}),variable=({value:e})=>({variable:e}),JSONObject=([{value:e}])=>{console.log(e)},number=([{value:e}])=>({constant:{type:"number",nodeValue:parseFloat(e)}}),date=([{value:e}])=>({constant:{type:"date",nodeValue:normalizeDateString(e)}}),boolean=([{value:e}])=>({constant:{type:"boolean",nodeValue:"oui"===e}}),string=([{value:e}])=>({constant:{type:"string",nodeValue:e.slice(1,-1)}});function id(e){return e[0]}var b=`[a-zA-Z\xc0-ſ€$%](?:[-']?[a-zA-Z\xc0-ſ0-9',\xb0]+)*`,x=s.compile({"(":"(",")":")","[":"[","]":"]",comparison:[">","<",">=","<=","=","!="],date:RegExp("(?:(?:0?[1-9]|[12][0-9]|3[01])\\/)?(?:0?[1-9]|1[012])\\/\\d{4}"),boolean:["oui","non"],number:RegExp("-?(?:[1-9][0-9]+|[0-9])(?:\\.[0-9]+)?"),word:new RegExp(b),string:[/'.*'/,/".*"/],JSONObject:/{.*}/,additionSubstraction:/[\+-]/,multiplicationDivision:["*","/"],dot:" . ",".":".",space:{match:/[\s]+/,lineBreaks:!0}}),join=e=>({value:e.map(e=>e&&e.value).join("")}),flattenJoin=([e,t])=>Array.isArray(t)?join([e,...t]):e,_=[{name:"main",symbols:["Comparison"],postprocess:id},{name:"main",symbols:["NumericValue"],postprocess:id},{name:"main",symbols:["Date"],postprocess:id},{name:"main",symbols:["NonNumericTerminal"],postprocess:id},{name:"main",symbols:["JSONObject"],postprocess:id},{name:"NumericValue",symbols:["AdditionSubstraction"],postprocess:id},{name:"NumericValue",symbols:["Negation"],postprocess:id},{name:"NumericTerminal",symbols:["Variable"],postprocess:id},{name:"NumericTerminal",symbols:["number"],postprocess:id},{name:"Negation",symbols:[{literal:"-"},x.has("space")?{type:"space"}:space,"Parentheses"],postprocess:([e,,t])=>({[e]:[number([{value:"0"}]),t]})},{name:"Parentheses",symbols:[{literal:"("},x.has("space")?{type:"space"}:space,"NumericValue",x.has("space")?{type:"space"}:space,{literal:")"}],postprocess:([,,e])=>e},{name:"Parentheses",symbols:[{literal:"("},"NumericValue",{literal:")"}],postprocess:([,e])=>e},{name:"Parentheses",symbols:["NumericTerminal"],postprocess:id},{name:"Date",symbols:["Variable"],postprocess:id},{name:"Date",symbols:[x.has("date")?{type:"date"}:date],postprocess:date},{name:"Comparison",symbols:["Comparable",x.has("space")?{type:"space"}:space,x.has("comparison")?{type:"comparison"}:comparison,x.has("space")?{type:"space"}:space,"Comparable"],postprocess:binaryOperation},{name:"Comparison",symbols:["Date",x.has("space")?{type:"space"}:space,x.has("comparison")?{type:"comparison"}:comparison,x.has("space")?{type:"space"}:space,"Date"],postprocess:binaryOperation},{name:"Comparable$subexpression$1",symbols:["AdditionSubstraction"]},{name:"Comparable$subexpression$1",symbols:["NonNumericTerminal"]},{name:"Comparable",symbols:["Comparable$subexpression$1"],postprocess:([[e]])=>e},{name:"NonNumericTerminal",symbols:[x.has("boolean")?{type:"boolean"}:boolean],postprocess:boolean},{name:"NonNumericTerminal",symbols:[x.has("string")?{type:"string"}:string],postprocess:string},{name:"Variable$ebnf$1",symbols:[]},{name:"Variable$ebnf$1$subexpression$1",symbols:[x.has("dot")?{type:"dot"}:dot,"Words"],postprocess:join},{name:"Variable$ebnf$1",symbols:["Variable$ebnf$1","Variable$ebnf$1$subexpression$1"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Variable",symbols:["Words","Variable$ebnf$1"],postprocess:e=>variable(flattenJoin(e))},{name:"Words$ebnf$1$subexpression$1$ebnf$1",symbols:[x.has("space")?{type:"space"}:space],postprocess:id},{name:"Words$ebnf$1$subexpression$1$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Words$ebnf$1$subexpression$1",symbols:["Words$ebnf$1$subexpression$1$ebnf$1","WordOrNumber"],postprocess:join},{name:"Words$ebnf$1",symbols:["Words$ebnf$1$subexpression$1"]},{name:"Words$ebnf$1$subexpression$2$ebnf$1",symbols:[x.has("space")?{type:"space"}:space],postprocess:id},{name:"Words$ebnf$1$subexpression$2$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Words$ebnf$1$subexpression$2",symbols:["Words$ebnf$1$subexpression$2$ebnf$1","WordOrNumber"],postprocess:join},{name:"Words$ebnf$1",symbols:["Words$ebnf$1","Words$ebnf$1$subexpression$2"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Words",symbols:["WordOrKeyword","Words$ebnf$1"],postprocess:flattenJoin},{name:"Words",symbols:[x.has("word")?{type:"word"}:b],postprocess:id},{name:"WordOrKeyword",symbols:[x.has("word")?{type:"word"}:b],postprocess:id},{name:"WordOrKeyword",symbols:[x.has("boolean")?{type:"boolean"}:boolean],postprocess:id},{name:"WordOrNumber",symbols:["WordOrKeyword"],postprocess:id},{name:"WordOrNumber",symbols:[x.has("number")?{type:"number"}:number],postprocess:id},{name:"UnitDenominator$ebnf$1$subexpression$1",symbols:[x.has("space")?{type:"space"}:space]},{name:"UnitDenominator$ebnf$1",symbols:["UnitDenominator$ebnf$1$subexpression$1"],postprocess:id},{name:"UnitDenominator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitDenominator",symbols:["UnitDenominator$ebnf$1",{literal:"/"},"Words"],postprocess:join},{name:"UnitNumerator$ebnf$1$subexpression$1",symbols:[{literal:"."},"Words"]},{name:"UnitNumerator$ebnf$1",symbols:["UnitNumerator$ebnf$1$subexpression$1"],postprocess:id},{name:"UnitNumerator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitNumerator",symbols:["Words","UnitNumerator$ebnf$1"],postprocess:flattenJoin},{name:"Unit$ebnf$1",symbols:["UnitNumerator"],postprocess:id},{name:"Unit$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Unit$ebnf$2",symbols:[]},{name:"Unit$ebnf$2",symbols:["Unit$ebnf$2","UnitDenominator"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Unit",symbols:["Unit$ebnf$1","Unit$ebnf$2"],postprocess:flattenJoin},{name:"AdditionSubstraction",symbols:["AdditionSubstraction",x.has("space")?{type:"space"}:space,x.has("additionSubstraction")?{type:"additionSubstraction"}:additionSubstraction,x.has("space")?{type:"space"}:space,"MultiplicationDivision"],postprocess:binaryOperation},{name:"AdditionSubstraction",symbols:["MultiplicationDivision"],postprocess:id},{name:"MultiplicationDivision",symbols:["MultiplicationDivision",x.has("space")?{type:"space"}:space,x.has("multiplicationDivision")?{type:"multiplicationDivision"}:multiplicationDivision,x.has("space")?{type:"space"}:space,"Parentheses"],postprocess:binaryOperation},{name:"MultiplicationDivision",symbols:["Parentheses"],postprocess:id},{name:"number",symbols:[x.has("number")?{type:"number"}:number],postprocess:number},{name:"number$ebnf$1$subexpression$1",symbols:[x.has("space")?{type:"space"}:space]},{name:"number$ebnf$1",symbols:["number$ebnf$1$subexpression$1"],postprocess:id},{name:"number$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"number",symbols:[x.has("number")?{type:"number"}:number,"number$ebnf$1","Unit"],postprocess:e=>__spreadProps(__spreadValues({},number(e)),{unité:e[2].value})},{name:"JSONObject",symbols:[x.has("JSONObject")?{type:"JSONObject"}:JSONObject],postprocess:JSONObject}];function createParseInlinedMecanism(e,t,n){let a,r;function parseInlineMecanism(s,i){a??(a=parse(n,createContext({dottedName:"INLINE_MECANISM"}))),r??(r=Object.fromEntries(Object.entries(t).filter(([,e])=>"par d\xe9faut"in e).map(([e,t])=>[e,parse(t["par d\xe9faut"],createContext({}))]))),1===Object.keys(t).length&&"valeur"in t&&(s={valeur:s});let o=Object.fromEntries(Object.entries(s).map(([e,t])=>[e,parse(t,i)])),l=makeASTTransformer(n=>{if("reference"!==n.nodeKind||!(n.name in t))return;let a=n.name;if(a in o)return o[a];if(a in r)return r[a];throw new c("SyntaxError",`Il manque la cl\xe9 '${a} dans le m\xe9canisme ${e}`,{dottedName:a})})(a);return l.sourceMap={mecanismName:e,args:o},l}return parseInlineMecanism.nom=e,Object.assign(parseInlineMecanism,"name",{value:`parse${toCamelCase(e)}Inline`})}function createParseInlinedMecanismWithArray(e,t,n){function parseInlineMecanism(a,r){1===Object.keys(t).length&&"valeur"in t&&(a={valeur:a});let s=Object.fromEntries(Object.entries(a).map(([e,t])=>[e,Array.isArray(t)?t.map(e=>parse(e,r)):parse(t,r)])),i=parse(n(s),r);return i.sourceMap={mecanismName:e,args:s},i}return parseInlineMecanism.nom=e,Object.assign(parseInlineMecanism,"name",{value:`parse${toCamelCase(e)}Inline`})}function toCamelCase(e){return e.replace(/(?:^\w|[A-Z]|\b\w)/g,e=>e.toUpperCase()).replace(/\s+/g,"")}var g={nodeKind:"constant",nodeValue:null,missingVariables:{},type:void 0,isNullable:!0},y={nodeKind:"constant",nodeValue:void 0,missingVariables:{},type:void 0,isNullable:!1},N=__spreadProps(__spreadValues({},y),{type:"number"}),V=createParseInlinedMecanism("abattement",{abattement:{},valeur:{}},{"-":["valeur","abattement"],plancher:0}),w=createParseInlinedMecanism("applicable si",{"applicable si":{},valeur:{}},{condition:{si:"applicable si != non",alors:"valeur",sinon:g}}),collectNodeMissing=e=>"missingVariables"in e?e.missingVariables:{},bonus=(e={})=>Object.fromEntries(Object.entries(e).map(([e,t])=>[e,t+1])),mergeMissing=(e={},t={})=>Object.fromEntries([...Object.keys(e),...Object.keys(t)].map(n=>[n,(e[n]??0)+(t[n]??0)])),mergeAllMissing=e=>e.map(collectNodeMissing).reduce(mergeMissing,{}),defaultNode=e=>({nodeValue:e,type:typeof e,isDefault:!0,nodeKind:"constant"}),parseObject=(e,t,n)=>Object.fromEntries(Object.entries(e).map(([e,a])=>{if(void 0==t[e]&&!a)throw new c("EngineError",`Il manque une cl\xe9 '${e}' dans ${JSON.stringify(t)} `,{});let r=void 0!=t[e]?parse(t[e],n):a;return[e,r]})),parseUnit=(e,t=e=>e)=>{let[n,...a]=e.split("/").map(e=>e.trim()),r={numerators:n.split(".").filter(Boolean).map(e=>t(e)),denominators:a.map(e=>t(e))};return r},printUnits=(e,t,n=e=>e)=>e.sort().map(e=>n(e,t)).join("."),E=2,serializeUnit=(e,t=E,n=e=>e)=>{if(null===e||"object"!=typeof e)return"string"==typeof e?n(e,t):e;let a=simplify(e),{numerators:r=[],denominators:s=[]}=a,i=r.length>0,o=s.length>0,l=i||o?i&&!o?printUnits(r,t,n):!i&&o?`/${printUnits(s,1,n)}`:`${printUnits(r,E,n)} / ${printUnits(s,1,n)}`:"";return l},$={numerators:[],denominators:[]},inferUnit=(e,t)=>{if("/"===e){if(2!==t.length)throw new c("InternalError","Infer units of a division with units.length !== 2)",{});return inferUnit("*",[t[0]||$,{numerators:(t[1]||$).denominators,denominators:(t[1]||$).numerators}])}let n=t.filter(Boolean);return n.length<=1?n[0]:"*"===e?simplify({numerators:n.flatMap(e=>(null==e?void 0:e.numerators)??[]),denominators:n.flatMap(e=>(null==e?void 0:e.denominators)??[])}):"-"===e||"+"===e?t.find(e=>e):void 0},equals=(e,t)=>Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every((n,a)=>e[a]===t[a]):e===t,removeOnce=(e,t=equals)=>n=>{let a=n.findIndex(n=>t(n,e));return n.filter((e,t)=>t!==a)},simplify=(e,t=equals)=>[...e.numerators,...e.denominators].reduce(({numerators:e,denominators:n},a)=>e.find(e=>t(a,e))&&n.find(e=>t(a,e))?{numerators:removeOnce(a,t)(e),denominators:removeOnce(a,t)(n)}:{numerators:e,denominators:n},e),P={"mois/an":12,"jour/an":365,"jour/mois":365/12,"trimestre/an":4,"mois/trimestre":3,"jour/trimestre":365/12*3,"€/k€":1e3,"g/kg":1e3,"mg/g":1e3,"mg/kg":1e6,"m/km":1e3,"cm/m":100,"mm/cm":10,"mm/m":1e3,"cm/km":1e5,"mm/km":1e6};function singleUnitConversionFactor(e,t){return P[`${t}/${e}`]||P[`${e}/${t}`]&&1/P[`${e}/${t}`]}function unitsConversionFactor(e,t){let n=100**(t.filter(e=>"%"===e).length-e.filter(e=>"%"===e).length);return[n]=e.reduce(([e,t],n)=>{let a=t.findIndex(e=>!!singleUnitConversionFactor(n,e)),r=singleUnitConversionFactor(n,t[a])||1;return[e*r,[...t.slice(0,a+1),...t.slice(a+1)]]},[n,t]),n}function convertUnit(e,t,n){if(!function(e,t){if(null==e||null==t)return!0;let[n,a,r,s]=[e.numerators,e.denominators,t.numerators,t.denominators].map(e=>e.reduce((e,t)=>{let n=S.findIndex(e=>e.has(t)),a=-1===n?t:""+n;return __spreadProps(__spreadValues({},e),{[a]:1+(e[a]??0)})},{})),i=[n,a,r,s].map(Object.keys).flat();return[...new Set(i)].every(e=>(n[e]||0)-(a[e]||0)==(r[e]||0)-(s[e]||0)||"%"===e)}(e,t))throw new c("EngineError",`Impossible de convertir l'unit\xe9 '${serializeUnit(e)}' en '${serializeUnit(t)}'`,{});if(!n||void 0===e)return n;let[a,r]=simplifyUnitWithValue(e||$),[s,i]=simplifyUnitWithValue(t||$);return round(n*r/i*unitsConversionFactor(a.numerators,s.numerators)*unitsConversionFactor(s.denominators,a.denominators))}var S=Object.keys(P).reduce((e,t)=>{let[n,a]=t.split("/"),r=e.findIndex(e=>e.has(n)),s=e.findIndex(e=>e.has(a));if(r>-1&&s>-1&&r!==s)throw new c("EngineError",`Invalid ratio ${t}`,{});return -1===r&&-1===s?e.push(new Set([n,a])):r>-1?e[r].add(a):s>-1&&e[s].add(n),e},[]);function areSameClass(e,t){return e===t||S.some(n=>n.has(e)&&n.has(t))}function round(e){return+e.toFixed(16)}function simplifyUnit(e){let{numerators:t,denominators:n}=simplify(e,areSameClass);return t.length&&t.every(e=>"%"===e)?{numerators:["%"],denominators:n}:removePercentages({numerators:t,denominators:n})}function simplifyUnitWithValue(e,t=1){let n=unitsConversionFactor(e.numerators,e.denominators);return[simplify(removePercentages(e),areSameClass),t?round(t*n):t]}var removePercentages=e=>({numerators:e.numerators.filter(e=>"%"!==e),denominators:e.denominators.filter(e=>"%"!==e)});function parseArrondi(e,t){let n={valeur:parse(e.valeur,t),arrondi:parse(e.arrondi,t)};return{explanation:n,nodeKind:parseArrondi.nom}}function parseAvec(e,t){Object.entries(e.avec).forEach(([e,n])=>{parse(__spreadValues({nom:e},void 0==n?{}:"object"!=typeof n||"nodeKind"in n?{valeur:n}:n),t)});let n=parse(e.valeur,t);return n}parseArrondi.nom="arrondi",registerEvaluationFunction(parseArrondi.nom,function(e){var t,n,a;let r=simplifyNodeUnit(this.evaluateNode(e.explanation.valeur)),s=r.nodeValue,i=e.explanation.arrondi;if(!1!==s&&"number"==typeof(i=this.evaluateNode(i)).nodeValue&&!(null==(t=serializeUnit(i.unit))?void 0:t.match(/décimales?/)))throw new c("EvaluationError",`L'unit\xe9 ${serializeUnit(i.unit)} de l'arrondi est inconnu. Vous devez utiliser l'unit\xe9 \u201Cd\xe9cimales\u201D`,{dottedName:this.cache._meta.evaluationRuleStack[0]});return __spreadProps(__spreadValues({},e),{nodeValue:"number"==typeof r.nodeValue&&"nodeValue"in i?"number"==typeof i.nodeValue?(n=r.nodeValue,a=i.nodeValue,+n.toFixed(a)):!0===i.nodeValue?+r.nodeValue.toFixed(0):void 0===i.nodeValue?void 0:r.nodeValue:r.nodeValue,explanation:{valeur:r,arrondi:i},missingVariables:mergeAllMissing([r,i]),unit:r.unit})}),parseAvec.nom="avec";var parseTranches=(e,t)=>e.map((n,a)=>{if(!n.plafond&&a>e.length)throw new c("SyntaxError",`La tranche n\xb0${a} du bar\xe8me n'a pas de plafond pr\xe9cis\xe9. Seule la derni\xe8re tranche peut ne pas \xeatre plafonn\xe9e`,{dottedName:""});return __spreadProps(__spreadValues(__spreadValues(__spreadValues({},n),void 0!==n.taux?{taux:parse(n.taux,t)}:{}),void 0!==n.montant?{montant:parse(n.montant,t)}:{}),{plafond:"plafond"in n?parse(n.plafond,t):{nodeValue:1/0,nodeKind:"constant",type:"number",isNullable:!1}})});function evaluatePlafondUntilActiveTranche({multiplicateur:e,assiette:t,parsedTranches:n}){return n.reduce(([n,a],r,s)=>{if(a)return[[...n,__spreadProps(__spreadValues({},r),{isAfterActive:!0})],a];let i=this.evaluateNode(r.plafond),o=n[s-1]?n[s-1].plafond:{nodeValue:0},l=void 0===i.nodeValue||void 0===e.nodeValue?void 0:i.nodeValue*e.nodeValue;try{l=l===1/0||0===l?l:convertUnit(inferUnit("*",[i.unit,e.unit]),t.unit,l)}catch(e){warning(this.context.logger,`L'unit\xe9 du plafond de la tranche n\xb0${s+1}  n'est pas compatible avec celle l'assiette`,{dottedName:this.cache._meta.evaluationRuleStack[0]},e)}let u=n[s-1]?n[s-1].plafondValue:0,d=void 0===u||void 0===t.nodeValue?void 0:u>t.nodeValue,p=[i,t,e,o];if(p.some(e=>void 0===e.nodeValue))return[[...n,__spreadProps(__spreadValues({},r),{plafond:i,plafondValue:l,plancherValue:u,nodeValue:void 0,isActive:void 0,isAfterActive:d,missingVariables:mergeAllMissing(p)})],!1];if(n[s-1]&&u&&l<=u)throw new c("EvaluationError",`Le plafond de la tranche n\xb0${s+1} a une valeur inf\xe9rieure \xe0 celui de la tranche pr\xe9c\xe9dente`,{dottedName:this.cache._meta.evaluationRuleStack[0]});let m=__spreadProps(__spreadValues({},r),{plafond:i,plancherValue:u,plafondValue:l,isAfterActive:d,isActive:t.nodeValue>=u&&t.nodeValue<l});return[[...n,m],m.isActive]},[[],!1])[0]}registerEvaluationFunction("bar\xe8me",function(e){let t=this.evaluateNode.bind(this),n=this.evaluateNode(e.explanation.assiette),a=this.evaluateNode(e.explanation.multiplicateur),r=evaluatePlafondUntilActiveTranche.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:a}).map(e=>{if(e.isAfterActive)return __spreadProps(__spreadValues({},e),{nodeValue:0});let a=t(e.taux),r=mergeAllMissing([a,e]);return[n.nodeValue,a.nodeValue,e.plafondValue,e.plancherValue].some(e=>void 0===e)?__spreadProps(__spreadValues({},e),{taux:a,nodeValue:void 0,missingVariables:r}):__spreadProps(__spreadValues(__spreadProps(__spreadValues({},e),{taux:a}),"unit"in n&&{unit:n.unit}),{nodeValue:(Math.min(n.nodeValue,e.plafondValue)-e.plancherValue)*convertUnit(a.unit,parseUnit(""),a.nodeValue),missingVariables:r})}),s=r.reduce((e,{nodeValue:t})=>void 0==t?void 0:e+t,0);return __spreadProps(__spreadValues({},e),{nodeValue:s,missingVariables:mergeAllMissing([n,a,...r]),explanation:{assiette:n,multiplicateur:a,tranches:r},unit:n.unit})});var decompose=(e,t,n)=>{let{composantes:a}=t,r=__objRest(t,["composantes"]),s=parse({somme:a.map(t=>{let{attributs:n}=t,a=__objRest(t,["attributs"]);return __spreadProps(__spreadValues({},n),{valeur:{[e]:__spreadValues(__spreadValues({},r),a)}})})},n);return __spreadProps(__spreadValues({},s),{sourceMap:__spreadProps(__spreadValues({args:{}},s.sourceMap),{mecanismName:"composantes"})})};function parseCondition(e,t){let n={si:parse(e.si,t),alors:parse(e.alors,t),sinon:parse(e.sinon,t)};return{explanation:n,nodeKind:"condition"}}parseCondition.nom="condition",registerEvaluationFunction("condition",function(e){let t;let n=this.evaluateNode(e.explanation.si),a=e.explanation.alors,r=e.explanation.sinon;if("unit"in n)throw new c("EvaluationError","La condition doit \xeatre de type bool\xe9en",{dottedName:this.cache._meta.evaluationRuleStack[0]});if(!0===n.nodeValue)(a=this.evaluateNode(e.explanation.alors)).isActive=!0,t=a;else if(!1===n.nodeValue)t=r=this.evaluateNode(e.explanation.sinon);else if(null===n.nodeValue)t=n;else if(void 0===n.nodeValue)r=this.evaluateNode(e.explanation.sinon),a=this.evaluateNode(e.explanation.alors),t=__spreadProps(__spreadValues({},n),{missingVariables:mergeAllMissing([r,a])});else throw new c("EvaluationError","La condition doit \xeatre de type bool\xe9en",{dottedName:this.cache._meta.evaluationRuleStack[0]});let s=t.unit??a.unit;return __spreadProps(__spreadValues(__spreadValues(__spreadProps(__spreadValues({},t),{missingVariables:mergeMissing(bonus(n.missingVariables),t.missingVariables)}),void 0!=s?{unit:s}:{}),e),{explanation:{si:n,alors:a,sinon:r}})});var R=normalizeDate((a=new Date).getFullYear(),a.getMonth()+1,a.getDate()),k={depuis:defaultNode(R),"jusqu'\xe0":defaultNode(R)};function parseEstNonDéfini(e,t){let n=parse(e,t);return{explanation:n,nodeKind:"est non d\xe9fini"}}registerEvaluationFunction("dur\xe9e",function(e){let t;let n=this.evaluateNode(e.explanation.depuis),a=this.evaluateNode(e.explanation["jusqu'\xe0"]);if([n,a].some(({nodeValue:e})=>void 0===e))t=void 0;else{let[e,r]=[n.nodeValue,a.nodeValue].map(convertToDate);t=Math.max(0,Math.round((r.getTime()-e.getTime())/864e5))}return __spreadProps(__spreadValues({},e),{missingVariables:mergeAllMissing([n,a]),nodeValue:t,explanation:{depuis:n,"jusqu'\xe0":a}})}),parseEstNonDéfini.nom="est non d\xe9fini";var O=createParseInlinedMecanism("est d\xe9fini",{valeur:{}},{"=":[{"est non d\xe9fini":"valeur"},"non"]}),A=createParseInlinedMecanism("est applicable",{valeur:{}},{"=":[{"est non applicable":"valeur"},"non"]});function simplifyNodeUnit(e){if(!e.unit)return e;let t=simplifyUnit(e.unit);return convertNodeToUnit(t,e)}function convertNodeToUnit(e,t){return __spreadProps(__spreadValues({},t),{nodeValue:t.unit&&"number"==typeof t.nodeValue?convertUnit(t.unit,e,t.nodeValue):t.nodeValue,unit:e})}registerEvaluationFunction("est non d\xe9fini",function(e){let t=this.evaluateNode(e.explanation),n=!1;return void 0===t.nodeValue&&(n=!0),__spreadProps(__spreadValues({},e),{nodeValue:n,missingVariables:t.missingVariables,explanation:t})});var numberFormatter=({style:e,maximumFractionDigits:t=2,minimumFractionDigits:n=0,language:a})=>r=>{let s="currency"===e&&t>=2&&0===n&&!Number.isInteger(r)?2:n;return Intl.NumberFormat(a,{style:e,currency:"EUR",maximumFractionDigits:t,minimumFractionDigits:s}).format(r)},j={fr:{true:"oui",false:"non"},en:{true:"yes",false:"no"}};function addToMapSet(e,t,n){if(e.has(t)){e.get(t).add(n);return}e.set(t,new Set([n]))}function has(e,t){return null!=e&&Object.prototype.hasOwnProperty.call(e,t)}function constant(e){return function(...t){return e}}((e,t)=>{for(var n in t)i(e,n,{get:t[n],enumerable:!0})})({},{contextNameToDottedName:()=>contextNameToDottedName,cyclicDependencies:()=>cyclicDependencies,decodeRuleName:()=>decodeRuleName,disambiguateReference:()=>disambiguateReference,disambiguateReferenceNode:()=>disambiguateReferenceNode,encodeRuleName:()=>encodeRuleName,findCommonAncestor:()=>findCommonAncestor,getChildrenRules:()=>getChildrenRules,isAccessible:()=>isAccessible,isExperimental:()=>isExperimental,nameLeaf:()=>nameLeaf,ruleParent:()=>ruleParent,ruleParents:()=>ruleParents,ruleWithDedicatedDocumentationPage:()=>ruleWithDedicatedDocumentationPage,updateReferencesMapsFromReferenceNode:()=>updateReferencesMapsFromReferenceNode});var incrementOrInitEntry=(e,t)=>{e[t]?e[t]++:e[t]=1},decrementOrRemoveEntry=(e,t)=>{--e[t]||delete e[t]},edgeArgsToId=(e,t,n,a)=>{let r=""+t,s=""+n;if(!e&&r>s){let e=r;r=s,s=e}return r+"\x01"+s+"\x01"+(void 0===a?"\x00":a)},edgeArgsToObj=(e,t,n,a)=>{let r=""+t,s=""+n;if(!e&&r>s){let e=r;r=s,s=e}let i={v:r,w:s};return a&&(i.name=a),i},edgeObjToId=(e,t)=>edgeArgsToId(e,t.v,t.w,t.name),T=class{_nodeCount=0;_edgeCount=0;_isDirected;_label;_defaultNodeLabelFn;_defaultEdgeLabelFn;_nodes;_in;_preds;_out;_sucs;_edgeObjs;_edgeLabels;constructor(e={}){this._isDirected=!has(e,"directed")||e.directed,this._label=void 0,this._defaultNodeLabelFn=constant(void 0),this._defaultEdgeLabelFn=constant(void 0),this._nodes={},this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}isDirected(){return this._isDirected}setGraph(e){return this._label=e,this}graph(){return this._label}nodeCount(){return this._nodeCount}nodes(){return Object.keys(this._nodes)}setNode(e,t){return has(this._nodes,e)?arguments.length>1&&(this._nodes[e]=t):(this._nodes[e]=arguments.length>1?t:this._defaultNodeLabelFn(e),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount),this}setNodes(e,t){return e.forEach(e=>{void 0!==t?this.setNode(e,t):this.setNode(e)}),this}node(e){return this._nodes[e]}hasNode(e){return has(this._nodes,e)}successors(e){let t=this._sucs[e];if(t)return Object.keys(t)}edgeCount(){return this._edgeCount}edges(){return Object.values(this._edgeObjs)}setEdge(e,t,n,a){e=""+e,t=""+t;let r=edgeArgsToId(this._isDirected,e,t,a);if(has(this._edgeLabels,r))return void 0!==n&&(this._edgeLabels[r]=n),this;this.setNode(e),this.setNode(t),this._edgeLabels[r]=void 0!==n?n:this._defaultEdgeLabelFn(e,t,a);let s=edgeArgsToObj(this._isDirected,e,t,a);return e=s.v,t=s.w,Object.freeze(s),this._edgeObjs[r]=s,incrementOrInitEntry(this._preds[t],e),incrementOrInitEntry(this._sucs[e],t),this._in[t][r]=s,this._out[e][r]=s,this._edgeCount++,this}edge(e,t,n){let a=1==arguments.length?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,e,t,n);return this._edgeLabels[a]}hasEdge(e,t,n){let a=1==arguments.length?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,e,t,n);return has(this._edgeLabels,a)}removeEdge(e,t,n){let a=1==arguments.length?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,e,t,n),r=this._edgeObjs[a];return r&&(e=r.v,t=r.w,delete this._edgeLabels[a],delete this._edgeObjs[a],decrementOrRemoveEntry(this._preds[t],e),decrementOrRemoveEntry(this._sucs[e],t),delete this._in[t][a],delete this._out[e][a],this._edgeCount--),this}outEdges(e,t){let n=this._out[e];if(n){let e=Object.values(n);return void 0===t?e:e.filter(function(e){return e.w===t})}}};function cyclicDependencies(e){let{referencesMaps:t}=parsePublicodes(e),n=function(e){let t=new T;return[...e.entries()].forEach(([e,n])=>{n.forEach(n=>{t.setEdge(e,n)})}),t}(t.referencesIn),a=(function(e){let t=0,n=[],a={},r=[];return e.nodes().forEach(function(s){Object.prototype.hasOwnProperty.call(a,s)||function dfs(s){let i=a[s]={onStack:!0,lowlink:t,index:t++};if(n.push(s),e.successors(s).forEach(function(e){Object.prototype.hasOwnProperty.call(a,e)?a[e].onStack&&(i.lowlink=Math.min(i.lowlink,a[e].index)):(dfs(e),i.lowlink=Math.min(i.lowlink,a[e].lowlink))}),i.lowlink===i.index){let e;let t=[];do a[e=n.pop()].onStack=!1,t.push(e);while(s!==e);r.push(t)}}(s)}),r})(n).filter(function(e){return e.length>1||1===e.length&&n.hasEdge(e[0],e[0])}),r=a.map(e=>e.reverse()),s=r.map(e=>(function(e,t){var n;let a=[];for(let r=0;r<t.length;r++){let s;let i=[];for(let a of function*(e){let n=e;for(;;)yield t[n++%t.length]}(r))if(void 0===s)i.push(a),s=a;else if(null==(n=e.get(s))?void 0:n.has(a)){if(i.includes(a)){i.splice(0,i.lastIndexOf(a));break}i.push(a),s=a}a.push(i)}let r=a.reduce((e,t)=>t.length>e.length?e:t);return r})(t.referencesIn,e)),i=r.map((e,t)=>(function(e,t,n){let a=new Set;return t.forEach(r=>{e.outEdges(r).filter(({w:e})=>t.includes(e)).forEach(({v:e,w:t})=>{a.add(`"${e}" -> "${t}"`+(edgeIsInCycle(n,e,t)?" [color=red]":""))})}),`digraph Cycle {
	${[...a].join(";\n	")};
}`})(n,e,s[t]));return[s,i]}var edgeIsInCycle=(e,t,n)=>{for(let a=0;a<e.length+1;a++)if(t===e[a]&&n===e[(a+1)%e.length])return!0;return!1},splitName=e=>e.split(" . "),joinName=e=>e.join(" . "),nameLeaf=e=>{var t;return null==(t=splitName(e).slice(-1))?void 0:t[0]},encodeRuleName=e=>null==e?void 0:e.replace(/\s\.\s/g,"/").replace(/-/g,"‑").replace(/\s/g,"-"),decodeRuleName=e=>e.replace(/\//g," . ").replace(/-/g," ").replace(/\u2011/g,"-"),contextNameToDottedName=e=>e.endsWith("$SITUATION")?ruleParent(e):e,ruleParent=e=>joinName(splitName(e).slice(0,-1));function ruleParents(e){return splitName(e).slice(0,-1).map((e,t,n)=>joinName(n.slice(0,t+1))).reverse()}var getChildrenRules=(e,t)=>{let n=Object.keys(e).filter(e=>e.startsWith(t)&&splitName(e).length===splitName(t).length+1);return n};function findCommonAncestor(e,t){let n=splitName(e),a=splitName(t),r=n.findIndex((e,t)=>a[t]!==e);return -1===r?e:joinName(n.slice(0,r))}function isAccessible(e,t,n){if(!(n in e))throw new c("InternalError",`La r\xe8gle "${n}" n'existe pas`,{dottedName:n});let a=findCommonAncestor(t,n),r=[n,...ruleParents(n),""],s=r.slice(0,Math.max(r.indexOf(a)-1,0));return s.every(t=>!(t in e)||!1===e[t].private)}function isExperimental(e,t){if(!(t in e))throw new c("InternalError",`La r\xe8gle "${t}" n'existe pas`,{dottedName:t});let n=[t,...ruleParents(t)];return n.some(t=>{var n;return t in e&&(null==(n=e[t].rawNode)?void 0:n.experimental)==="oui"})}function disambiguateReference(e,t="",n){let a=[t,...ruleParents(t),""].map(e=>e?e+" . "+n:n).sort((e,n)=>e===t?1:n===t?-1:0),r=a.filter(t=>t in e),s=r.find(n=>isAccessible(e,t,n));if(!r.length)throw new c("SyntaxError",`La r\xe9f\xe9rence "${n}" est introuvable.
V\xe9rifiez que l'orthographe et l'espace de nom sont corrects`,{dottedName:contextNameToDottedName(t)});if(!s)throw new c("SyntaxError",`La r\xe8gle "${r[0]}" n'est pas accessible depuis "${t}".
Cela vient du fait qu'elle est priv\xe9e ou qu'un de ses parent est priv\xe9`,{dottedName:contextNameToDottedName(t)});return s}function ruleWithDedicatedDocumentationPage(e){return!0!==e.virtualRule&&"groupe"!==e.type&&"texte"!==e.type&&"paragraphe"!==e.type&&"notification"!==e.type}function updateReferencesMapsFromReferenceNode(e,t,n){"reference"===e.nodeKind&&(addToMapSet(t.referencesIn,n??e.contextDottedName,e.dottedName),addToMapSet(t.rulesThatUse,e.dottedName,n??e.contextDottedName))}function disambiguateReferenceNode(e,t){return"reference"!==e.nodeKind?void 0:(e.dottedName||(e.dottedName=disambiguateReference(t,e.contextDottedName,e.name),e.title=t[e.dottedName].title,e.acronym=t[e.dottedName].rawNode.acronyme),e)}var C=0,U={};function parseReplacements(e,t){return e?(Array.isArray(e)?e:[e]).map(e=>{"string"==typeof e&&(e={règle:e});let n=parse(e.règle,t),a=parse(e.par??t.dottedName,t),[r,s]=[e.dans??[],e["sauf dans"]??[]].map(e=>Array.isArray(e)?e:[e]).map(e=>e.map(e=>parse(e,t)));return{nodeKind:"replacementRule",rawNode:e,definitionRule:parse(t.dottedName,t),replacedReference:n,replacementNode:a,whiteListedNames:r,blackListedNames:s,remplacementRuleId:C++}}):[]}function makeReplacementInliner(e,t,n){return makeASTTransformer((n,a)=>{if("replacementRule"===n.nodeKind||"inversion"===n.nodeKind||"une possibilit\xe9"===n.nodeKind)return!1;if("recalcul"===n.nodeKind)return __spreadProps(__spreadValues({},n),{explanation:__spreadProps(__spreadValues({},n.explanation),{recalculNode:a(n.explanation.recalculNode),amendedSituation:n.explanation.amendedSituation.map(([e,t])=>[e,a(t)])})});if("reference"===n.nodeKind){if(!n.dottedName)throw new m(n);let a=function(e,t,n){let a=t.filter(({definitionRule:t})=>t.dottedName!==e.contextDottedName).filter(({whiteListedNames:t})=>!t.length||t.some(t=>e.contextDottedName.startsWith(t.dottedName))).filter(({blackListedNames:t})=>!t.length||t.every(t=>!e.contextDottedName.startsWith(t.dottedName))).sort((e,t)=>{let n=+!!t.whiteListedNames.length-+!!e.whiteListedNames.length,a=+!!t.blackListedNames.length-+!!e.blackListedNames.length;return n||a});if(!a.length)return e;a.length;let r=a.map(e=>e.remplacementRuleId).join("-");return U[r]??(U[r]={nodeKind:"variations",sourceMap:{mecanismName:"replacement"},rawNode:e.rawNode,explanation:[...a.map(e=>({condition:e.definitionRule,consequence:e.replacementNode})),{condition:defaultNode(!0),consequence:e}]}),U[r]}(n,e[n.dottedName]??[],0);return makeASTVisitor(e=>(updateReferencesMapsFromReferenceNode(e,t,n.contextDottedName),"continue"))(a),a}})}function evaluateDisablingParent(e,t){var n,a,r;if(t.private)return{ruleDisabledByItsParent:!1,parentMissingVariables:{}};let s=e.context.nodesTypes,i=t.explanation.parents.find(e=>{var t,n;return(null==(t=s.get(e))?void 0:t.isNullable)||(null==(n=s.get(e))?void 0:n.type)==="boolean"});if(!i)return{ruleDisabledByItsParent:!1,parentMissingVariables:{}};if(!e.cache._meta.parentRuleStack.includes(t.dottedName)){e.cache._meta.parentRuleStack.unshift(t.dottedName);let r=defaultNode(!1);if((null==(n=s.get(i))?void 0:n.isNullable)&&(r=e.evaluateNode({nodeKind:"est non applicable",explanation:i})),!0!==r.nodeValue&&(null==(a=s.get(i))?void 0:a.type)==="boolean"&&(r=e.evaluateNode({nodeKind:"operation",operator:"=",operationKind:"=",explanation:[i,defaultNode(!1)]})),e.cache._meta.parentRuleStack.shift(),!0===r.nodeValue)return{ruleDisabledByItsParent:!0,parentMissingVariables:r.missingVariables??{},nullableParent:i}}let o={};if((null==(r=s.get(i))?void 0:r.type)==="boolean"){let t=e.evaluateNode(i);return o=t.missingVariables??{},{ruleDisabledByItsParent:!1===t.nodeValue,parentMissingVariables:o,nullableParent:i}}return{ruleDisabledByItsParent:!1,parentMissingVariables:o,nullableParent:i}}function parseEstNonApplicable(e,t){let n=parse(e,t);return{explanation:n,nodeKind:"est non applicable"}}registerEvaluationFunction("rule",function(e){var t;let{ruleDisabledByItsParent:n,nullableParent:a,parentMissingVariables:r}=evaluateDisablingParent(this,e),s=__spreadProps(__spreadValues({},e.explanation.valeur),{nodeValue:null,missingVariables:{}});n||(this.cache._meta.evaluationRuleStack.filter(t=>t===e.dottedName).length>1?s={nodeValue:void 0}:(this.cache._meta.evaluationRuleStack.unshift(e.dottedName),s=this.evaluateNode(e.explanation.valeur),this.cache._meta.evaluationRuleStack.shift())),s.missingVariables??(s.missingVariables={}),t=s,!0!==e.private&&isAccessible(this.context.parsedRules,"",e.dottedName)&&(void 0!==t.nodeValue||Object.keys(t.missingVariables).length||(t.missingVariables[e.dottedName]=1));let i=__spreadProps(__spreadValues(__spreadProps(__spreadValues({},s),{missingVariables:mergeMissing(s.missingVariables,r)}),e),{explanation:{parents:e.explanation.parents,valeur:s,nullableParent:a,ruleDisabledByItsParent:n}});return i}),parseEstNonApplicable.nom="est non applicable";var isNotApplicable=e=>({nodeKind:"est non applicable",explanation:e});function uniroot(e,t,n,a=0,r=100,s=0){let i=t,o=n,l=i,u=e(i),d=e(o),p=u,c,m,f,h,v,b;for(;r-- >0;){if(f=o-i,Math.abs(p)<Math.abs(d)&&(i=o,o=l,l=i,u=d,d=p,p=u),c=1e-15*Math.abs(o)+a/2,Math.abs(m=(l-o)/2)<=c||0===d)return o;if(Math.abs(f)>=c&&Math.abs(u)>Math.abs(d)){let e,t;let n=l-o;i===l?(h=n*(e=d/u),v=1-e):(v=u/p,e=d/p,h=(t=d/u)*(n*v*(v-e)-(o-i)*(e-1)),v=(v-1)*(e-1)*(t-1)),h>0?v=-v:h=-h,h<.75*n*v-Math.abs(c*v)/2&&h<Math.abs(f*v/2)&&(m=h/v)}if(Math.abs(m)<c&&(m=m>0?c:-c),i=o,u=d,o+=m,((d=e(o))>0&&p>0||d<0&&p<0)&&(l=i,p=u),Math.abs(d)<a)return o;Math.abs(d)<s&&(b=o)}return b}registerEvaluationFunction("est non applicable",function(e){var t,n,a,r;let s=e.explanation;if((null==(t=this.context.nodesTypes.get(s))?void 0:t.isNullable)===!1&&"rule"!==s.nodeKind)return __spreadProps(__spreadValues({},e),{nodeValue:!1,missingVariables:{}});if(this.cache.nodes.has(s)&&void 0!==this.cache.nodes.get(s))return __spreadProps(__spreadValues({},e),{nodeValue:(null==(n=this.cache.nodes.get(s))?void 0:n.nodeValue)===null,missingVariables:(null==(a=this.cache.nodes.get(s))?void 0:a.missingVariables)??{}});switch(s.nodeKind){case"rule":let{ruleDisabledByItsParent:i,parentMissingVariables:o}=evaluateDisablingParent(this,s);if(i)return __spreadProps(__spreadValues({},e),{nodeValue:!0,missingVariables:o});let l=this.evaluateNode(isNotApplicable(s.explanation.valeur)),u=mergeMissing(o,l.missingVariables);return!1===l.nodeValue&&(null==(r=this.context.nodesTypes.get(this.context.parsedRules[`${s.dottedName} . $SITUATION`]))?void 0:r.isNullable)&&!Object.keys(l.missingVariables).length&&(u[s.dottedName]=1),__spreadProps(__spreadValues({},e),{nodeValue:l.nodeValue,missingVariables:u});case"reference":if(!s.dottedName)throw new c("InternalError","Missing dottedName",{});return __spreadValues(__spreadValues({},this.evaluateNode(isNotApplicable(this.context.parsedRules[s.dottedName]))),e);case"condition":return __spreadValues(__spreadValues({},this.evaluateNode(__spreadProps(__spreadValues({},s),{explanation:{si:s.explanation.si,alors:isNotApplicable(s.explanation.alors),sinon:isNotApplicable(s.explanation.sinon)}}))),e)}let d=this.evaluateNode(s);return __spreadProps(__spreadValues({},e),{nodeValue:void 0===d.nodeValue?void 0:null===d.nodeValue,missingVariables:d.missingVariables})}),registerEvaluationFunction("grille",function(e){var t;let n;let a=this.evaluateNode.bind(this),r=this.evaluateNode(e.explanation.assiette),s=this.evaluateNode(e.explanation.multiplicateur),i=evaluatePlafondUntilActiveTranche.call(this,{parsedTranches:e.explanation.tranches,assiette:r,multiplicateur:s}).map(e=>{if(!1===e.isActive)return e;let t=a(e.montant);return __spreadProps(__spreadValues({},e),{montant:t,nodeValue:t.nodeValue,unit:t.unit,missingVariables:mergeAllMissing([t,e])})}),o=i.find(e=>e.isActive);n=o?[o]:!1===i[i.length-1].isAfterActive?[{nodeValue:!1}]:i.filter(e=>void 0===e.isActive);let l=!!n[0]&&(void 0===n[0].isActive?void 0:n[0].nodeValue);return __spreadProps(__spreadValues({},e),{nodeValue:l,missingVariables:mergeAllMissing([r,s,...n]),explanation:__spreadProps(__spreadValues({},e.explanation),{assiette:r,multiplicateur:s,tranches:i}),unit:(null==(t=n[0])?void 0:t.unit)??void 0})}),registerEvaluationFunction("inversion",function(e){let t,n;let a=this.shallowCopy();if(this.cache._meta.evaluationRuleStack.slice(1).includes(e.explanation.ruleToInverse))return __spreadValues(__spreadValues({},N),e);a.cache._meta.parentRuleStack=[...this.cache._meta.parentRuleStack],a.cache._meta.evaluationRuleStack=[...this.cache._meta.evaluationRuleStack];let r=e.explanation.inversionCandidates.find(e=>{if(this.cache._meta.evaluationRuleStack.includes(e.dottedName))return!1;let t=a.evaluateNode(a.context.parsedRules[`${e.dottedName} . $SITUATION`]);return"number"==typeof t.nodeValue&&!(e.dottedName in t.missingVariables)});if(void 0===r)return __spreadProps(__spreadValues({},e),{nodeValue:void 0,missingVariables:__spreadProps(__spreadValues({},Object.fromEntries(e.explanation.inversionCandidates.map(e=>[e.dottedName,1]))),{[e.explanation.ruleToInverse]:1})});let s=a.evaluateNode(r),i=0;a.setSituation({[r.dottedName]:N},{keepPreviousSituation:!0});let evaluateWithValue=n=>(i++,a.setSituation({[e.explanation.ruleToInverse]:{nodeValue:n,nodeKind:"constant",type:"number",unit:s.unit}},{keepPreviousSituation:!0}),t=a.evaluateNode(r)),o=s.nodeValue,l=evaluateWithValue(o),u=l.nodeValue,d=u>o?.9:1.2,p=void 0!==u?o*o*d/u:2e3,c=evaluateWithValue(p),m=c.nodeValue,f=this.context.inversionMaxIterations??10;if(void 0!==u||void 0!==m){let e=void 0!==m&&m<o&&(m>u||u>o)?p:void 0!==u&&u<o&&(u>m||m>o)?o:-1e6,t=void 0!==m&&m>o&&(m<u||u<o)?p:void 0!==u&&u>o&&(u<m||m<o)?o:1e8;n=uniroot(e=>{let t=e===o?u:e===p?m:evaluateWithValue(e).nodeValue;return t-o},e,t,.1,f,1)}return void 0===n&&(this.cache._meta.inversionFail=!0),(t.traversedVariables??[]).forEach(e=>this.cache._meta.traversedVariablesStack[0].add(e)),__spreadProps(__spreadValues({},e),{nodeValue:n,unit:s.unit,explanation:__spreadProps(__spreadValues({},e.explanation),{inversionGoal:r,numberOfIteration:i}),missingVariables:t.missingVariables})});var I=createParseInlinedMecanismWithArray("le maximum de",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,t)=>({condition:{si:{"est non applicable":"$INTERNAL valeur"},alors:"$INTERNAL acc",sinon:{condition:{si:{ou:[{"est non applicable":"$INTERNAL acc"},{">":["$INTERNAL valeur","$INTERNAL acc"]}]},alors:"$INTERNAL valeur",sinon:"$INTERNAL acc"}}},avec:{"[priv\xe9] $INTERNAL valeur":t,"[priv\xe9] $INTERNAL acc":e}}),g)),M=createParseInlinedMecanismWithArray("le minimum de",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,t)=>({condition:{si:{"est non applicable":"$INTERNAL valeur"},alors:"$INTERNAL acc",sinon:{condition:{si:{ou:[{"est non applicable":"$INTERNAL acc"},{"<":["$INTERNAL valeur","$INTERNAL acc"]}]},alors:"$INTERNAL valeur",sinon:"$INTERNAL acc"}}},avec:{"[priv\xe9] $INTERNAL valeur":t,"[priv\xe9] $INTERNAL acc":e}}),g)),L=createParseInlinedMecanism("non applicable si",{"non applicable si":{},valeur:{}},{condition:{si:"non applicable si = non",alors:"valeur",sinon:g}});registerEvaluationFunction("une possibilit\xe9",e=>__spreadProps(__spreadValues({},e),{missingVariables:{[e.context]:1},nodeValue:void 0}));var D={"*":[(e,t)=>e*t,"\xd7"],"/":[(e,t)=>0===t?null:e/t,"∕"],"+":[(e,t)=>e+t],"-":[(e,t)=>e-t,"−"],"<":[(e,t)=>e<t],"<=":[(e,t)=>e<=t,"≤"],">":[(e,t)=>e>t],">=":[(e,t)=>e>=t,"≥"],"=":[(e,t)=>(e??!1)===(t??!1)],"!=":[(e,t)=>(e??!1)!==(t??!1),"≠"],et:[(e,t)=>(e??!1)&&(t??!1)],ou:[(e,t)=>(e??!1)||(t??!1)]},parseOperation=(e,t)=>(n,a)=>{let r=n.map(e=>parse(e,a));return __spreadProps(__spreadValues({},n),{nodeKind:"operation",operationKind:e,operator:t||e,explanation:r})};registerEvaluationFunction("operation",function(e){var t;let n=this.evaluateNode(e.explanation[0]),a=__spreadProps(__spreadValues({},e),{missingVariables:{}});if(null===n.nodeValue&&["<",">","<=",">=","/","*","-","et"].includes(e.operationKind)||0===n.nodeValue&&["/","*"].includes(e.operationKind)||!1===n.nodeValue&&"et"===e.operationKind||!0===n.nodeValue&&"ou"===e.operationKind)return __spreadProps(__spreadValues({},a),{nodeValue:"et"!==e.operationKind&&n.nodeValue,missingVariables:n.missingVariables});let r=this.evaluateNode(e.explanation[1]);if(a.explanation=[n,r],null===r.nodeValue&&["<",">","<=",">=","/","*","et"].includes(e.operationKind)||0===r.nodeValue&&["*"].includes(e.operationKind)||!1===r.nodeValue&&"et"===e.operationKind||!0===r.nodeValue&&"ou"===e.operationKind)return __spreadProps(__spreadValues({},a),{nodeValue:"et"!==e.operationKind&&r.nodeValue,missingVariables:r.missingVariables});a.missingVariables=mergeAllMissing([n,r]),(void 0===n.nodeValue||void 0===r.nodeValue)&&(a=__spreadProps(__spreadValues({},a),{nodeValue:void 0}));let s=["+","-"].includes(e.operationKind)&&"%"===serializeUnit(r.unit)&&"%"!==serializeUnit(n.unit);if(!("nodeValue"in a)&&!["/","*"].includes(e.operationKind)&&!s)try{n.unit&&"unit"in r?r=convertNodeToUnit(n.unit,r):r.unit&&(n=convertNodeToUnit(r.unit,n))}catch(t){warning(this.context.logger,`Dans l'expression '${e.operationKind}', la partie gauche (unit\xe9: ${serializeUnit(n.unit)}) n'est pas compatible avec la partie droite (unit\xe9: ${serializeUnit(r.unit)})`,t)}let i=D[e.operationKind][0],o=n.nodeValue,l=r.nodeValue;if(a.nodeValue="nodeValue"in a?a.nodeValue:["<",">","<=",">=","*","/"].includes(e.operationKind)&&null===r.nodeValue?null:[o,l].every(e=>{var t;return"string"==typeof e&&(null==(t=e.match)?void 0:t.call(e,/^[\d]{2}\/[\d]{2}\/[\d]{4}$/))})?i(convertToDate(o),convertToDate(l)):i(o,l),"*"===e.operationKind&&(null==(t=inferUnit("*",[n.unit,r.unit]))?void 0:t.numerators.includes("%"))){let e=inferUnit("*",[n.unit,r.unit]),t=a.nodeValue;return __spreadProps(__spreadValues({},a),{nodeValue:"number"==typeof t?t/100:t,unit:inferUnit("*",[e,{numerators:[],denominators:["%"]}])})}if(s){let t=inferUnit("*",[n.unit,r.unit]);return __spreadProps(__spreadValues({},a),{nodeValue:"number"==typeof n.nodeValue&&"number"==typeof r.nodeValue?n.nodeValue*(1+r.nodeValue/100*("-"===e.operationKind?-1:1)):a.nodeValue,unit:inferUnit("*",[t,{numerators:[],denominators:["%"]}])})}return"*"===e.operationKind||"/"===e.operationKind||"-"===e.operationKind||"+"===e.operationKind?__spreadProps(__spreadValues({},a),{unit:inferUnit(e.operationKind,[n.unit,r.unit])}):a});var K=Object.fromEntries(Object.entries(D).map(([e,[t,n]])=>[e,parseOperation(e,n)])),F=createParseInlinedMecanism("par d\xe9faut",{"par d\xe9faut":{},valeur:{}},{condition:{si:{"est non d\xe9fini":"valeur"},alors:"par d\xe9faut",sinon:"valeur"}}),W=createParseInlinedMecanism("plafond",{plafond:{},valeur:{}},{condition:{si:{et:["plafond != non","valeur > plafond"]},alors:"plafond",sinon:"valeur"}}),q=createParseInlinedMecanism("plancher",{plancher:{},valeur:{}},{condition:{si:{et:["plancher != non","valeur < plancher"]},alors:"plancher",sinon:"valeur"}}),z=createParseInlinedMecanism("produit",{assiette:{},taux:{"par d\xe9faut":"100%"},facteur:{"par d\xe9faut":1},plafond:{"par d\xe9faut":g}},{"*":[{"*":["taux","facteur"]},{valeur:"assiette",plafond:"plafond"}],"simplifier l'unit\xe9":"oui"});function parseRésoudreRéférenceCirculaire(e,t){return{explanation:{ruleToSolve:t.dottedName,valeur:parse(e.valeur,t)},nodeKind:"r\xe9soudre r\xe9f\xe9rence circulaire"}}function parseSimplifierUnité(e,t){let n=parse(e.valeur,t);return{explanation:n,nodeKind:"simplifier unit\xe9"}}registerEvaluationFunction("recalcul",function(e){if(this.cache._meta.currentRecalcul===e.explanation.recalculNode)return __spreadValues(__spreadValues({},g),e);let t=Object.fromEntries(e.explanation.amendedSituation.filter(([e,t])=>{let n=this.evaluateNode(e),a=this.evaluateNode(t);return n.nodeValue!==a.nodeValue||serializeUnit(n.unit)!==serializeUnit(a.unit)}).map(([e,t])=>[e.dottedName,t])),n=this;Object.keys(t).length&&((n=this.shallowCopy().setSituation(t,{keepPreviousSituation:!0})).subEngineId=this.subEngines.length,this.subEngines.push(n)),n.cache._meta.currentRecalcul=e.explanation.recalculNode;let a=n.evaluateNode(e.explanation.recalculNode);return delete n.cache._meta.currentRecalcul,__spreadValues(__spreadProps(__spreadValues({},e),{nodeValue:a.nodeValue,explanation:__spreadProps(__spreadValues({},e.explanation),{recalcul:a,subEngineId:n.subEngineId}),missingVariables:a.missingVariables}),"unit"in a&&{unit:a.unit})}),parseRésoudreRéférenceCirculaire.nom="r\xe9soudre la r\xe9f\xe9rence circulaire",registerEvaluationFunction("r\xe9soudre r\xe9f\xe9rence circulaire",function(e){if(this.cache._meta.evaluationRuleStack.slice(1).includes(e.explanation.ruleToSolve))return __spreadValues(__spreadValues({},N),e);let t=0,n=this.shallowCopy();n.cache._meta.parentRuleStack=[...this.cache._meta.parentRuleStack],n.cache._meta.evaluationRuleStack=[...this.cache._meta.evaluationRuleStack];let a=this.context.inversionMaxIterations??25,evaluateWithValue=a=>(t++,n.setSituation({[e.explanation.ruleToSolve]:__spreadProps(__spreadValues({},N),{nodeValue:a})},{keepPreviousSituation:!0}),n.evaluateNode(e.explanation.valeur)),r=Symbol("inversion failed"),s=r,i=evaluateWithValue(1),o=i.nodeValue,l=i.unit,u=0;return void 0!==o&&(s=uniroot(e=>{if(1===e)return o-1;i=evaluateWithValue(e);let t=i.nodeValue;return u++,t-e},-1e6,1e8,.5,a,2)),s===r&&(s=void 0,this.cache._meta.inversionFail=!0),void 0!==s&&(i=evaluateWithValue(s)),__spreadProps(__spreadValues({},e),{unit:l,nodeValue:s,explanation:__spreadProps(__spreadValues({},e.explanation),{valeur:i,numberOfIterations:t}),missingVariables:i.missingVariables})}),parseSimplifierUnité.nom="simplifier l'unit\xe9",registerEvaluationFunction("simplifier unit\xe9",function(e){let t=this.evaluateNode(e.explanation),n=t.nodeValue,a=__spreadProps(__spreadValues(__spreadValues({},t),e),{explanation:t});if(null==n)return a;if(!t.unit)return __spreadProps(__spreadValues({},a),{unit:t.unit});let r=simplifyUnit(t.unit);return __spreadProps(__spreadValues({},a),{nodeValue:"number"==typeof n?convertUnit(t.unit,r,n):n,unit:r})});var B=createParseInlinedMecanism("dans la situation",{valeur:{},"dans la situation":{}},{condition:{si:{"est non d\xe9fini":"dans la situation"},alors:"valeur",sinon:"dans la situation"}}),J=createParseInlinedMecanismWithArray("somme",{valeur:{type:"liste"}},({valeur:e})=>[...e].reverse().reduce((e,t)=>({"+":[t,e]}),g));registerEvaluationFunction("taux progressif",function(e){let t=this.evaluateNode.bind(this),n=this.evaluateNode(e.explanation.assiette),a=this.evaluateNode(e.explanation.multiplicateur),r=evaluatePlafondUntilActiveTranche.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:a}),s=__spreadProps(__spreadValues({},e),{explanation:{tranches:r,assiette:n,multiplicateur:a},unit:parseUnit("%")}),i=r[r.length-1];if(r.every(({isActive:e})=>!1===e)||i.isActive&&i.plafond.nodeValue===1/0){let e=convertNodeToUnit(parseUnit("%"),t(i.taux)),{nodeValue:n,missingVariables:a}=e;return i.taux=e,i.nodeValue=n,i.missingVariables=a,__spreadProps(__spreadValues({},s),{nodeValue:n,missingVariables:a})}if(r.every(({isActive:e})=>!0!==e)||"number"!=typeof n.nodeValue)return __spreadProps(__spreadValues({},s),{nodeValue:void 0,missingVariables:mergeAllMissing(r)});let o=r.findIndex(({isActive:e})=>!0===e),l=r[o];l.taux=convertNodeToUnit(parseUnit("%"),t(l.taux));let u=r[o-1];u&&(u.taux=convertNodeToUnit(parseUnit("%"),t(u.taux)),u.isActive=!0);let d=u?u.taux:l.taux,p=[d,l.taux];if(p.some(e=>void 0===e.nodeValue))return l.nodeValue=void 0,__spreadProps(__spreadValues({},s),{nodeValue:void 0,missingVariables:mergeAllMissing(p)});let c=d.nodeValue,m=l.taux.nodeValue,f=l.plancherValue,h=l.plafondValue,v=c+(n.nodeValue-f)*((m-c)/(h-f));return l.nodeValue=v,__spreadProps(__spreadValues({},s),{nodeValue:v,missingVariables:{}})});var G="texte";function parseTexte(e,t){let n=[],a=0;for(let{0:r,index:s}of e.matchAll(/{{(.|\n)*?}}/g)){let i=r.slice(2,-2).trim(),o=parse(i,t);n.push(e.substring(a,s),o),a=(s??0)+r.length}return n.push(e.slice(a)),{nodeKind:G,explanation:n}}parseTexte.nom=G,registerEvaluationFunction(G,function(e){let t=e.explanation.map(e=>"string"==typeof e?e:this.evaluateNode(e));return __spreadProps(__spreadValues({},e),{explanation:t,missingVariables:mergeAllMissing(e.explanation.filter(e=>"string"!=typeof e)),nodeValue:t.map(e=>"string"==typeof e?e:function(e,{language:t="fr",displayedUnit:n,formatUnit:a,precision:r=2}={}){let s="number"==typeof e||null==e?e:e.nodeValue;if("number"==typeof s&&Number.isNaN(s))return"Erreur dans le calcul du nombre";if(void 0===s)return"Pas encore d\xe9fini";if(null===s)return"Non applicable";if("string"==typeof s)return s.replace("\\n","\n");if("object"==typeof s)return s.nom;if("boolean"==typeof s)return j[t][s];if("number"==typeof s){let i="number"!=typeof e&&void 0!==e&&"unit"in e?e.unit:void 0;if(i){let e=simplifyNodeUnit({unit:i,nodeValue:s});i=e.unit,s=e.nodeValue}return(function({maximumFractionDigits:e,minimumFractionDigits:t,language:n,formatUnit:a,unit:r,nodeValue:s}){if("number"!=typeof s)return s;let i=r?serializeUnit(r,s,a):void 0;switch(i){case"€":return numberFormatter({style:"currency",maximumFractionDigits:e,minimumFractionDigits:t,language:n})(s);case"%":return numberFormatter({style:"percent",maximumFractionDigits:e,language:n})(s/100);default:return numberFormatter({style:"decimal",minimumFractionDigits:t,maximumFractionDigits:e,language:n})(s)+("string"==typeof i?`\xa0${i}`:"")}})({minimumFractionDigits:0,maximumFractionDigits:r,language:t,formatUnit:a,nodeValue:s,unit:n??i}).trim()}}(e)).join("")})});var H=createParseInlinedMecanismWithArray("toutes ces conditions",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,t)=>({et:[e,t]}),"oui")),Z=createParseInlinedMecanismWithArray("une de ces conditions",{valeur:{type:"liste"}},({valeur:e})=>e.reduce((e,t)=>({ou:[e,t]}),"non"));function parseUnité(e,t){let n=parse(e.valeur,t),a=parseUnit(e.unité,t.getUnitKey);return{explanation:n,unit:a,nodeKind:parseUnité.nom}}function parseVariableManquante(e,t){return{missingVariable:e["variable manquante"],nodeKind:parseVariableManquante.nom,explanation:parse(e.valeur,t)}}parseUnité.nom="unit\xe9",registerEvaluationFunction(parseUnité.nom,function(e){let t=this.evaluateNode(e.explanation),n=t.nodeValue;if(null!==n&&"unit"in e)try{n=convertUnit(t.unit,e.unit,t.nodeValue)}catch(e){warning(this.context.logger,"Erreur lors de la conversion d'unit\xe9 explicite",{dottedName:this.cache._meta.evaluationRuleStack[0]},e)}return __spreadProps(__spreadValues({},e),{nodeValue:n,explanation:t,missingVariables:t.missingVariables})}),parseVariableManquante.nom="variable manquante",registerEvaluationFunction(parseVariableManquante.nom,function(e){let t=this.evaluateNode(e.explanation),n=Object.values(t.missingVariables).reduce((e,t)=>e>t?e:t,0);return __spreadProps(__spreadValues(__spreadValues({},t),e),{explanation:t,missingVariables:mergeMissing(t.missingVariables,{[e.missingVariable]:n+1})})});var devariate=(e,t,n)=>{if("valeur"===e)return parse(t,n);let{variations:a}=t,r=__objRest(t,["variations"]),s=parse({variations:a.map(({alors:t,sinon:n,si:a})=>{let s=t??n,{attributs:i}=s,o=__objRest(s,["attributs"]);return __spreadValues({[void 0!==t?"alors":"sinon"]:__spreadProps(__spreadValues({},i),{[e]:__spreadValues(__spreadValues({},r),o)})},void 0!==a&&{si:a})})},n);return s};registerEvaluationFunction("variations",function(e){let[t,n,a]=e.explanation.reduce(([e,t,n,a],{condition:r,consequence:s},i)=>{let o;if(!0===a)return[e,[...t,{condition:r,consequence:s}],n,a];let l=this.evaluateNode(r),u=void 0===a?a:!a&&(void 0===l.nodeValue?void 0:!1!==l.nodeValue&&null!==l.nodeValue);if(!1===u||null===u)return[e,[...t,{condition:l,consequence:s}],n,a];if(!1!==l.nodeValue&&null!==l.nodeValue&&(o=this.evaluateNode(s),n))try{o=convertNodeToUnit(n,o)}catch(e){warning(this.context.logger,`L'unit\xe9 de la branche n\xb0 ${i+1} du m\xe9canisme 'variations' n'est pas compatible avec celle d'une branche pr\xe9c\xe9dente`,{dottedName:this.cache._meta.evaluationRuleStack[0]},e)}return[u&&(null==o?void 0:o.nodeValue),[...t,{condition:l,consequence:o??s}],n||(null==o?void 0:o.unit),a||u]},[null,[],void 0,!1]);return __spreadProps(__spreadValues(__spreadProps(__spreadValues({},e),{nodeValue:t}),void 0!==a&&{unit:a}),{explanation:n,missingVariables:n.reduce((e,{condition:t,consequence:n})=>mergeMissing(e,mergeMissing(bonus(t.missingVariables),"nodeValue"in t&&!1!==t.nodeValue&&null!==t.nodeValue?n.missingVariables:{})),{})})}),registerEvaluationFunction("reference",function(e){if(!e.dottedName)throw new m(e);let t=this.evaluateNode(this.context.parsedRules[e.dottedName]);return delete t.sourceMap,__spreadValues(__spreadValues({},t),e)});var{Grammar:Y,Parser:Q}=r;function parse(e,t){if(void 0==e)throw new c("SyntaxError",`
	Une des valeurs de la formule est vide.
	V\xe9rifiez que tous les champs \xe0 droite des deux points sont remplis`,{dottedName:t.dottedName});if("boolean"==typeof e)throw new c("SyntaxError",`
Les valeurs bool\xe9ennes true / false ne sont accept\xe9es.
Utilisez leur contrepartie fran\xe7aise : 'oui' / 'non'`,{dottedName:t.dottedName});let n="object"==typeof e?e:function(e,t){let n=(e+"").replace(/\s*\n\s*/g," ").trim();try{let[e]=new Q(X).feed(n).results;if(null==e)throw new m({expression:n,parseResult:`${JSON.stringify(e)}`,notice:"L'erreur se situe tr\xe8s probablement dans le fichier `nearley.ne`"});return e}catch(e){if(e instanceof m)throw e;throw new c("SyntaxError",`\`${n}\` n'est pas une expression valide`,{dottedName:t.dottedName},e)}}(e,t);return"nodeKind"in n?n:"nom"in n?function(e,t){var n;let a=!!("oui"===e.privé||e.nom.startsWith("[priv\xe9] ")),r=e.nom.replace(/^\[privé\] /,""),s=[t.dottedName,r].filter(Boolean).join(" . "),i=nameLeaf(s),o=(n=e.titre??i)&&n[0].toUpperCase()+n.slice(1);if(t.parsedRules[s])throw new c("EvaluationError",`La r\xe9f\xe9rence '${s}' a d\xe9j\xe0 \xe9t\xe9 d\xe9finie`,{dottedName:s});let l=__spreadValues(__spreadValues({},Object.fromEntries(Object.entries(e).filter(([e])=>en.includes(e)))),"formule"in e&&{valeur:e.formule});a||s.endsWith("$SITUATION")||(l["dans la situation"]=`${s} . $SITUATION`,l.avec=__spreadProps(__spreadValues({},l.avec??{}),{"[priv\xe9] $SITUATION":__spreadProps(__spreadValues({},y),{isNullable:"oui"===e["possiblement non applicable"]})}),null!=l["par d\xe9faut"]&&(l["par d\xe9faut"]={valeur:l["par d\xe9faut"],"variable manquante":s}));let u=__spreadProps(__spreadValues({},t),{dottedName:s});t.parsedRules[s]=void 0;let d={valeur:parse(l,u),parents:ruleParents(s).map(e=>parse(e,u)).map(e=>__spreadProps(__spreadValues({},e),{dottedName:e.name}))};return t.parsedRules[s]={dottedName:s,replacements:[...parseReplacements(e["rend non applicable"],u).map(e=>__spreadProps(__spreadValues({},e),{replacementNode:g})),...parseReplacements(e.remplace,u)],title:o,private:a,suggestions:Object.fromEntries(Object.entries(e.suggestions??{}).map(([e,t])=>[e,parse(t,u)])),nodeKind:"rule",explanation:d,rawNode:e,virtualRule:!!t.dottedName},t.dottedName?parse(r,t):t.parsedRules[s]}(n,t):__spreadProps(__spreadValues({},function(e,t){var n;let a=ee.find(t=>t.nom in e);if(!a)return parseMecanism(e,t);let{[n=a.nom]:r}=e,s=__objRest(e,[__restKey(n)]);return parseMecanism({[a.nom]:{valeur:s,[a.nom]:r}},t)}(n,t)),{rawNode:e})}var X=Y.fromCompiled({Lexer:x,ParserRules:_,ParserStart:"main"});function parseMecanism(e,t){if(Array.isArray(e))throw new c("SyntaxError",`
Il manque le nom du m\xe9canisme pour le tableau : [${e.map(e=>`'${e}'`).join(", ")}]
Les m\xe9canisme possibles sont : 'somme', 'le maximum de', 'le minimum de', 'toutes ces conditions', 'une de ces conditions'.
		`,{dottedName:t.dottedName});let n=Object.keys(e);if(n.length>1)throw new c("SyntaxError",`
Les m\xe9canismes suivants se situent au m\xeame niveau : ${n.map(e=>`'${e}'`).join(", ")}
Cela vient probablement d'une erreur dans l'indentation
	`,{dottedName:t.dottedName});if(0===n.length)return{nodeKind:"constant",nodeValue:void 0};let a=Object.keys(e)[0],r=e[a],s=et[a];if(!s)throw new c("SyntaxError",`Le m\xe9canisme "${a}" est inconnu.

V\xe9rifiez qu'il n'y ait pas d'erreur dans l'orthographe du nom.`,{dottedName:t.dottedName});try{if(null==r?void 0:r.composantes)return decompose(a,r,t);if((null==r?void 0:r.variations)&&Object.values(r).length>1)return devariate(a,r,t);return s(r,t)}catch(e){if(e instanceof c)throw e;throw new c("SyntaxError",a?`\u27A1\uFE0F Dans le m\xe9canisme ${a}
${e.message}`:e.message,{dottedName:t.dottedName})}}var ee=[parseVariableManquante,parseAvec,w,L,parseArrondi,parseUnité,parseSimplifierUnité,q,W,F,B,parseRésoudreRéférenceCirculaire,V],et=__spreadProps(__spreadValues(__spreadValues({},K),ee.reduce((e,t)=>__spreadValues({[t.nom]:t},e),{})),{"inversion num\xe9rique":(e,t)=>{if(!e.avec)throw new c("SyntaxError","Une formule d'inversion doit pr\xe9ciser _avec_ quoi on peut inverser la variable",{dottedName:t.dottedName});return{explanation:{ruleToInverse:t.dottedName,inversionCandidates:e.avec.map(e=>__spreadValues({},parse(e,t)))},nodeKind:"inversion"}},"le maximum de":I,"le minimum de":M,"taux progressif":function(e,t){let n={assiette:parse(e.assiette,t),multiplicateur:e.multiplicateur?parse(e.multiplicateur,t):defaultNode(1),tranches:parseTranches(e.tranches,t)};return{explanation:n,nodeKind:"taux progressif"}},"toutes ces conditions":H,"est non d\xe9fini":parseEstNonDéfini,"est non applicable":parseEstNonApplicable,"est applicable":A,"est d\xe9fini":O,"une de ces conditions":Z,"une possibilit\xe9":(e,t)=>(Array.isArray(e)&&(e={possibilités:e}),__spreadProps(__spreadValues({},e),{explanation:e.possibilités.map(e=>parse(e,t)),context:t.dottedName,nodeKind:"une possibilit\xe9"})),condition:parseCondition,barème:function(e,t){let n={assiette:parse(e.assiette,t),multiplicateur:e.multiplicateur?parse(e.multiplicateur,t):defaultNode(1),tranches:parseTranches(e.tranches,t)};return{explanation:n,nodeKind:"bar\xe8me"}},durée:(e,t)=>{let n=parseObject(k,e,t);return{explanation:n,unit:parseUnit("jour"),nodeKind:"dur\xe9e"}},grille:function(e,t){let n={assiette:parse(e.assiette,t),multiplicateur:e.multiplicateur?parse(e.multiplicateur,t):defaultNode(1),tranches:parseTranches(e.tranches,t)};return{explanation:n,nodeKind:"grille"}},multiplication:z,produit:z,recalcul:(e,t)=>{let n=Object.keys(e.avec).map(n=>[parse(n,t),parse(e.avec[n],t)]),a=parse(e.règle??t.dottedName,t);return{explanation:{recalculNode:a,amendedSituation:n},nodeKind:"recalcul"}},somme:J,[parseTexte.nom]:parseTexte,valeur:parse,variable:function(e,t){if(!t.dottedName)throw new m({message:"Une r\xe9f\xe9rence ne peut pas exister en dehors d'une r\xe8gle (`context.dottedName` est vide)",context:t});return{nodeKind:"reference",name:e,contextDottedName:t.dottedName}},variations:function(e,t){let n=e.map(({si:e,alors:n,sinon:a})=>void 0!==a?{consequence:parse(a,t),condition:defaultNode(!0)}:{consequence:parse(n,t),condition:parse(e,t)});return{explanation:n,nodeKind:"variations"}},constant:e=>({type:e.type,fullPrecision:!0,isNullable:null==e.nodeValue,missingVariables:{},nodeValue:e.nodeValue,nodeKind:"constant"})}),en=Object.keys(et);function createContext(e){return __spreadValues({dottedName:"",logger:console,getUnitKey:e=>e,parsedRules:{},referencesMaps:{referencesIn:new Map,rulesThatUse:new Map},nodesTypes:new WeakMap,rulesReplacements:{}},e)}function copyContext(e){return __spreadProps(__spreadValues({},e),{parsedRules:__spreadValues({},e.parsedRules),referencesMaps:{referencesIn:new Map(e.referencesMaps.referencesIn),rulesThatUse:new Map(e.referencesMaps.rulesThatUse)}})}function parsePublicodes(e,t=createContext({})){let n;if("string"==typeof e)throw new c("EngineError","Publicodes does not parse yaml rule sets itself anymore. Please provide a parsed js object. E.g. the `eemeli/yaml` package.",{});let a=__spreadValues({},e),r=createContext(t),s=r.parsedRules;r.parsedRules={},Object.entries(a).forEach(([e,t])=>{if(("string"==typeof t||"number"==typeof t)&&(t={valeur:`${t}`}),"object"!=typeof t)throw new c("SyntaxError",`Rule ${e} is incorrectly written. Please give it a proper value.`,{dottedName:e});parse(__spreadValues({nom:e},t),r)});let i=Object.assign(s,r.parsedRules),[o,l]=function(e,t,n){var a;let r=makeASTTransformer(t=>disambiguateReferenceNode(t,e)),s=makeASTTransformer(t=>{let a=disambiguateReferenceNode(t,e);return a&&updateReferencesMapsFromReferenceNode(a,n),a}),i=(a=e=>"replacementRule"===e.nodeKind?r(e):s(e),Object.fromEntries(Object.entries(t).map(([e,t])=>[e,a(t)])));return[i,n]}(i,r.parsedRules,r.referencesMaps);[i,n]=function({newRules:e,previousReplacements:t,parsedRules:n,referencesMaps:a,logger:r}){let s=Object.values(e).flatMap(e=>e.replacements).reduce((e,t)=>{if(!t.replacedReference.dottedName)throw new m(t);let n=t.replacedReference.dottedName;return __spreadProps(__spreadValues({},e),{[n]:[...e[n]??[],t]})},{}),i=Object.keys(s).reduce((e,t)=>((a.rulesThatUse.get(t)??[]).forEach(t=>e.add(t)),e),new Set([])),o=new Set(Object.keys(e).filter(e=>[...a.referencesIn.get(e)??new Set].some(e=>(t[e]??[]).length))),l=Object.entries(s).reduce((e,[t,n])=>__spreadProps(__spreadValues({},e),{[t]:[...e[t]??[],...n]}),t);if(!o.size&&!i.size)return[n,l];let u=makeReplacementInliner(t,a,r),d=makeReplacementInliner(s,a,r);return o.forEach(e=>{n[e]=u(n[e])}),i.forEach(e=>{n[e]=d(n[e])}),[n,l]}({parsedRules:i,newRules:o,referencesMaps:l,previousReplacements:r.rulesReplacements,logger:r.logger});let u=function(e,t,n){function inferNodeUnitAndCache(e){if(!e||"object"!=typeof e)return v;if(n.has(e))return n.get(e);n.set(e,v);let a=function(e){switch(e.nodeKind){case"bar\xe8me":case"dur\xe9e":case"grille":case"taux progressif":case"inversion":case"recalcul":case"replacementRule":case"r\xe9soudre r\xe9f\xe9rence circulaire":return{isNullable:!1,type:"number"};case"est non d\xe9fini":case"est non applicable":return{isNullable:!1,type:"boolean"};case"constant":return{isNullable:e.isNullable??null===e.nodeValue,type:e.type};case"operation":return{isNullable:["<","<=",">",">=","/","*"].includes(e.operationKind)?inferNodeUnitAndCache(e.explanation[0]).isNullable||inferNodeUnitAndCache(e.explanation[1]).isNullable:"-"===e.operationKind&&inferNodeUnitAndCache(e.explanation[0]).isNullable,type:["<","<=",">",">=","=","!=","et","ou"].includes(e.operationKind)?"boolean":"number"};case"texte":case"une possibilit\xe9":return{isNullable:!1,type:"string"};case"rule":case"arrondi":return inferNodeUnitAndCache(e.explanation.valeur);case"unit\xe9":case"simplifier unit\xe9":case"variable manquante":return inferNodeUnitAndCache(e.explanation);case"condition":return{isNullable:[e.explanation.si,e.explanation.alors,e.explanation.sinon].some(e=>inferNodeUnitAndCache(e).isNullable),type:inferNodeUnitAndCache(e.explanation.alors).type??inferNodeUnitAndCache(e.explanation.sinon).type};case"variations":let n=e.explanation.map(({consequence:e})=>inferNodeUnitAndCache(e));return{isNullable:n.some(e=>e.isNullable),type:n.map(e=>e.type).find(e=>void 0!==e)};case"reference":return inferNodeUnitAndCache(t[e.dottedName])}}(e);return n.set(e,a),a}return e.forEach(e=>{let n=t[e];inferNodeUnitAndCache(n),n.explanation.parents.forEach(inferNodeUnitAndCache)}),n}(Object.keys(o),i,r.nodesTypes);return{parsedRules:i,nodesTypes:u,referencesMaps:l,rulesReplacements:n}}var emptyCache=()=>({_meta:{evaluationRuleStack:[],parentRuleStack:[],traversedVariablesStack:[]},nodes:new Map}),ea=class{baseContext;context;publicParsedRules;cache=emptyCache();subEngines=[];subEngineId;constructor(e={},t={}){let n=__spreadValues({dottedName:""},t);this.baseContext=createContext(__spreadValues(__spreadValues({},n),parsePublicodes(e,n))),this.context=this.baseContext,this.publicParsedRules=Object.fromEntries(Object.entries(this.baseContext.parsedRules).filter(([e,t])=>!t.private&&isAccessible(this.baseContext.parsedRules,"",e)))}resetCache(){this.cache=emptyCache()}setSituation(e={},t={}){this.resetCache();let n=t.keepPreviousSituation??!1;Object.keys(e).forEach(e=>{if(!(e in this.baseContext.parsedRules))throw new c("EvaluationError",`Erreur lors de la mise \xe0 jour de la situation : ${e} n'existe pas dans la base de r\xe8gle.`,{dottedName:e});if(this.baseContext.parsedRules[e].private)throw new c("EvaluationError",`Erreur lors de la mise \xe0 jour de la situation : ${e} est une r\xe8gle priv\xe9e (il n'est pas possible de modifier une r\xe8gle priv\xe9e).`,{dottedName:e})});let a=Object.fromEntries(Object.entries(e).map(([e,t])=>[`[priv\xe9] ${e} . $SITUATION`,t&&"object"==typeof t&&"nodeKind"in t?{valeur:t}:t])),r=copyContext(this.baseContext);try{this.context=__spreadValues(__spreadValues({},this.baseContext),parsePublicodes(a,n?this.context:this.baseContext))}catch(e){throw this.baseContext=r,e}return this.baseContext=r,Object.keys(e).forEach(e=>{isExperimental(this.context.parsedRules,e)&&experimentalRuleWarning(this.baseContext.logger,e),this.checkExperimentalRule(this.context.parsedRules[`${e} . $SITUATION`])}),this}inversionFail(){return!!this.cache._meta.inversionFail}getRule(e){if(!(e in this.baseContext.parsedRules))throw new c("UnknownRule",`La r\xe8gle '${e}' n'existe pas`,{dottedName:e});if(!(e in this.publicParsedRules))throw new c("PrivateRule",`La r\xe8gle ${e} est une r\xe8gle priv\xe9e.`,{dottedName:e});return this.publicParsedRules[e]}getParsedRules(){return this.publicParsedRules}evaluate(e){let t=this.cache.nodes.get(e);if(t)return t;this.context=__spreadValues(__spreadValues({},this.context),parsePublicodes({"[priv\xe9] $EVALUATION":e&&"object"==typeof e&&"nodeKind"in e?{valeur:e}:e},this.context)),this.checkExperimentalRule(this.context.parsedRules.$EVALUATION),this.cache._meta=emptyCache()._meta;let n=this.evaluateNode(this.context.parsedRules.$EVALUATION.explanation.valeur);return this.cache.nodes.set(e,n),n}evaluateNode(e){var t;let n=this.cache.nodes.get(e);if(void 0!==n)return null==(t=n.traversedVariables)||t.forEach(e=>{var t;return null==(t=this.cache._meta.traversedVariablesStack[0])?void 0:t.add(e)}),n;if(!h[e.nodeKind])throw new c("EvaluationError",`Unknown "nodeKind": ${e.nodeKind}`,{dottedName:""});let a=0===this.cache._meta.traversedVariablesStack.length||"rule"===e.nodeKind;a&&this.cache._meta.traversedVariablesStack.unshift(new Set),"reference"===e.nodeKind&&e.dottedName&&e.dottedName in this.publicParsedRules&&this.cache._meta.traversedVariablesStack[0].add(e.dottedName);let r=h[e.nodeKind].call(this,e);return a&&(r.traversedVariables=Array.from(this.cache._meta.traversedVariablesStack.shift()??[]),this.cache._meta.traversedVariablesStack.length>0&&r.traversedVariables.forEach(e=>{this.cache._meta.traversedVariablesStack[0].add(e)})),this.cache.nodes.set(e,r),r}shallowCopy(){let e=new ea;return e.baseContext=copyContext(this.baseContext),e.context=copyContext(this.context),e.publicParsedRules=this.publicParsedRules,e.cache=__spreadProps(__spreadValues({},emptyCache()),{nodes:new Map(this.cache.nodes)}),e}checkExperimentalRule=makeASTVisitor(e=>("reference"===e.nodeKind&&isExperimental(this.context.parsedRules,e.dottedName)&&experimentalRuleWarning(this.baseContext.logger,e.dottedName),"continue"))}}}]);